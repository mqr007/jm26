{"version":3,"sources":["../src/lib/environment.ts","../src/lib/configs/service-config.ts","../src/lib/util.ts","../src/lib/http-status-codes.ts","../src/lib/configs/system-config.ts","../src/lib/config.ts","../src/lib/logger.ts","../src/lib/initialize.ts","../src/lib/server.ts","../src/lib/request/Request.ts","../src/lib/exceptions/Exception.ts","../src/lib/exceptions/APIException.ts","../src/api/consts/exceptions.ts","../src/lib/response/Response.ts","../src/lib/response/Body.ts","../src/lib/response/FailureBody.ts","../src/lib/consts/exceptions.ts","../src/api/routes/images.ts","../src/api/controllers/images.ts","../src/api/controllers/core.ts","../src/lib/error-handler.ts","../src/api/consts/dreamina.ts","../src/api/consts/common.ts","../src/api/controllers/get_historyId.ts","../src/lib/aws-signature.ts","../src/api/routes/chat.ts","../src/api/controllers/chat.ts","../src/api/controllers/videos.ts","../src/lib/smart-poller.ts","../src/lib/image-uploader.ts","../src/lib/region-utils.ts","../src/lib/image-utils.ts","../src/api/routes/ping.ts","../src/api/routes/token.ts","../src/api/routes/models.ts","../src/api/routes/videos.ts","../src/api/routes/index.ts","../src/index.ts"],"sourcesContent":["import path from 'path';\n\nimport fs from 'fs-extra';\nimport minimist from 'minimist';\nimport _ from 'lodash';\n\nconst cmdArgs = minimist(process.argv.slice(2));  //获取命令行参数\nconst envVars = process.env;  //获取环境变量\n\nclass Environment {\n\n    /** 命令行参数 */\n    cmdArgs: any;\n    /** 环境变量 */\n    envVars: any;\n    /** 环境名称 */\n    env?: string;\n    /** 服务名称 */\n    name?: string;\n    /** 服务地址 */\n    host?: string;\n    /** 服务端口 */\n    port?: number;\n    /** 包参数 */\n    package: any;\n\n    constructor(options: any = {}) {\n        const { cmdArgs, envVars, package: _package } = options;\n        this.cmdArgs = cmdArgs;\n        this.envVars = envVars;\n        this.env = _.defaultTo(cmdArgs.env || envVars.SERVER_ENV, 'dev');\n        this.name = cmdArgs.name || envVars.SERVER_NAME || undefined;\n        this.host = cmdArgs.host || envVars.SERVER_HOST || undefined;\n        this.port = Number(cmdArgs.port || envVars.SERVER_PORT) ? Number(cmdArgs.port || envVars.SERVER_PORT) : undefined;\n        this.package = _package;\n    }\n\n}\n\nexport default new Environment({\n    cmdArgs,\n    envVars,\n    package: JSON.parse(fs.readFileSync(path.join(path.resolve(), \"package.json\")).toString())\n});","import path from 'path';\n\nimport fs from 'fs-extra';\nimport yaml from 'yaml';\nimport _ from 'lodash';\n\nimport environment from '../environment.ts';\nimport util from '../util.ts';\n\nconst CONFIG_PATH = path.join(path.resolve(), 'configs/', environment.env, \"/service.yml\");\n\n/**\n * 服务配置\n */\nexport class ServiceConfig {\n\n    /** 服务名称 */\n    name: string;\n    /** @type {string} 服务绑定主机地址 */\n    host;\n    /** @type {number} 服务绑定端口 */\n    port;\n    /** @type {string} 服务路由前缀 */\n    urlPrefix;\n    /** @type {string} 服务绑定地址（外部访问地址） */\n    bindAddress;\n\n    constructor(options?: any) {\n        const { name, host, port, urlPrefix, bindAddress } = options || {};\n        this.name = _.defaultTo(name, 'jimeng-api');\n        this.host = _.defaultTo(host, '0.0.0.0');\n        this.port = _.defaultTo(port, 5566);\n        this.urlPrefix = _.defaultTo(urlPrefix, '');\n        this.bindAddress = bindAddress;\n    }\n\n    get addressHost() {\n        if(this.bindAddress) return this.bindAddress;\n        const ipAddresses = util.getIPAddressesByIPv4();\n        for(let ipAddress of ipAddresses) {\n            if(ipAddress === this.host)\n                return ipAddress;\n        }\n        return ipAddresses[0] || \"127.0.0.1\";\n    }\n\n    get address() {\n        return `${this.addressHost}:${this.port}`;\n    }\n\n    get pageDirUrl() {\n        return `http://127.0.0.1:${this.port}/page`;\n    }\n\n    static load() {\n        const external = _.pickBy(environment, (v, k) => [\"name\", \"host\", \"port\"].includes(k) && !_.isUndefined(v));\n        if(!fs.pathExistsSync(CONFIG_PATH)) return new ServiceConfig(external);\n        const data = yaml.parse(fs.readFileSync(CONFIG_PATH).toString());\n        return new ServiceConfig({ ...data, ...external });\n    }\n\n}\n\nexport default ServiceConfig.load();","import os from \"os\";\nimport path from \"path\";\nimport crypto from \"crypto\";\nimport { Readable, Writable } from \"stream\";\n\nimport \"colors\";\nimport mime from \"mime\";\nimport axios from \"axios\";\nimport fs from \"fs-extra\";\nimport { v1 as uuid } from \"uuid\";\nimport { format as dateFormat } from \"date-fns\";\nimport CRC32 from \"crc-32\";\nimport randomstring from \"randomstring\";\nimport _ from \"lodash\";\nimport { CronJob } from \"cron\";\n\nimport HTTP_STATUS_CODE from \"./http-status-codes.ts\";\n\nconst autoIdMap = new Map();\n\nconst util = {\n  is2DArrays(value: any) {\n    return (\n      _.isArray(value) &&\n      (!value[0] || (_.isArray(value[0]) && _.isArray(value[value.length - 1])))\n    );\n  },\n\n  uuid: (separator = true) => (separator ? uuid() : uuid().replace(/\\-/g, \"\")),\n\n  autoId: (prefix = \"\") => {\n    let index = autoIdMap.get(prefix);\n    if (index > 999999) index = 0; //超过最大数字则重置为0\n    autoIdMap.set(prefix, (index || 0) + 1);\n    return `${prefix}${index || 1}`;\n  },\n\n  ignoreJSONParse(value: string) {\n    const result = _.attempt(() => JSON.parse(value));\n    if (_.isError(result)) return null;\n    return result;\n  },\n\n  generateRandomString(options: any): string {\n    return randomstring.generate(options);\n  },\n\n  getResponseContentType(value: any): string | null {\n    return value.headers\n      ? value.headers[\"content-type\"] || value.headers[\"Content-Type\"]\n      : null;\n  },\n\n  mimeToExtension(value: string) {\n    let extension = mime.getExtension(value);\n    if (extension == \"mpga\") return \"mp3\";\n    return extension;\n  },\n\n  extractURLExtension(value: string) {\n    const extname = path.extname(new URL(value).pathname);\n    return extname.substring(1).toLowerCase();\n  },\n\n  createCronJob(cronPatterns: any, callback?: Function) {\n    if (!_.isFunction(callback))\n      throw new Error(\"callback must be an Function\");\n    return new CronJob(\n      cronPatterns,\n      () => callback(),\n      null,\n      false,\n      \"Asia/Shanghai\"\n    );\n  },\n\n  getDateString(format = \"yyyy-MM-dd\", date = new Date()) {\n    return dateFormat(date, format);\n  },\n\n  getIPAddressesByIPv4(): string[] {\n    const interfaces = os.networkInterfaces();\n    const addresses = [];\n    for (let name in interfaces) {\n      const networks = interfaces[name];\n      const results = networks.filter(\n        (network) =>\n          network.family === \"IPv4\" &&\n          network.address !== \"127.0.0.1\" &&\n          !network.internal\n      );\n      if (results[0] && results[0].address) addresses.push(results[0].address);\n    }\n    return addresses;\n  },\n\n  getMACAddressesByIPv4(): string[] {\n    const interfaces = os.networkInterfaces();\n    const addresses = [];\n    for (let name in interfaces) {\n      const networks = interfaces[name];\n      const results = networks.filter(\n        (network) =>\n          network.family === \"IPv4\" &&\n          network.address !== \"127.0.0.1\" &&\n          !network.internal\n      );\n      if (results[0] && results[0].mac) addresses.push(results[0].mac);\n    }\n    return addresses;\n  },\n\n  generateSSEData(event?: string, data?: string, retry?: number) {\n    return `event: ${event || \"message\"}\\ndata: ${(data || \"\")\n      .replace(/\\n/g, \"\\\\n\")\n      .replace(/\\s/g, \"\\\\s\")}\\nretry: ${retry || 3000}\\n\\n`;\n  },\n\n  buildDataBASE64(type, ext, buffer) {\n    return `data:${type}/${ext.replace(\"jpg\", \"jpeg\")};base64,${buffer.toString(\n      \"base64\"\n    )}`;\n  },\n\n  isLinux() {\n    return os.platform() !== \"win32\";\n  },\n\n  isIPAddress(value) {\n    return (\n      _.isString(value) &&\n      (/^((2[0-4]\\d|25[0-5]|[01]?\\d\\d?)\\.){3}(2[0-4]\\d|25[0-5]|[01]?\\d\\d?)$/.test(\n        value\n      ) ||\n        /\\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:)))(%.+)?\\s*/.test(\n          value\n        ))\n    );\n  },\n\n  isPort(value) {\n    return _.isNumber(value) && value > 0 && value < 65536;\n  },\n\n  isReadStream(value): boolean {\n    return (\n      value &&\n      (value instanceof Readable || \"readable\" in value || value.readable)\n    );\n  },\n\n  isWriteStream(value): boolean {\n    return (\n      value &&\n      (value instanceof Writable || \"writable\" in value || value.writable)\n    );\n  },\n\n  isHttpStatusCode(value) {\n    return _.isNumber(value) && Object.values(HTTP_STATUS_CODE).includes(value);\n  },\n\n  isURL(value) {\n    return !_.isUndefined(value) && /^(http|https)/.test(value);\n  },\n\n  isSrc(value) {\n    return !_.isUndefined(value) && /^\\/.+\\.[0-9a-zA-Z]+(\\?.+)?$/.test(value);\n  },\n\n  isBASE64(value) {\n    return !_.isUndefined(value) && /^[a-zA-Z0-9\\/\\+]+(=?)+$/.test(value);\n  },\n\n  isBASE64Data(value) {\n    return /^data:/.test(value);\n  },\n\n  extractBASE64DataFormat(value): string | null {\n    const match = value.trim().match(/^data:(.+);base64,/);\n    if (!match) return null;\n    return match[1];\n  },\n\n  removeBASE64DataHeader(value): string {\n    return value.replace(/^data:(.+);base64,/, \"\");\n  },\n\n  isDataString(value): boolean {\n    return /^(base64|json):/.test(value);\n  },\n\n  isStringNumber(value) {\n    return _.isFinite(Number(value));\n  },\n\n  isUnixTimestamp(value) {\n    return /^[0-9]{10}$/.test(`${value}`);\n  },\n\n  isTimestamp(value) {\n    return /^[0-9]{13}$/.test(`${value}`);\n  },\n\n  isEmail(value) {\n    return /^([a-zA-Z0-9]+[_|\\_|\\.]?)*[a-zA-Z0-9]+@([a-zA-Z0-9]+[_|\\_|\\.]?)*[a-zA-Z0-9]+\\.[a-zA-Z]{2,3}$/.test(\n      value\n    );\n  },\n\n  isAsyncFunction(value) {\n    return Object.prototype.toString.call(value) === \"[object AsyncFunction]\";\n  },\n\n  async isAPNG(filePath) {\n    let head;\n    const readStream = fs.createReadStream(filePath, { start: 37, end: 40 });\n    const readPromise = new Promise((resolve, reject) => {\n      readStream.once(\"end\", resolve);\n      readStream.once(\"error\", reject);\n    });\n    readStream.once(\"data\", (data) => (head = data));\n    await readPromise;\n    return head.compare(Buffer.from([0x61, 0x63, 0x54, 0x4c])) === 0;\n  },\n\n  unixTimestamp() {\n    return parseInt(`${Date.now() / 1000}`);\n  },\n\n  timestamp() {\n    return Date.now();\n  },\n\n  urlJoin(...values) {\n    let url = \"\";\n    for (let i = 0; i < values.length; i++)\n      url += `${i > 0 ? \"/\" : \"\"}${values[i]\n        .replace(/^\\/*/, \"\")\n        .replace(/\\/*$/, \"\")}`;\n    return url;\n  },\n\n  millisecondsToHmss(milliseconds) {\n    if (_.isString(milliseconds)) return milliseconds;\n    milliseconds = parseInt(milliseconds);\n    const sec = Math.floor(milliseconds / 1000);\n    const hours = Math.floor(sec / 3600);\n    const minutes = Math.floor((sec - hours * 3600) / 60);\n    const seconds = sec - hours * 3600 - minutes * 60;\n    const ms = (milliseconds % 60000) - seconds * 1000;\n    return `${hours > 9 ? hours : \"0\" + hours}:${\n      minutes > 9 ? minutes : \"0\" + minutes\n    }:${seconds > 9 ? seconds : \"0\" + seconds}.${ms}`;\n  },\n\n  millisecondsToTimeString(milliseconds) {\n    if (milliseconds < 1000) return `${milliseconds}ms`;\n    if (milliseconds < 60000)\n      return `${parseFloat((milliseconds / 1000).toFixed(2))}s`;\n    return `${Math.floor(milliseconds / 1000 / 60)}m${Math.floor(\n      (milliseconds / 1000) % 60\n    )}s`;\n  },\n\n  rgbToHex(r, g, b): string {\n    return ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);\n  },\n\n  hexToRgb(hex) {\n    const value = parseInt(hex.replace(/^#/, \"\"), 16);\n    return [(value >> 16) & 255, (value >> 8) & 255, value & 255];\n  },\n\n  md5(value) {\n    return crypto.createHash(\"md5\").update(value).digest(\"hex\");\n  },\n\n  crc32(value) {\n    return _.isBuffer(value) ? CRC32.buf(value) : CRC32.str(value);\n  },\n\n  arrayParse(value): any[] {\n    return _.isArray(value) ? value : [value];\n  },\n\n  booleanParse(value) {\n    return value === \"true\" || value === true ? true : false;\n  },\n\n  encodeBASE64(value) {\n    return Buffer.from(value).toString(\"base64\");\n  },\n\n  decodeBASE64(value) {\n    return Buffer.from(value, \"base64\").toString();\n  },\n\n  async fetchFileBASE64(url: string) {\n    const result = await axios.get(url, {\n      responseType: \"arraybuffer\",\n    });\n    return result.data.toString(\"base64\");\n  },\n\n  /**\n   * 计算 ArrayBuffer 的 CRC32 值\n   * @param buffer ArrayBuffer 数据\n   * @returns CRC32 十六进制字符串\n   */\n  calculateCRC32(buffer: ArrayBuffer): string {\n    const crcTable = [];\n    for (let i = 0; i < 256; i++) {\n      let crc = i;\n      for (let j = 0; j < 8; j++) {\n        crc = (crc & 1) ? (0xEDB88320 ^ (crc >>> 1)) : (crc >>> 1);\n      }\n      crcTable[i] = crc;\n    }\n\n    let crc = 0 ^ (-1);\n    const bytes = new Uint8Array(buffer);\n    for (let i = 0; i < bytes.length; i++) {\n      crc = (crc >>> 8) ^ crcTable[(crc ^ bytes[i]) & 0xFF];\n    }\n    return ((crc ^ (-1)) >>> 0).toString(16).padStart(8, '0');\n  },\n};\n\nexport default util;\n","export default {\n\n    CONTINUE: 100,  //客户端应当继续发送请求。这个临时响应是用来通知客户端它的部分请求已经被服务器接收，且仍未被拒绝。客户端应当继续发送请求的剩余部分，或者如果请求已经完成，忽略这个响应。服务器必须在请求完成后向客户端发送一个最终响应\n    SWITCHING_PROTOCOLS: 101,  //服务器已经理解了客户端的请求，并将通过Upgrade 消息头通知客户端采用不同的协议来完成这个请求。在发送完这个响应最后的空行后，服务器将会切换到在Upgrade 消息头中定义的那些协议。只有在切换新的协议更有好处的时候才应该采取类似措施。例如，切换到新的HTTP 版本比旧版本更有优势，或者切换到一个实时且同步的协议以传送利用此类特性的资源\n    PROCESSING: 102,  //处理将被继续执行\n\n    OK: 200,  //请求已成功，请求所希望的响应头或数据体将随此响应返回\n    CREATED: 201,  //请求已经被实现，而且有一个新的资源已经依据请求的需要而建立，且其 URI 已经随Location 头信息返回。假如需要的资源无法及时建立的话，应当返回 '202 Accepted'\n    ACCEPTED: 202,  //服务器已接受请求，但尚未处理。正如它可能被拒绝一样，最终该请求可能会也可能不会被执行。在异步操作的场合下，没有比发送这个状态码更方便的做法了。返回202状态码的响应的目的是允许服务器接受其他过程的请求（例如某个每天只执行一次的基于批处理的操作），而不必让客户端一直保持与服务器的连接直到批处理操作全部完成。在接受请求处理并返回202状态码的响应应当在返回的实体中包含一些指示处理当前状态的信息，以及指向处理状态监视器或状态预测的指针，以便用户能够估计操作是否已经完成\n    NON_AUTHORITATIVE_INFO: 203,  //服务器已成功处理了请求，但返回的实体头部元信息不是在原始服务器上有效的确定集合，而是来自本地或者第三方的拷贝。当前的信息可能是原始版本的子集或者超集。例如，包含资源的元数据可能导致原始服务器知道元信息的超级。使用此状态码不是必须的，而且只有在响应不使用此状态码便会返回200 OK的情况下才是合适的\n    NO_CONTENT: 204,  //服务器成功处理了请求，但不需要返回任何实体内容，并且希望返回更新了的元信息。响应可能通过实体头部的形式，返回新的或更新后的元信息。如果存在这些头部信息，则应当与所请求的变量相呼应。如果客户端是浏览器的话，那么用户浏览器应保留发送了该请求的页面，而不产生任何文档视图上的变化，即使按照规范新的或更新后的元信息应当被应用到用户浏览器活动视图中的文档。由于204响应被禁止包含任何消息体，因此它始终以消息头后的第一个空行结尾\n    RESET_CONTENT: 205,  //服务器成功处理了请求，且没有返回任何内容。但是与204响应不同，返回此状态码的响应要求请求者重置文档视图。该响应主要是被用于接受用户输入后，立即重置表单，以便用户能够轻松地开始另一次输入。与204响应一样，该响应也被禁止包含任何消息体，且以消息头后的第一个空行结束\n    PARTIAL_CONTENT: 206,  //服务器已经成功处理了部分 GET 请求。类似于FlashGet或者迅雷这类的HTTP下载工具都是使用此类响应实现断点续传或者将一个大文档分解为多个下载段同时下载。该请求必须包含 Range 头信息来指示客户端希望得到的内容范围，并且可能包含 If-Range 来作为请求条件。响应必须包含如下的头部域：Content-Range 用以指示本次响应中返回的内容的范围；如果是Content-Type为multipart/byteranges的多段下载，则每一段multipart中都应包含Content-Range域用以指示本段的内容范围。假如响应中包含Content-Length，那么它的数值必须匹配它返回的内容范围的真实字节数。Date和ETag或Content-Location，假如同样的请求本应该返回200响应。Expires, Cache-Control，和/或 Vary，假如其值可能与之前相同变量的其他响应对应的值不同的话。假如本响应请求使用了 If-Range 强缓存验证，那么本次响应不应该包含其他实体头；假如本响应的请求使用了 If-Range 弱缓存验证，那么本次响应禁止包含其他实体头；这避免了缓存的实体内容和更新了的实体头信息之间的不一致。否则，本响应就应当包含所有本应该返回200响应中应当返回的所有实体头部域。假如 ETag 或 Latest-Modified 头部不能精确匹配的话，则客户端缓存应禁止将206响应返回的内容与之前任何缓存过的内容组合在一起。任何不支持 Range 以及 Content-Range 头的缓存都禁止缓存206响应返回的内容\n    MULTIPLE_STATUS: 207,  //代表之后的消息体将是一个XML消息，并且可能依照之前子请求数量的不同，包含一系列独立的响应代码\n\n    MULTIPLE_CHOICES: 300,  //被请求的资源有一系列可供选择的回馈信息，每个都有自己特定的地址和浏览器驱动的商议信息。用户或浏览器能够自行选择一个首选的地址进行重定向。除非这是一个HEAD请求，否则该响应应当包括一个资源特性及地址的列表的实体，以便用户或浏览器从中选择最合适的重定向地址。这个实体的格式由Content-Type定义的格式所决定。浏览器可能根据响应的格式以及浏览器自身能力，自动作出最合适的选择。当然，RFC 2616规范并没有规定这样的自动选择该如何进行。如果服务器本身已经有了首选的回馈选择，那么在Location中应当指明这个回馈的 URI；浏览器可能会将这个 Location 值作为自动重定向的地址。此外，除非额外指定，否则这个响应也是可缓存的\n    MOVED_PERMANENTLY: 301,  //被请求的资源已永久移动到新位置，并且将来任何对此资源的引用都应该使用本响应返回的若干个URI之一。如果可能，拥有链接编辑功能的客户端应当自动把请求的地址修改为从服务器反馈回来的地址。除非额外指定，否则这个响应也是可缓存的。新的永久性的URI应当在响应的Location域中返回。除非这是一个HEAD请求，否则响应的实体中应当包含指向新的URI的超链接及简短说明。如果这不是一个GET或者HEAD请求，因此浏览器禁止自动进行重定向，除非得到用户的确认，因为请求的条件可能因此发生变化。注意：对于某些使用 HTTP/1.0 协议的浏览器，当它们发送的POST请求得到了一个301响应的话，接下来的重定向请求将会变成GET方式\n    FOUND: 302,  //请求的资源现在临时从不同的URI响应请求。由于这样的重定向是临时的，客户端应当继续向原有地址发送以后的请求。只有在Cache-Control或Expires中进行了指定的情况下，这个响应才是可缓存的。新的临时性的URI应当在响应的 Location 域中返回。除非这是一个HEAD请求，否则响应的实体中应当包含指向新的URI的超链接及简短说明。如果这不是一个GET或者HEAD请求，那么浏览器禁止自动进行重定向，除非得到用户的确认，因为请求的条件可能因此发生变化。注意：虽然RFC 1945和RFC 2068规范不允许客户端在重定向时改变请求的方法，但是很多现存的浏览器将302响应视作为303响应，并且使用GET方式访问在Location中规定的URI，而无视原先请求的方法。状态码303和307被添加了进来，用以明确服务器期待客户端进行何种反应\n    SEE_OTHER: 303,  //对应当前请求的响应可以在另一个URI上被找到，而且客户端应当采用 GET 的方式访问那个资源。这个方法的存在主要是为了允许由脚本激活的POST请求输出重定向到一个新的资源。这个新的 URI 不是原始资源的替代引用。同时，303响应禁止被缓存。当然，第二个请求（重定向）可能被缓存。新的 URI 应当在响应的Location域中返回。除非这是一个HEAD请求，否则响应的实体中应当包含指向新的URI的超链接及简短说明。注意：许多 HTTP/1.1 版以前的浏览器不能正确理解303状态。如果需要考虑与这些浏览器之间的互动，302状态码应该可以胜任，因为大多数的浏览器处理302响应时的方式恰恰就是上述规范要求客户端处理303响应时应当做的\n    NOT_MODIFIED: 304,  //如果客户端发送了一个带条件的GET请求且该请求已被允许，而文档的内容（自上次访问以来或者根据请求的条件）并没有改变，则服务器应当返回这个状态码。304响应禁止包含消息体，因此始终以消息头后的第一个空行结尾。该响应必须包含以下的头信息：Date，除非这个服务器没有时钟。假如没有时钟的服务器也遵守这些规则，那么代理服务器以及客户端可以自行将Date字段添加到接收到的响应头中去（正如RFC 2068中规定的一样），缓存机制将会正常工作。ETag或 Content-Location，假如同样的请求本应返回200响应。Expires, Cache-Control，和/或Vary，假如其值可能与之前相同变量的其他响应对应的值不同的话。假如本响应请求使用了强缓存验证，那么本次响应不应该包含其他实体头；否则（例如，某个带条件的 GET 请求使用了弱缓存验证），本次响应禁止包含其他实体头；这避免了缓存了的实体内容和更新了的实体头信息之间的不一致。假如某个304响应指明了当前某个实体没有缓存，那么缓存系统必须忽视这个响应，并且重复发送不包含限制条件的请求。假如接收到一个要求更新某个缓存条目的304响应，那么缓存系统必须更新整个条目以反映所有在响应中被更新的字段的值\n    USE_PROXY: 305,  //被请求的资源必须通过指定的代理才能被访问。Location域中将给出指定的代理所在的URI信息，接收者需要重复发送一个单独的请求，通过这个代理才能访问相应资源。只有原始服务器才能建立305响应。注意：RFC 2068中没有明确305响应是为了重定向一个单独的请求，而且只能被原始服务器建立。忽视这些限制可能导致严重的安全后果\n    UNUSED: 306,  //在最新版的规范中，306状态码已经不再被使用\n    TEMPORARY_REDIRECT: 307,  //请求的资源现在临时从不同的URI 响应请求。由于这样的重定向是临时的，客户端应当继续向原有地址发送以后的请求。只有在Cache-Control或Expires中进行了指定的情况下，这个响应才是可缓存的。新的临时性的URI 应当在响应的Location域中返回。除非这是一个HEAD请求，否则响应的实体中应当包含指向新的URI 的超链接及简短说明。因为部分浏览器不能识别307响应，因此需要添加上述必要信息以便用户能够理解并向新的 URI 发出访问请求。如果这不是一个GET或者HEAD请求，那么浏览器禁止自动进行重定向，除非得到用户的确认，因为请求的条件可能因此发生变化\n\n    BAD_REQUEST: 400,  //1.语义有误，当前请求无法被服务器理解。除非进行修改，否则客户端不应该重复提交这个请求 2.请求参数有误\n    UNAUTHORIZED: 401,  //当前请求需要用户验证。该响应必须包含一个适用于被请求资源的 WWW-Authenticate 信息头用以询问用户信息。客户端可以重复提交一个包含恰当的 Authorization 头信息的请求。如果当前请求已经包含了 Authorization 证书，那么401响应代表着服务器验证已经拒绝了那些证书。如果401响应包含了与前一个响应相同的身份验证询问，且浏览器已经至少尝试了一次验证，那么浏览器应当向用户展示响应中包含的实体信息，因为这个实体信息中可能包含了相关诊断信息。参见RFC 2617\n    PAYMENT_REQUIRED: 402,  //该状态码是为了将来可能的需求而预留的\n    FORBIDDEN: 403,  //服务器已经理解请求，但是拒绝执行它。与401响应不同的是，身份验证并不能提供任何帮助，而且这个请求也不应该被重复提交。如果这不是一个HEAD请求，而且服务器希望能够讲清楚为何请求不能被执行，那么就应该在实体内描述拒绝的原因。当然服务器也可以返回一个404响应，假如它不希望让客户端获得任何信息\n    NOT_FOUND: 404,  //请求失败，请求所希望得到的资源未被在服务器上发现。没有信息能够告诉用户这个状况到底是暂时的还是永久的。假如服务器知道情况的话，应当使用410状态码来告知旧资源因为某些内部的配置机制问题，已经永久的不可用，而且没有任何可以跳转的地址。404这个状态码被广泛应用于当服务器不想揭示到底为何请求被拒绝或者没有其他适合的响应可用的情况下\n    METHOD_NOT_ALLOWED: 405,  //请求行中指定的请求方法不能被用于请求相应的资源。该响应必须返回一个Allow 头信息用以表示出当前资源能够接受的请求方法的列表。鉴于PUT，DELETE方法会对服务器上的资源进行写操作，因而绝大部分的网页服务器都不支持或者在默认配置下不允许上述请求方法，对于此类请求均会返回405错误\n    NO_ACCEPTABLE: 406,  //请求的资源的内容特性无法满足请求头中的条件，因而无法生成响应实体。除非这是一个 HEAD 请求，否则该响应就应当返回一个包含可以让用户或者浏览器从中选择最合适的实体特性以及地址列表的实体。实体的格式由Content-Type头中定义的媒体类型决定。浏览器可以根据格式及自身能力自行作出最佳选择。但是，规范中并没有定义任何作出此类自动选择的标准\n    PROXY_AUTHENTICATION_REQUIRED: 407,  //与401响应类似，只不过客户端必须在代理服务器上进行身份验证。代理服务器必须返回一个Proxy-Authenticate用以进行身份询问。客户端可以返回一个Proxy-Authorization信息头用以验证。参见RFC 2617\n    REQUEST_TIMEOUT: 408,  //请求超时。客户端没有在服务器预备等待的时间内完成一个请求的发送。客户端可以随时再次提交这一请求而无需进行任何更改\n    CONFLICT: 409,  //由于和被请求的资源的当前状态之间存在冲突，请求无法完成。这个代码只允许用在这样的情况下才能被使用：用户被认为能够解决冲突，并且会重新提交新的请求。该响应应当包含足够的信息以便用户发现冲突的源头。冲突通常发生于对PUT请求的处理中。例如，在采用版本检查的环境下，某次PUT提交的对特定资源的修改请求所附带的版本信息与之前的某个（第三方）请求向冲突，那么此时服务器就应该返回一个409错误，告知用户请求无法完成。此时，响应实体中很可能会包含两个冲突版本之间的差异比较，以便用户重新提交归并以后的新版本\n    GONE: 410,  //被请求的资源在服务器上已经不再可用，而且没有任何已知的转发地址。这样的状况应当被认为是永久性的。如果可能，拥有链接编辑功能的客户端应当在获得用户许可后删除所有指向这个地址的引用。如果服务器不知道或者无法确定这个状况是否是永久的，那么就应该使用404状态码。除非额外说明，否则这个响应是可缓存的。410响应的目的主要是帮助网站管理员维护网站，通知用户该资源已经不再可用，并且服务器拥有者希望所有指向这个资源的远端连接也被删除。这类事件在限时、增值服务中很普遍。同样，410响应也被用于通知客户端在当前服务器站点上，原本属于某个个人的资源已经不再可用。当然，是否需要把所有永久不可用的资源标记为'410 Gone'，以及是否需要保持此标记多长时间，完全取决于服务器拥有者\n    LENGTH_REQUIRED: 411,  //服务器拒绝在没有定义Content-Length头的情况下接受请求。在添加了表明请求消息体长度的有效Content-Length头之后，客户端可以再次提交该请求 \n    PRECONDITION_FAILED: 412,  //服务器在验证在请求的头字段中给出先决条件时，没能满足其中的一个或多个。这个状态码允许客户端在获取资源时在请求的元信息（请求头字段数据）中设置先决条件，以此避免该请求方法被应用到其希望的内容以外的资源上\n    REQUEST_ENTITY_TOO_LARGE: 413,  //服务器拒绝处理当前请求，因为该请求提交的实体数据大小超过了服务器愿意或者能够处理的范围。此种情况下，服务器可以关闭连接以免客户端继续发送此请求。如果这个状况是临时的，服务器应当返回一个 Retry-After 的响应头，以告知客户端可以在多少时间以后重新尝试\n    REQUEST_URI_TOO_LONG: 414,  //请求的URI长度超过了服务器能够解释的长度，因此服务器拒绝对该请求提供服务。这比较少见，通常的情况包括：本应使用POST方法的表单提交变成了GET方法，导致查询字符串（Query String）过长。重定向URI “黑洞”，例如每次重定向把旧的URI作为新的URI的一部分，导致在若干次重定向后URI超长。客户端正在尝试利用某些服务器中存在的安全漏洞攻击服务器。这类服务器使用固定长度的缓冲读取或操作请求的URI，当GET后的参数超过某个数值后，可能会产生缓冲区溢出，导致任意代码被执行[1]。没有此类漏洞的服务器，应当返回414状态码\n    UNSUPPORTED_MEDIA_TYPE: 415,  //对于当前请求的方法和所请求的资源，请求中提交的实体并不是服务器中所支持的格式，因此请求被拒绝\n    REQUESTED_RANGE_NOT_SATISFIABLE: 416,  //如果请求中包含了Range请求头，并且Range中指定的任何数据范围都与当前资源的可用范围不重合，同时请求中又没有定义If-Range请求头，那么服务器就应当返回416状态码。假如Range使用的是字节范围，那么这种情况就是指请求指定的所有数据范围的首字节位置都超过了当前资源的长度。服务器也应当在返回416状态码的同时，包含一个Content-Range实体头，用以指明当前资源的长度。这个响应也被禁止使用multipart/byteranges作为其 Content-Type\n    EXPECTION_FAILED: 417,  //在请求头Expect中指定的预期内容无法被服务器满足，或者这个服务器是一个代理服务器，它有明显的证据证明在当前路由的下一个节点上，Expect的内容无法被满足\n    TOO_MANY_CONNECTIONS: 421,  //从当前客户端所在的IP地址到服务器的连接数超过了服务器许可的最大范围。通常，这里的IP地址指的是从服务器上看到的客户端地址（比如用户的网关或者代理服务器地址）。在这种情况下，连接数的计算可能涉及到不止一个终端用户\n    UNPROCESSABLE_ENTITY: 422,  //请求格式正确，但是由于含有语义错误，无法响应\n    FAILED_DEPENDENCY: 424,  //由于之前的某个请求发生的错误，导致当前请求失败，例如PROPPATCH\n    UNORDERED_COLLECTION: 425,  //在WebDav Advanced Collections 草案中定义，但是未出现在《WebDAV 顺序集协议》（RFC 3658）中\n    UPGRADE_REQUIRED: 426,  //客户端应当切换到TLS/1.0\n    RETRY_WITH: 449,  //由微软扩展，代表请求应当在执行完适当的操作后进行重试\n\n    INTERNAL_SERVER_ERROR: 500,  //服务器遇到了一个未曾预料的状况，导致了它无法完成对请求的处理。一般来说，这个问题都会在服务器的程序码出错时出现\n    NOT_IMPLEMENTED: 501, //服务器不支持当前请求所需要的某个功能。当服务器无法识别请求的方法，并且无法支持其对任何资源的请求\n    BAD_GATEWAY: 502, //作为网关或者代理工作的服务器尝试执行请求时，从上游服务器接收到无效的响应\n    SERVICE_UNAVAILABLE: 503,  //由于临时的服务器维护或者过载，服务器当前无法处理请求。这个状况是临时的，并且将在一段时间以后恢复。如果能够预计延迟时间，那么响应中可以包含一个 Retry-After 头用以标明这个延迟时间。如果没有给出这个 Retry-After 信息，那么客户端应当以处理500响应的方式处理它。注意：503状态码的存在并不意味着服务器在过载的时候必须使用它。某些服务器只不过是希望拒绝客户端的连接\n    GATEWAY_TIMEOUT: 504,  //作为网关或者代理工作的服务器尝试执行请求时，未能及时从上游服务器（URI标识出的服务器，例如HTTP、FTP、LDAP）或者辅助服务器（例如DNS）收到响应。注意：某些代理服务器在DNS查询超时时会返回400或者500错误\n    HTTP_VERSION_NOT_SUPPORTED: 505,  //服务器不支持，或者拒绝支持在请求中使用的HTTP版本。这暗示着服务器不能或不愿使用与客户端相同的版本。响应中应当包含一个描述了为何版本不被支持以及服务器支持哪些协议的实体\n    VARIANT_ALSO_NEGOTIATES: 506,  //服务器存在内部配置错误：被请求的协商变元资源被配置为在透明内容协商中使用自己，因此在一个协商处理中不是一个合适的重点\n    INSUFFICIENT_STORAGE: 507,  //服务器无法存储完成请求所必须的内容。这个状况被认为是临时的\n    BANDWIDTH_LIMIT_EXCEEDED: 509,  //服务器达到带宽限制。这不是一个官方的状态码，但是仍被广泛使用\n    NOT_EXTENDED: 510  //获取资源所需要的策略并没有没满足\n\n};","import path from 'path';\n\nimport fs from 'fs-extra';\nimport yaml from 'yaml';\nimport _ from 'lodash';\n\nimport environment from '../environment.ts';\n\nconst CONFIG_PATH = path.join(path.resolve(), 'configs/', environment.env, \"/system.yml\");\n\n/**\n * 系统配置\n */\nexport class SystemConfig {\n\n    /** 是否开启请求日志 */\n    requestLog: boolean;\n    /** 临时目录路径 */\n    tmpDir: string;\n    /** 日志目录路径 */\n    logDir: string;\n    /** 日志写入间隔（毫秒） */\n    logWriteInterval: number;\n    /** 日志文件有效期（毫秒） */\n    logFileExpires: number;\n    /** 临时文件有效期（毫秒） */\n    tmpFileExpires: number;\n    /** 请求体配置 */\n    requestBody: any;\n    /** 是否调试模式 */\n    debug: boolean;\n    /** 日志级别 */\n    log_level: string;\n\n    constructor(options?: any) {\n        const { requestLog, tmpDir, logDir, logWriteInterval, logFileExpires, tmpFileExpires, requestBody, debug, log_level } = options || {};\n        this.requestLog = _.defaultTo(requestLog, false);\n        this.tmpDir = _.defaultTo(tmpDir, './tmp');\n        this.logDir = _.defaultTo(logDir, './logs');\n        this.logWriteInterval = _.defaultTo(logWriteInterval, 200);\n        this.logFileExpires = _.defaultTo(logFileExpires, 2626560000);\n        this.tmpFileExpires = _.defaultTo(tmpFileExpires, 86400000);\n        this.requestBody = Object.assign(requestBody || {}, {\n            enableTypes: ['form', 'text', 'xml'],  // 移除 json，由自定义中间件处理\n            encoding: 'utf-8',\n            formLimit: '100mb',\n            jsonLimit: '100mb',\n            textLimit: '100mb',\n            xmlLimit: '100mb',\n            formidable: {\n                maxFileSize: '100mb'\n            },\n            multipart: true,\n            parsedMethods: ['POST', 'PUT', 'PATCH']\n        });\n        this.debug = _.defaultTo(debug, true);\n        this.log_level = _.defaultTo(log_level, 'info');\n    }\n\n    get rootDirPath() {\n        return path.resolve();\n    }\n\n    get tmpDirPath() {\n        return path.resolve(this.tmpDir);\n    }\n\n    get logDirPath() {\n        return path.resolve(this.logDir);\n    }\n\n    static load() {\n        if (!fs.pathExistsSync(CONFIG_PATH)) return new SystemConfig();\n        const data = yaml.parse(fs.readFileSync(CONFIG_PATH).toString());\n        return new SystemConfig(data);\n    }\n\n}\n\nexport default SystemConfig.load();","import serviceConfig from \"./configs/service-config.ts\";\nimport systemConfig from \"./configs/system-config.ts\";\n\nclass Config {\n    \n    /** 服务配置 */\n    service = serviceConfig;\n    \n    /** 系统配置 */\n    system = systemConfig;\n\n}\n\nexport default new Config();","import path from 'path';\nimport _util from 'util';\n\nimport 'colors';\nimport _ from 'lodash';\nimport fs from 'fs-extra';\nimport { format as dateFormat } from 'date-fns';\n\nimport config from './config.ts';\nimport util from './util.ts';\n\nconst isVercelEnv = process.env.VERCEL;\n\nclass LogWriter {\n\n    #buffers = [];\n\n    constructor() {\n        !isVercelEnv && fs.ensureDirSync(config.system.logDirPath);\n        !isVercelEnv && this.work();\n    }\n\n    push(content) {\n        const buffer = Buffer.from(content);\n        this.#buffers.push(buffer);\n    }\n\n    writeSync(buffer) {\n        !isVercelEnv && fs.appendFileSync(path.join(config.system.logDirPath, `/${util.getDateString()}.log`), buffer);\n    }\n\n    async write(buffer) {\n        !isVercelEnv && await fs.appendFile(path.join(config.system.logDirPath, `/${util.getDateString()}.log`), buffer);\n    }\n\n    flush() {\n        if(!this.#buffers.length) return;\n        !isVercelEnv && fs.appendFileSync(path.join(config.system.logDirPath, `/${util.getDateString()}.log`), Buffer.concat(this.#buffers));\n    }\n\n    work() {\n        if (!this.#buffers.length) return setTimeout(this.work.bind(this), config.system.logWriteInterval);\n        const buffer = Buffer.concat(this.#buffers);\n        this.#buffers = [];\n        this.write(buffer)\n        .finally(() => setTimeout(this.work.bind(this), config.system.logWriteInterval))\n        .catch(err => console.error(\"Log write error:\", err));\n    }\n\n}\n\nclass LogText {\n\n    /** @type {string} 日志级别 */\n    level;\n    /** @type {string} 日志文本 */\n    text;\n    /** @type {string} 日志来源 */\n    source;\n    /** @type {Date} 日志发生时间 */\n    time = new Date();\n\n    constructor(level, ...params) {\n        this.level = level;\n        this.text = _util.format.apply(null, params);\n        this.source = this.#getStackTopCodeInfo();\n    }\n\n    #getStackTopCodeInfo() {\n        const unknownInfo = { name: \"unknown\", codeLine: 0, codeColumn: 0 };\n        const stackArray = new Error().stack.split(\"\\n\");\n        const text = stackArray[4];\n        if (!text)\n            return unknownInfo;\n        const match = text.match(/at (.+) \\((.+)\\)/) || text.match(/at (.+)/);\n        if (!match || !_.isString(match[2] || match[1]))\n            return unknownInfo;\n        const temp = match[2] || match[1];\n        const _match = temp.match(/([a-zA-Z0-9_\\-\\.]+)\\:(\\d+)\\:(\\d+)$/);\n        if (!_match)\n            return unknownInfo;\n        const [, scriptPath, codeLine, codeColumn] = _match as any;\n        return {\n            name: scriptPath ? scriptPath.replace(/.js$/, \"\") : \"unknown\",\n            path: scriptPath || null,\n            codeLine: parseInt(codeLine || 0),\n            codeColumn: parseInt(codeColumn || 0)\n        };\n    }\n\n    toString() {\n        return `[${dateFormat(this.time, \"yyyy-MM-dd HH:mm:ss.SSS\")}][${this.level}][${this.source.name}<${this.source.codeLine},${this.source.codeColumn}>] ${this.text}`;\n    }\n\n}\n\nclass Logger {\n\n    /** @type {Object} 系统配置 */\n    config = {};\n    /** @type {Object} 日志级别映射 */\n    static Level = {\n        Info: \"info\",\n        Debug: \"debug\",\n        Warning: \"warning\",\n        Error: \"error\",\n    };\n    /** @type {Object} 日志级别文本颜色樱色 */\n    static LevelColor = {\n        [Logger.Level.Success]: \"green\",\n        [Logger.Level.Info]: \"brightCyan\",\n        [Logger.Level.Debug]: \"white\",\n        [Logger.Level.Warning]: \"brightYellow\",\n        [Logger.Level.Error]: \"brightRed\",\n        [Logger.Level.Fatal]: \"red\"\n    };\n    static LevelPriority = {\n        [Logger.Level.Fatal]: 1,\n        [Logger.Level.Error]: 2,\n        [Logger.Level.Warning]: 3,\n        [Logger.Level.Success]: 4,\n        [Logger.Level.Info]: 5,\n        [Logger.Level.Log]: 6,\n        [Logger.Level.Debug]: 7,\n    }\n    #writer;\n\n    constructor() {\n        this.#writer = new LogWriter();\n    }\n\n    header() {\n        this.#writer.writeSync(Buffer.from(`\\n\\n===================== LOG START ${dateFormat(new Date(), \"yyyy-MM-dd HH:mm:ss.SSS\")} =====================\\n\\n`));\n    }\n\n    footer() {\n        this.#writer.flush();  //将未写入文件的日志缓存写入\n        this.#writer.writeSync(Buffer.from(`\\n\\n===================== LOG END ${dateFormat(new Date(), \"yyyy-MM-dd HH:mm:ss.SSS\")} =====================\\n\\n`));\n    }\n\n    #checkLevel(level) {\n        const currentLevelPriority = Logger.LevelPriority[config.system.log_level] || 99;\n        const levelPriority = Logger.LevelPriority[level];\n        return levelPriority <= currentLevelPriority;\n    }\n\n    success(...params) {\n        if (!this.#checkLevel(Logger.Level.Success)) return;\n        const content = new LogText(Logger.Level.Success, ...params).toString();\n        console.info(content[Logger.LevelColor[Logger.Level.Success]]);\n        this.#writer.push(content + \"\\n\");\n    }\n\n    info(...params) {\n        if (!this.#checkLevel(Logger.Level.Info)) return;\n        const content = new LogText(Logger.Level.Info, ...params).toString();\n        console.info(content[Logger.LevelColor[Logger.Level.Info]]);\n        this.#writer.push(content + \"\\n\");\n    }\n\n    debug(...params) {\n        if(!config.system.debug) return;  //非调试模式忽略debug\n        if (!this.#checkLevel(Logger.Level.Debug)) return;\n        const content = new LogText(Logger.Level.Debug, ...params).toString();\n        console.debug(content[Logger.LevelColor[Logger.Level.Debug]]);\n        this.#writer.push(content + \"\\n\");\n    }\n\n    warn(...params) {\n        if (!this.#checkLevel(Logger.Level.Warning)) return;\n        const content = new LogText(Logger.Level.Warning, ...params).toString();\n        console.warn(content[Logger.LevelColor[Logger.Level.Warning]]);\n        this.#writer.push(content + \"\\n\");\n    }\n\n    error(...params) {\n        if (!this.#checkLevel(Logger.Level.Error)) return;\n        const content = new LogText(Logger.Level.Error, ...params).toString();\n        console.error(content[Logger.LevelColor[Logger.Level.Error]]);\n        this.#writer.push(content);\n    }\n\n    destory() {\n        this.#writer.destory();\n    }\n\n}\n\nexport default new Logger();","import logger from './logger.js';\n\n// 允许无限量的监听器\nprocess.setMaxListeners(Infinity);\n// 输出未捕获异常\nprocess.on(\"uncaughtException\", (err, origin) => {\n    logger.error(`An unhandled error occurred: ${origin}`, err);\n});\n// 输出未处理的Promise.reject\nprocess.on(\"unhandledRejection\", (_, promise) => {\n    promise.catch(err => logger.error(\"An unhandled rejection occurred:\", err));\n});\n// 输出系统警告信息\nprocess.on(\"warning\", warning => logger.warn(\"System warning: \", warning));\n// 进程退出监听\nprocess.on(\"exit\", () => {\n    logger.info(\"Service exit\");\n    logger.footer();\n});\n// 进程被kill\nprocess.on(\"SIGTERM\", () => {\n    logger.warn(\"received kill signal\");\n    process.exit(2);\n});\n// Ctrl-C进程退出\nprocess.on(\"SIGINT\", () => {\n    process.exit(0);\n});","import Koa from 'koa';\nimport KoaRouter from 'koa-router';\nimport koaRange from 'koa-range';\nimport koaCors from \"koa2-cors\";\nimport koaBody from 'koa-body';\nimport _ from 'lodash';\n\nimport Exception from './exceptions/Exception.ts';\nimport Request from './request/Request.ts';\nimport Response from './response/Response.js';\nimport FailureBody from './response/FailureBody.ts';\nimport EX from './consts/exceptions.ts';\nimport logger from './logger.ts';\nimport config from './config.ts';\n\nclass Server {\n\n    app;\n    router;\n\n    constructor() {\n        this.app = new Koa();\n        this.app.use(koaCors());\n        // 范围请求支持\n        this.app.use(koaRange);\n        this.router = new KoaRouter({ prefix: config.service.urlPrefix });\n        // 前置处理异常拦截\n        this.app.use(async (ctx: any, next: Function) => {\n            if(ctx.request.type === \"application/xml\" || ctx.request.type === \"application/ssml+xml\")\n                ctx.req.headers[\"content-type\"] = \"text/xml\";\n            try { await next() }\n            catch (err) {\n                logger.error(err);\n                const failureBody = new FailureBody(err);\n                new Response(failureBody).injectTo(ctx);\n            }\n        });\n        // 自定义 JSON 解析中间件\n        this.app.use(async (ctx: any, next: Function) => {\n            if (ctx.is('application/json') && ['POST', 'PUT', 'PATCH'].includes(ctx.method)) {\n                logger.debug('开始自定义 JSON 解析');\n                const chunks: Buffer[] = [];\n\n                await new Promise((resolve, reject) => {\n                    ctx.req.on('data', (chunk: Buffer) => {\n                        chunks.push(chunk);\n                    });\n\n                    ctx.req.on('end', () => {\n                        resolve(null);\n                    });\n\n                    ctx.req.on('error', reject);\n                });\n\n                const body = Buffer.concat(chunks).toString('utf8');\n\n                // 清理问题字符\n                let cleanedBody = body\n                    .replace(/\\r\\n/g, '\\n')\n                    .replace(/\\r/g, '\\n')\n                    .replace(/\\u00A0/g, ' ')\n                    .replace(/[\\u2000-\\u200B]/g, ' ')\n                    .replace(/\\uFEFF/g, '')\n                    .trim();\n\n                // 预先处理尾随逗号问题\n                cleanedBody = cleanedBody.replace(/,(\\s*[\\r\\n]*\\s*[}\\]])/g, '$1');\n\n                // 安全的JSON解析\n                let parsedBody;\n                try {\n                    parsedBody = JSON.parse(cleanedBody);\n                } catch (parseError) {\n                    logger.error(`JSON解析失败: ${parseError.message}`);\n                    logger.debug(`原始请求体: ${body.substring(0, 200)}...`);\n                    logger.debug(`清理后请求体: ${cleanedBody.substring(0, 200)}...`);\n\n                    // 尝试修复常见的JSON格式问题\n                    let fixedBody = cleanedBody;\n                    try {\n                        // 修复单引号问题\n                        fixedBody = fixedBody.replace(/'/g, '\"');\n                        // 修复属性名没有引号的问题\n                        fixedBody = fixedBody.replace(/([{,]\\s*)([a-zA-Z_$][a-zA-Z0-9_$]*)\\s*:/g, '$1\"$2\":');\n                        // 修复尾随逗号问题 - 更强的正则表达式\n                        fixedBody = fixedBody.replace(/,(\\s*[\\r\\n]*\\s*[}\\]])/g, '$1');\n                        // 修复多个连续逗号\n                        fixedBody = fixedBody.replace(/,+/g, ',');\n\n                        parsedBody = JSON.parse(fixedBody);\n                        logger.debug('JSON修复成功');\n                    } catch (fixError) {\n                        logger.error(`JSON修复也失败: ${fixError.message}`);\n                        logger.debug(`修复后的JSON: ${fixedBody.substring(0, 200)}...`);\n                        throw new Error(`无效的JSON格式: ${parseError.message}`);\n                    }\n                }\n\n                logger.debug('JSON 解析成功，跳过 koa-body');\n\n                ctx.request.body = parsedBody;\n                ctx.request.rawBody = cleanedBody;\n\n                // 标记已处理，避免 koa-body 再次处理\n                ctx._jsonProcessed = true;\n            }\n            await next();\n        });\n\n        // 载荷解析器支持（只处理未被自定义解析器处理的请求）\n        this.app.use(async (ctx: any, next: Function) => {\n            if (!ctx._jsonProcessed) {\n                await koaBody(Object.assign(_.clone(config.system.requestBody), {\n                    multipart: true, // 开启multipart文件上传\n                    formidable: {\n                        maxFileSize: 10 * 1024 * 1024, // 限制最大10MB\n                    },\n                    enableTypes: ['json', 'form', 'text', 'xml'] // 确保form类型被启用\n                }))(ctx, next);\n            } else {\n                await next();\n            }\n        });\n        this.app.on(\"error\", (err: any) => {\n            // 忽略连接重试、中断、管道、取消错误\n            if ([\"ECONNRESET\", \"ECONNABORTED\", \"EPIPE\", \"ECANCELED\"].includes(err.code)) return;\n            logger.error(err);\n        });\n        logger.success(\"Server initialized\");\n    }\n\n    /**\n     * 附加路由\n     *\n     * @param routes 路由列表\n     */\n    attachRoutes(routes: any[]) {\n        routes.forEach((route: any) => {\n            const prefix = route.prefix || \"\";\n            for (let method in route) {\n                if(method === \"prefix\") continue;\n                if (!_.isObject(route[method])) {\n                    logger.warn(`Router ${prefix} ${method} invalid`);\n                    continue;\n                }\n                for (let uri in route[method]) {\n                    this.router[method](`${prefix}${uri}`, async ctx => {\n                        const { request, response } = await this.#requestProcessing(ctx, route[method][uri]);\n                        if(response != null && config.system.requestLog) {\n                            if (ctx.request.url.endsWith('/ping')) {\n                                logger.debug(`<- ${request.method} ${request.url} ${response.time - request.time}ms`);\n                            } else {\n                                logger.info(`<- ${request.method} ${request.url} ${response.time - request.time}ms`);\n                            }\n                        }\n                    });\n                }\n            }\n            logger.info(`Route ${config.service.urlPrefix || \"\"}${prefix} attached`);\n        });\n        this.app.use(this.router.routes());\n        this.app.use((ctx: any) => {\n            const request = new Request(ctx);\n            logger.debug(`-> ${ctx.request.method} ${ctx.request.url} request is not supported - ${request.remoteIP || \"unknown\"}`);\n            // const failureBody = new FailureBody(new Exception(EX.SYSTEM_NOT_ROUTE_MATCHING, \"Request is not supported\"));\n            // const response = new Response(failureBody);\n            const message = `[请求有误]: 正确请求为 POST -> /v1/chat/completions，当前请求为 ${ctx.request.method} -> ${ctx.request.url} 请纠正`;\n            logger.warn(message);\n            const failureBody = new FailureBody(new Error(message));\n            const response = new Response(failureBody);\n            response.injectTo(ctx);\n            if(config.system.requestLog)\n                logger.info(`<- ${request.method} ${request.url} ${response.time - request.time}ms`);\n        });\n    }\n\n    /**\n     * 请求处理\n     *\n     * @param ctx 上下文\n     * @param routeFn 路由方法\n     */\n    #requestProcessing(ctx: any, routeFn: Function): Promise<any> {\n        return new Promise(resolve => {\n            const request = new Request(ctx);\n            try {\n                if(config.system.requestLog) {\n                    if (request.url === '/ping') {\n                        logger.debug(`-> ${request.method} ${request.url}`);\n                    } else {\n                        logger.info(`-> ${request.method} ${request.url}`);\n                    }\n                }\n                    routeFn(request)\n                .then(response => {\n                    try {\n                        if(!Response.isInstance(response)) {\n                            const _response = new Response(response);\n                            _response.injectTo(ctx);\n                            return resolve({ request, response: _response });\n                        }\n                        response.injectTo(ctx);\n                        resolve({ request, response });\n                    }\n                    catch(err) {\n                        logger.error(err);\n                        const failureBody = new FailureBody(err);\n                        const response = new Response(failureBody);\n                        response.injectTo(ctx);\n                        resolve({ request, response });\n                    }\n                })\n                .catch(err => {\n                    try {\n                        logger.error(err);\n                        const failureBody = new FailureBody(err);\n                        const response = new Response(failureBody);\n                        response.injectTo(ctx);\n                        resolve({ request, response });\n                    }\n                    catch(err) {\n                        logger.error(err);\n                        const failureBody = new FailureBody(err);\n                        const response = new Response(failureBody);\n                        response.injectTo(ctx);\n                        resolve({ request, response });\n                    }\n                });\n            }\n            catch(err) {\n                logger.error(err);\n                const failureBody = new FailureBody(err);\n                const response = new Response(failureBody);\n                response.injectTo(ctx);\n                resolve({ request, response });\n            }\n        });\n    }\n\n    /**\n     * 监听端口\n     */\n    async listen() {\n        const host = config.service.host;\n        const port = config.service.port;\n        await Promise.all([\n            new Promise((resolve, reject) => {\n                if(host === \"0.0.0.0\" || host === \"localhost\" || host === \"127.0.0.1\")\n                    return resolve(null);\n                this.app.listen(port, \"localhost\", err => {\n                    if(err) return reject(err);\n                    resolve(null);\n                });\n            }),\n            new Promise((resolve, reject) => {\n                this.app.listen(port, host, err => {\n                    if(err) return reject(err);\n                    resolve(null);\n                });\n            })\n        ]);\n        logger.success(`Server listening on port ${port} (${host})`);\n    }\n\n}\n\nexport default new Server();","import _ from 'lodash';\n\nimport APIException from '@/lib/exceptions/APIException.ts';\nimport EX from '@/api/consts/exceptions.ts';\nimport logger from '@/lib/logger.ts';\nimport util from '@/lib/util.ts';\n\nexport interface RequestOptions {\n    time?: number;\n}\n\nexport default class Request {\n\n    /** 请求方法 */\n    method: string;\n    /** 请求URL */\n    url: string;\n    /** 请求路径 */\n    path: string;\n    /** 请求载荷类型 */\n    type: string;\n    /** 请求headers */\n    headers: any;\n    /** 请求原始查询字符串 */\n    search: string;\n    /** 请求查询参数 */\n    query: any;\n    /** 请求URL参数 */\n    params: any;\n    /** 请求载荷 */\n    body: any;\n    /** 上传的文件 */\n    files: any[];\n    /** 客户端IP地址 */\n    remoteIP: string | null;\n    /** 请求接受时间戳（毫秒） */\n    time: number;\n\n    constructor(ctx, options: RequestOptions = {}) {\n        const { time } = options;\n        this.method = ctx.request.method;\n        this.url = ctx.request.url;\n        this.path = ctx.request.path;\n        this.type = ctx.request.type;\n        this.headers = ctx.request.headers || {};\n        this.search = ctx.request.search;\n        this.query = ctx.query || {};\n        this.params = ctx.params || {};\n        this.body = ctx.request.body || {};\n        this.files = ctx.request.files || {};\n        this.remoteIP = this.headers[\"X-Real-IP\"] || this.headers[\"x-real-ip\"] || this.headers[\"X-Forwarded-For\"] || this.headers[\"x-forwarded-for\"] || ctx.ip || null;\n        this.time = Number(_.defaultTo(time, util.timestamp()));\n    }\n\n    validate(key: string, fn?: Function, message?: string) {\n        try {\n            const value = _.get(this, key);\n            logger.debug(`Validating ${key}: value =`, value, `type =`, typeof value, `isArray =`, Array.isArray(value));\n            if (fn) {\n                const result = fn(value);\n                logger.debug(`Validation function result for ${key}:`, result);\n                if (result === false)\n                    throw `[Mismatch] -> ${fn}`;\n            }\n            else if (_.isUndefined(value))\n                throw '[Undefined]';\n        }\n        catch (err) {\n            logger.warn(`Params ${key} invalid:`, err);\n            throw new APIException(EX.API_REQUEST_PARAMS_INVALID, message || `Params ${key} invalid`);\n        }\n        return this;\n    }\n\n}","import assert from 'assert';\n\nimport _ from 'lodash';\n\nexport default class Exception extends Error {\n\n    /** 错误码 */\n    errcode: number;\n    /** 错误消息 */\n    errmsg: string;\n    /** 数据 */\n    data: any;\n    /** HTTP状态码 */\n    httpStatusCode: number;\n\n    /**\n     * 构造异常\n     * \n     * @param exception 异常\n     * @param _errmsg 异常消息\n     */\n    constructor(exception: (string | number)[], _errmsg?: string) {\n        assert(_.isArray(exception), 'Exception must be Array');\n        const [errcode, errmsg] = exception as [number, string];\n        assert(_.isFinite(errcode), 'Exception errcode invalid');\n        assert(_.isString(errmsg), 'Exception errmsg invalid');\n        super(_errmsg || errmsg);\n        this.errcode = errcode;\n        this.errmsg = _errmsg || errmsg;\n    }\n\n    compare(exception: (string | number)[]) {\n        const [errcode] = exception as [number, string];\n        return this.errcode == errcode;\n    }\n\n    setHTTPStatusCode(value: number) {\n        this.httpStatusCode = value;\n        return this;\n    }\n\n    setData(value: any) {\n        this.data = _.defaultTo(value, null);\n        return this;\n    }\n\n}","import Exception from './Exception.js';\n\nexport default class APIException extends Exception {\n\n    /**\n     * 构造异常\n     * \n     * @param {[number, string]} exception 异常\n     */\n    constructor(exception: (string | number)[], errmsg?: string) {\n        super(exception, errmsg);\n    }\n\n}","export default {\n    API_TEST: [-9999, 'API异常错误'],\n    API_REQUEST_PARAMS_INVALID: [-2000, '请求参数非法'],\n    API_REQUEST_FAILED: [-2001, '请求失败'],\n    API_TOKEN_EXPIRES: [-2002, 'Token已失效'],\n    API_FILE_URL_INVALID: [-2003, '远程文件URL非法'],\n    API_FILE_EXECEEDS_SIZE: [-2004, '远程文件超出大小'],\n    API_CHAT_STREAM_PUSHING: [-2005, '已有对话流正在输出'],\n    API_CONTENT_FILTERED: [-2006, '内容由于合规问题已被阻止生成'],\n    API_IMAGE_GENERATION_FAILED: [-2007, '图像生成失败'],\n    API_VIDEO_GENERATION_FAILED: [-2008, '视频生成失败'],\n    API_IMAGE_GENERATION_INSUFFICIENT_POINTS: [-2009, '即梦积分不足'],\n}","import mime from 'mime';\nimport _ from 'lodash';\n\nimport Body from './Body.ts';\nimport util from '../util.ts';\n\nexport interface ResponseOptions {\n    statusCode?: number;\n    type?: string;\n    headers?: Record<string, any>;\n    redirect?: string;\n    body?: any;\n    size?: number;\n    time?: number;\n}\n\nexport default class Response {\n\n    /** 响应HTTP状态码 */\n    statusCode: number;\n    /** 响应内容类型 */\n    type: string;\n    /** 响应headers */\n    headers: Record<string, any>;\n    /** 重定向目标 */\n    redirect: string;\n    /** 响应载荷 */\n    body: any;\n    /** 响应载荷大小 */\n    size: number;\n    /** 响应时间戳 */\n    time: number;\n\n    constructor(body: any, options: ResponseOptions = {}) {\n        const { statusCode, type, headers, redirect, size, time } = options;\n        this.statusCode = Number(_.defaultTo(statusCode, Body.isInstance(body) ? body.statusCode : undefined))\n        this.type = type;\n        this.headers = headers;\n        this.redirect = redirect;\n        this.size = size;\n        this.time = Number(_.defaultTo(time, util.timestamp()));\n        this.body = body;\n    }\n\n    injectTo(ctx) {\n        this.redirect && ctx.redirect(this.redirect);\n        this.statusCode && (ctx.status = this.statusCode);\n        this.type && (ctx.type = mime.getType(this.type) || this.type);\n        const headers = this.headers || {};\n        if(this.size && !headers[\"Content-Length\"] && !headers[\"content-length\"])\n            headers[\"Content-Length\"] = this.size;\n        ctx.set(headers);\n        if(Body.isInstance(this.body))\n            ctx.body = this.body.toObject();\n        else\n            ctx.body = this.body;\n    }\n\n    static isInstance(value) {\n        return value instanceof Response;\n    }\n\n}","import  _ from 'lodash';\n\nexport interface BodyOptions {\n    code?: number;\n    message?: string;\n    data?: any;\n    statusCode?: number;\n}\n\nexport default class Body {\n\n    /** 状态码 */\n    code: number;\n    /** 状态消息 */\n    message: string;\n    /** 载荷 */\n    data: any;\n    /** HTTP状态码 */\n    statusCode: number;\n\n    constructor(options: BodyOptions = {}) {\n        const { code, message, data, statusCode } = options;\n        this.code = Number(_.defaultTo(code, 0));\n        this.message = _.defaultTo(message, 'OK');\n        this.data = _.defaultTo(data, null);\n        this.statusCode = Number(_.defaultTo(statusCode, 200));\n    }\n\n    toObject() {\n        return {\n            code: this.code,\n            message: this.message,\n            data: this.data\n        };\n    }\n\n    static isInstance(value) {\n        return value instanceof Body;\n    }\n\n}","import _ from 'lodash';\n\nimport Body from './Body.ts';\nimport Exception from '../exceptions/Exception.ts';\nimport APIException from '../exceptions/APIException.ts';\nimport EX from '../consts/exceptions.ts';\nimport HTTP_STATUS_CODES from '../http-status-codes.ts';\n\nexport default class FailureBody extends Body {\n    \n    constructor(error: APIException | Exception | Error, _data?: any) {\n        let errcode, errmsg, data = _data, httpStatusCode = HTTP_STATUS_CODES.OK;;\n        if(_.isString(error))\n            error = new Exception(EX.SYSTEM_ERROR, error);\n        else if(error instanceof APIException || error instanceof Exception)\n            ({ errcode, errmsg, data, httpStatusCode } = error);\n        else if(_.isError(error))\n        ({ errcode, errmsg, data, httpStatusCode } = new Exception(EX.SYSTEM_ERROR, error.message));\n        super({\n            code: errcode || -1,\n            message: errmsg || 'Internal error',\n            data,\n            statusCode: httpStatusCode\n        });\n    }\n\n    static isInstance(value) {\n        return value instanceof FailureBody;\n    }\n\n}","export default {\n    SYSTEM_ERROR: [-1000, '系统异常'],\n    SYSTEM_REQUEST_VALIDATION_ERROR: [-1001, '请求参数校验错误'],\n    SYSTEM_NOT_ROUTE_MATCHING: [-1002, '无匹配的路由']\n} as Record<string, [number, string]>","import fs from \"fs\";\nimport _ from \"lodash\";\n\nimport Request from \"@/lib/request/Request.ts\";\nimport { generateImages, generateImageComposition } from \"@/api/controllers/images.ts\";\nimport { getImageByHistoryId, getAssetList, getImagesByHistoryIds } from \"@/api/controllers/get_historyId.ts\";\nimport { DEFAULT_IMAGE_MODEL } from \"@/api/consts/common.ts\";\nimport { tokenSplit } from \"@/api/controllers/core.ts\";\nimport util from \"@/lib/util.ts\";\n\nexport default {\n  prefix: \"/v1/images\",\n\n  post: {\n    \"/generations\": async (request: Request) => {\n      const unsupportedParams = ['size', 'width', 'height'];\n      const bodyKeys = Object.keys(request.body);\n      const foundUnsupported = unsupportedParams.filter(param => bodyKeys.includes(param));\n\n      if (foundUnsupported.length > 0) {\n        throw new Error(`不支持的参数: ${foundUnsupported.join(', ')}。请使用 ratio 和 resolution 参数控制图像尺寸。`);\n      }\n\n      // 检查是否错误地包含了 images 字段（images 字段应该用于 compositions 接口）\n      if (bodyKeys.includes('images')) {\n        throw new Error(`[接口使用错误]: /v1/images/generations 接口用于生成新图片，不应包含 'images' 字段。如需图片合成，请使用 /v1/images/compositions 接口`);\n      }\n\n      request\n        .validate(\"body.model\", v => _.isUndefined(v) || _.isString(v))\n        .validate(\"body.prompt\", _.isString)\n        .validate(\"body.negative_prompt\", v => _.isUndefined(v) || _.isString(v))\n        .validate(\"body.ratio\", v => _.isUndefined(v) || _.isString(v))\n        .validate(\"body.resolution\", v => _.isUndefined(v) || _.isString(v))\n        .validate(\"body.intelligent_ratio\", v => _.isUndefined(v) || _.isBoolean(v))\n        .validate(\"body.sample_strength\", v => _.isUndefined(v) || _.isFinite(v))\n        .validate(\"body.response_format\", v => _.isUndefined(v) || _.isString(v))\n        .validate(\"headers.authorization\", _.isString);\n\n      const tokens = tokenSplit(request.headers.authorization);\n      const token = _.sample(tokens);\n      const {\n        model,\n        prompt,\n        negative_prompt: negativePrompt,\n        ratio,\n        resolution,\n        intelligent_ratio: intelligentRatio,\n        sample_strength: sampleStrength,\n        response_format,\n      } = request.body;\n\n      const responseFormat = _.defaultTo(response_format, \"url\");\n      const result = await generateImages(model, prompt, {\n        ratio,\n        resolution,\n        sampleStrength,\n        negativePrompt,\n        intelligentRatio,\n      }, token);\n      \n      const imageUrls = result.imageUrls;\n      const historyId = result.historyId;\n      \n      return {\n        created: util.unixTimestamp(),\n        data: {\n          historyId: historyId\n        }\n      };\n    },\n    \n    \"/compositions\": async (request: Request) => {\n      const unsupportedParams = ['size', 'width', 'height'];\n      const bodyKeys = Object.keys(request.body);\n      const foundUnsupported = unsupportedParams.filter(param => bodyKeys.includes(param));\n\n      if (foundUnsupported.length > 0) {\n        throw new Error(`不支持的参数: ${foundUnsupported.join(', ')}。请使用 ratio 和 resolution 参数控制图像尺寸。`);\n      }\n\n      const contentType = request.headers['content-type'] || '';\n      const isMultiPart = contentType.startsWith('multipart/form-data');\n\n      if (isMultiPart) {\n        request\n          .validate(\"body.model\", v => _.isUndefined(v) || _.isString(v))\n          .validate(\"body.prompt\", _.isString)\n          .validate(\"body.negative_prompt\", v => _.isUndefined(v) || _.isString(v))\n          .validate(\"body.ratio\", v => _.isUndefined(v) || _.isString(v))\n          .validate(\"body.resolution\", v => _.isUndefined(v) || _.isString(v))\n          .validate(\"body.intelligent_ratio\", v => _.isUndefined(v) || (typeof v === 'string' && (v === 'true' || v === 'false')) || _.isBoolean(v))\n          .validate(\"body.sample_strength\", v => _.isUndefined(v) || (typeof v === 'string' && !isNaN(parseFloat(v))) || _.isFinite(v))\n          .validate(\"body.response_format\", v => _.isUndefined(v) || _.isString(v))\n          .validate(\"headers.authorization\", _.isString);\n      } else {\n        request\n          .validate(\"body.model\", v => _.isUndefined(v) || _.isString(v))\n          .validate(\"body.prompt\", _.isString)\n          .validate(\"body.images\", _.isArray)\n          .validate(\"body.negative_prompt\", v => _.isUndefined(v) || _.isString(v))\n          .validate(\"body.ratio\", v => _.isUndefined(v) || _.isString(v))\n          .validate(\"body.resolution\", v => _.isUndefined(v) || _.isString(v))\n          .validate(\"body.intelligent_ratio\", v => _.isUndefined(v) || _.isBoolean(v))\n          .validate(\"body.sample_strength\", v => _.isUndefined(v) || _.isFinite(v))\n          .validate(\"body.response_format\", v => _.isUndefined(v) || _.isString(v))\n          .validate(\"headers.authorization\", _.isString);\n      }\n\n      let images: (string | Buffer)[] = [];\n      if (isMultiPart) {\n        const files = request.files?.images;\n        if (!files) {\n          throw new Error(\"在form-data中缺少 'images' 字段\");\n        }\n        const imageFiles = Array.isArray(files) ? files : [files];\n        if (imageFiles.length === 0) {\n          throw new Error(\"至少需要提供1张输入图片\");\n        }\n        if (imageFiles.length > 10) {\n          throw new Error(\"最多支持10张输入图片\");\n        }\n        images = imageFiles.map(file => fs.readFileSync(file.filepath));\n      } else {\n        const bodyImages = request.body.images;\n        if (!bodyImages || bodyImages.length === 0) {\n          throw new Error(\"至少需要提供1张输入图片\");\n        }\n        if (bodyImages.length > 10) {\n          throw new Error(\"最多支持10张输入图片\");\n        }\n        bodyImages.forEach((image: any, index: number) => {\n          if (!_.isString(image) && !_.isObject(image)) {\n            throw new Error(`图片 ${index + 1} 格式不正确：应为URL字符串或包含url字段的对象`);\n          }\n          if (_.isObject(image) && !image.url) {\n            throw new Error(`图片 ${index + 1} 缺少url字段`);\n          }\n        });\n        images = bodyImages.map((image: any) => _.isString(image) ? image : image.url);\n      }\n\n      const tokens = tokenSplit(request.headers.authorization);\n      const token = _.sample(tokens);\n\n      const {\n        model,\n        prompt,\n        negative_prompt: negativePrompt,\n        ratio,\n        resolution,\n        intelligent_ratio: intelligentRatio,\n        sample_strength: sampleStrength,\n        response_format,\n      } = request.body;\n      const finalModel = _.defaultTo(model, DEFAULT_IMAGE_MODEL);\n\n      // 如果是 multipart/form-data，需要将字符串转换为数字和布尔值\n      const finalSampleStrength = isMultiPart && typeof sampleStrength === 'string'\n        ? parseFloat(sampleStrength)\n        : sampleStrength;\n\n      const finalIntelligentRatio = isMultiPart && typeof intelligentRatio === 'string'\n        ? intelligentRatio === 'true'\n        : intelligentRatio;\n\n      const responseFormat = _.defaultTo(response_format, \"url\");\n      const result = await generateImageComposition(finalModel, prompt, images, {\n        ratio,\n        resolution,\n        sampleStrength: finalSampleStrength,\n        negativePrompt,\n        intelligentRatio: finalIntelligentRatio,\n      }, token);\n\n      let data = [];\n      if (responseFormat == \"b64_json\") {\n        data = (\n          await Promise.all(result.imageUrls.map((url) => util.fetchFileBASE64(url)))\n        ).map((b64) => ({ b64_json: b64 }));\n      } else {\n        data = result.imageUrls.map((url) => ({\n          url,\n        }));\n      }\n\n      return {\n        created: util.unixTimestamp(),\n        data: {\n          historyId: result.historyId,\n        },\n      };\n    },\n    \n    \"/get_history_by_ids\": async (request: Request) => {\n      request\n        .validate(\"body.history_ids\", v => _.isArray(v) || _.isString(v), \"history_ids 必须是数组格式（如 [\\\"id1\\\", \\\"id2\\\"]）或字符串格式（如 \\\"id1\\\"）\")\n        .validate(\"headers.authorization\", _.isString);\n\n      const tokens = tokenSplit(request.headers.authorization);\n      const token = _.sample(tokens);\n      let { history_ids } = request.body;\n\n      // 统一处理参数：如果是字符串，转换为数组\n      if (_.isString(history_ids)) {\n        history_ids = [history_ids];\n      }\n\n      // 验证历史记录ID数组\n      if (!history_ids || history_ids.length === 0) {\n        throw new Error(\"必须提供至少一个历史记录ID\");\n      }\n      \n      if (history_ids.length > 50) {\n        throw new Error(\"最多支持50个历史记录ID\");\n      }\n      \n      // 验证每个ID都是字符串\n      for (const id of history_ids) {\n        if (!_.isString(id)) {\n          throw new Error(\"历史记录ID必须是字符串类型\");\n        }\n      }\n\n      const result = await getImagesByHistoryIds(history_ids, token);\n      \n      // 如果请求指定了response_format，进行相应转换\n      const responseFormat = _.defaultTo(request.body.response_format, \"url\");\n      \n      // 处理所有历史记录的图片数据\n      let allImages = [];\n      \n      for (const historyId of history_ids) {\n        const historyResult = result[historyId];\n        \n        if (historyResult.error) {\n          console.warn(`历史记录 ${historyId} 查询失败:`, historyResult.error);\n          continue;\n        }\n\n        if (responseFormat === \"b64_json\") {\n          // 对于b64_json格式，优先使用largeimg URL并转换为base64\n          const b64Images = await Promise.all(historyResult.images.map(async (imageObj) => {\n            const imageUrl = imageObj.largeimg || imageObj.webp || imageObj.cover || imageObj.jpeg;\n            if (!imageUrl) return { b64_json: null };\n            \n            try {\n              const b64 = await util.fetchFileBASE64(imageUrl);\n              return { b64_json: b64 };\n            } catch (error) {\n              console.error(`转换图片URL为base64失败: ${error.message}`);\n              return { b64_json: null };\n            }\n          }));\n          allImages = allImages.concat(b64Images);\n        } else {\n          // 对于url格式，返回各种尺寸的图片URL\n          const urlImages = historyResult.images.map(imageObj => ({\n            webp: imageObj.webp || \"\",\n            cover: imageObj.cover || \"\",\n            png: imageObj.png || imageObj.largeimg || \"\",\n            large: imageObj.large || imageObj.largeimg || \"\"\n          }));\n          allImages = allImages.concat(urlImages);\n        }\n      }\n      \n      return {\n        created: util.unixTimestamp(),\n        data: allImages\n      };\n    },\n  },\n  \n  get: {\n    \"/history/:id\": async (request: Request) => {\n      request\n        .validate(\"params.id\", _.isString)\n        .validate(\"headers.authorization\", _.isString);\n        \n      const tokens = tokenSplit(request.headers.authorization);\n      const token = _.sample(tokens);\n      const historyId = request.params.id;\n      \n      const result = await getImageByHistoryId(historyId, token);\n      const images = result.images || [];\n      \n      return {\n        created: util.unixTimestamp(),\n        data: images.map((imageObj) => ({\n          webp: imageObj.webp || \"\",\n          cover: imageObj.cover || \"\",\n          png: imageObj.png || \"\",\n          large: imageObj.large || \"\"\n        })),\n      };\n    },\n    \n    \"/assets/:id\": async (request: Request) => {\n      request\n        .validate(\"params.id\", _.isString)\n        .validate(\"headers.authorization\", _.isString);\n        \n      const tokens = tokenSplit(request.headers.authorization);\n      const token = _.sample(tokens);\n      const historyId = request.params.id;\n      \n      const assets = await getAssetList(token);\n      \n      return {\n        created: util.unixTimestamp(),\n        data: assets,\n      };\n    },\n  },\n};\n","import _ from \"lodash\";\nimport crypto from \"crypto\";\n\nimport APIException from \"@/lib/exceptions/APIException.ts\";\nimport EX from \"@/api/consts/exceptions.ts\";\nimport util from \"@/lib/util.ts\";\nimport { getCredit, receiveCredit, request } from \"./core.ts\";\nimport logger from \"@/lib/logger.ts\";\nimport { getImageByHistoryId, getAssetList } from \"@/api/controllers/get_historyId.ts\";\nimport { SmartPoller, PollingStatus } from \"@/lib/smart-poller.ts\";\nimport { DEFAULT_ASSISTANT_ID_CN, DEFAULT_ASSISTANT_ID_US, DEFAULT_IMAGE_MODEL, DRAFT_VERSION, DRAFT_MIN_VERSION, IMAGE_MODEL_MAP, IMAGE_MODEL_MAP_US, RESOLUTION_OPTIONS } from \"@/api/consts/common.ts\";\nimport { BASE_URL_DREAMINA_US, BASE_URL_IMAGEX_US, WEB_VERSION as DREAMINA_WEB_VERSION, DA_VERSION as DREAMINA_DA_VERSION, AIGC_FEATURES as DREAMINA_AIGC_FEATURES } from \"@/api/consts/dreamina.ts\";\nimport { createSignature } from \"@/lib/aws-signature.ts\";\n\nexport const DEFAULT_MODEL = DEFAULT_IMAGE_MODEL;\n\nfunction getResolutionParams(resolution: string = '2k', ratio: string = '1:1'): { width: number; height: number; image_ratio: number; resolution_type: string } {\n  const resolutionGroup = RESOLUTION_OPTIONS[resolution];\n  if (!resolutionGroup) {\n    const supportedResolutions = Object.keys(RESOLUTION_OPTIONS).join(', ');\n    throw new Error(`不支持的分辨率 \"${resolution}\"。支持的分辨率: ${supportedResolutions}`);\n  }\n\n  const ratioConfig = resolutionGroup[ratio];\n  if (!ratioConfig) {\n    const supportedRatios = Object.keys(resolutionGroup).join(', ');\n    throw new Error(`在 \"${resolution}\" 分辨率下，不支持的比例 \"${ratio}\"。支持的比例: ${supportedRatios}`);\n  }\n\n  return {\n    width: ratioConfig.width,\n    height: ratioConfig.height,\n    image_ratio: ratioConfig.ratio,\n    resolution_type: resolution,\n  };\n}\nexport function getModel(model: string, isUS: boolean) {\n  const modelMap = isUS ? IMAGE_MODEL_MAP_US : IMAGE_MODEL_MAP;\n  if (isUS && !modelMap[model]) {\n    const supportedModels = Object.keys(modelMap).join(', ');\n    throw new Error(`国际版不支持模型 \"${model}\"。支持的模型: ${supportedModels}`);\n  }\n  return modelMap[model] || modelMap[DEFAULT_MODEL];\n}\n\nfunction calculateCRC32(buffer: ArrayBuffer): string {\n  const crcTable = [];\n  for (let i = 0; i < 256; i++) {\n    let crc = i;\n    for (let j = 0; j < 8; j++) {\n      crc = (crc & 1) ? (0xEDB88320 ^ (crc >>> 1)) : (crc >>> 1);\n    }\n    crcTable[i] = crc;\n  }\n\n  let crc = 0 ^ (-1);\n  const bytes = new Uint8Array(buffer);\n  for (let i = 0; i < bytes.length; i++) {\n    crc = (crc >>> 8) ^ crcTable[(crc ^ bytes[i]) & 0xFF];\n  }\n  return ((crc ^ (-1)) >>> 0).toString(16).padStart(8, '0');\n}\n\nasync function uploadImageFromUrl(imageUrl: string, refreshToken: string, isUS: boolean): Promise<string> {\n  try {\n    logger.info(`开始上传图片: ${imageUrl} (isUS: ${isUS})`);\n\n    const imageResponse = await fetch(imageUrl);\n    if (!imageResponse.ok) {\n      throw new Error(`下载图片失败: ${imageResponse.status}`);\n    }\n    const imageBuffer = await imageResponse.arrayBuffer();\n\n    return await uploadImageFromBuffer(Buffer.from(imageBuffer), refreshToken, isUS);\n\n  } catch (error) {\n    logger.error(`图片上传失败: ${error.message}`);\n    throw error;\n  }\n}\n\nasync function uploadImageFromBuffer(imageBuffer: Buffer, refreshToken: string, isUS: boolean): Promise<string> {\n  try {\n    logger.info(`开始通过Buffer上传图片... (isUS: ${isUS})`);\n\n    const tokenResult = await request(\"post\", \"/mweb/v1/get_upload_token\", refreshToken, {\n      data: {\n        scene: 2,\n      },\n      params: isUS ? {\n        aid: DEFAULT_ASSISTANT_ID_US,\n        web_version: DREAMINA_WEB_VERSION,\n        da_version: DREAMINA_DA_VERSION,\n        aigc_features: DREAMINA_AIGC_FEATURES,\n      } : {\n        aid: DEFAULT_ASSISTANT_ID_CN.toString(),\n      },\n    });\n    const { access_key_id, secret_access_key, session_token } = tokenResult;\n    const service_id = isUS ? tokenResult.space_name : tokenResult.service_id;\n\n    if (!access_key_id || !secret_access_key || !session_token) {\n      throw new Error(\"获取上传令牌失败\");\n    }\n\n    const actualServiceId = service_id || (isUS ? \"wopfjsm1ax\" : \"tb4s082cfz\");\n\n    logger.info(`获取上传令牌成功: service_id=${actualServiceId}`);\n\n    const fileSize = imageBuffer.byteLength;\n    const crc32 = calculateCRC32(imageBuffer);\n\n    logger.info(`图片Buffer: 大小=${fileSize}字节, CRC32=${crc32}`);\n\n    const now = new Date();\n    const timestamp = now.toISOString().replace(/[:\\-]/g, '').replace(/\\.\\d{3}Z$/, 'Z');\n    const randomStr = Math.random().toString(36).substring(2, 12);\n    \n    const applyUrlHost = isUS ? BASE_URL_IMAGEX_US : 'https://imagex.bytedanceapi.com';\n    const applyUrl = `${applyUrlHost}/?Action=ApplyImageUpload&Version=2018-08-01&ServiceId=${actualServiceId}&FileSize=${fileSize}&s=${randomStr}${isUS ? '&device_platform=web' : ''}`;\n\n    const requestHeaders = {\n      'x-amz-date': timestamp,\n      'x-amz-security-token': session_token\n    };\n\n    const authorization = createSignature('GET', applyUrl, requestHeaders, access_key_id, secret_access_key, session_token);\n\n    const origin = isUS ? new URL(BASE_URL_DREAMINA_US).origin : 'https://jimeng.jianying.com';\n\n    const applyResponse = await fetch(applyUrl, {\n      method: 'GET',\n      headers: {\n        'accept': '*/*',\n        'authorization': authorization,\n        'origin': origin,\n        'referer': `${origin}/ai-tool/generate`,\n        'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36',\n        'x-amz-date': timestamp,\n        'x-amz-security-token': session_token,\n      },\n    });\n\n    if (!applyResponse.ok) {\n      const errorText = await applyResponse.text();\n      throw new Error(`申请上传权限失败: ${applyResponse.status} - ${errorText}`);\n    }\n\n    const applyResult = await applyResponse.json();\n\n    if (applyResult?.ResponseMetadata?.Error) {\n      throw new Error(`申请上传权限失败: ${JSON.stringify(applyResult.ResponseMetadata.Error)}`);\n    }\n\n    const uploadAddress = applyResult?.Result?.UploadAddress;\n    if (!uploadAddress || !uploadAddress.StoreInfos || !uploadAddress.UploadHosts) {\n      throw new Error(`获取上传地址失败: ${JSON.stringify(applyResult)}`);\n    }\n\n    const storeInfo = uploadAddress.StoreInfos[0];\n    const uploadHost = uploadAddress.UploadHosts[0];\n    const auth = storeInfo.Auth;\n    const uploadUrl = `https://${uploadHost}/upload/v1/${storeInfo.StoreUri}`;\n\n    const uploadResponse = await fetch(uploadUrl, {\n      method: 'POST',\n      headers: {\n        'Authorization': auth,\n        'Content-CRC32': crc32,\n        'Content-Disposition': 'attachment; filename=\"undefined\"',\n        'Content-Type': 'application/octet-stream',\n        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36',\n      },\n      body: imageBuffer,\n    });\n\n    if (!uploadResponse.ok) {\n      const errorText = await uploadResponse.text();\n      throw new Error(`图片上传失败: ${uploadResponse.status} - ${errorText}`);\n    }\n\n    const commitUrl = `${applyUrlHost}/?Action=CommitImageUpload&Version=2018-08-01&ServiceId=${actualServiceId}`;\n    const commitTimestamp = new Date().toISOString().replace(/[:\\-]/g, '').replace(/\\.\\d{3}Z$/, 'Z');\n    const commitPayload = JSON.stringify({\n      SessionKey: uploadAddress.SessionKey\n    });\n    const payloadHash = crypto.createHash('sha256').update(commitPayload, 'utf8').digest('hex');\n    const commitRequestHeaders = {\n      'x-amz-date': commitTimestamp,\n      'x-amz-security-token': session_token,\n      'x-amz-content-sha256': payloadHash\n    };\n    const commitAuthorization = createSignature('POST', commitUrl, commitRequestHeaders, access_key_id, secret_access_key, session_token, commitPayload);\n\n    const commitResponse = await fetch(commitUrl, {\n      method: 'POST',\n      headers: {\n        'authorization': commitAuthorization,\n        'content-type': 'application/json',\n        'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36',\n        'x-amz-date': commitTimestamp,\n        'x-amz-security-token': session_token,\n        'x-amz-content-sha256': payloadHash,\n      },\n      body: commitPayload,\n    });\n\n    if (!commitResponse.ok) {\n      const errorText = await commitResponse.text();\n      throw new Error(`提交上传失败: ${commitResponse.status} - ${errorText}`);\n    }\n\n    const commitResult = await commitResponse.json();\n    if (commitResult?.ResponseMetadata?.Error) {\n      throw new Error(`提交上传失败: ${JSON.stringify(commitResult.ResponseMetadata.Error)}`);\n    }\n    if (!commitResult?.Result?.Results || commitResult.Result.Results.length === 0) {\n      throw new Error(`提交上传响应缺少结果: ${JSON.stringify(commitResult)}`);\n    }\n    const uploadResult = commitResult.Result.Results[0];\n    if (uploadResult.UriStatus !== 2000) {\n      throw new Error(`图片上传状态异常: UriStatus=${uploadResult.UriStatus}`);\n    }\n    const fullImageUri = uploadResult.Uri;\n    logger.info(`图片Buffer上传完成: ${fullImageUri}`);\n    return fullImageUri;\n  } catch (error) {\n    logger.error(`图片Buffer上传失败: ${error.message}`);\n    throw error;\n  }\n}\n\nexport async function generateImageComposition(\n  _model: string,\n  prompt: string,\n  images: (string | Buffer)[],\n  {\n    ratio = '1:1',\n    resolution = '2k',\n    sampleStrength = 0.5,\n    negativePrompt = \"\",\n  }: {\n    ratio?: string;\n    resolution?: string;\n    sampleStrength?: number;\n    negativePrompt?: string;\n  },\n  refreshToken: string\n) {\n  const isUS = refreshToken.toLowerCase().startsWith('us-');\n  const model = getModel(_model, isUS);\n  \n  let width, height, image_ratio, resolution_type;\n\n  if (_model === 'nanobanana') {\n    logger.warn('nanobanana模型当前固定使用1024x1024分辨率和2k的清晰度，您输入的参数将被忽略。');\n    width = 1024;\n    height = 1024;\n    image_ratio = 1;\n    resolution_type = '2k';\n  } else {\n    const params = getResolutionParams(resolution, ratio);\n    width = params.width;\n    height = params.height;\n    image_ratio = params.image_ratio;\n    resolution_type = params.resolution_type;\n  }\n\n  const imageCount = images.length;\n  logger.info(`使用模型: ${_model} 映射模型: ${model} 图生图功能 ${imageCount}张图片 ${width}x${height} 精细度: ${sampleStrength}`);\n\n  try {\n    const { totalCredit } = await getCredit(refreshToken);\n    if (totalCredit <= 0)\n      await receiveCredit(refreshToken);\n  } catch (e) {\n    logger.warn(`获取积分失败，可能是不支持的区域或token已失效: ${e.message}`);\n  }\n\n  const uploadedImageIds: string[] = [];\n  for (let i = 0; i < images.length; i++) {\n    try {\n      const image = images[i];\n      let imageId: string;\n      if (typeof image === 'string') {\n        logger.info(`正在处理第 ${i + 1}/${imageCount} 张图片 (URL)...`);\n        imageId = await uploadImageFromUrl(image, refreshToken, isUS);\n      } else {\n        logger.info(`正在处理第 ${i + 1}/${imageCount} 张图片 (Buffer)...`);\n        imageId = await uploadImageFromBuffer(image, refreshToken, isUS);\n      }\n      uploadedImageIds.push(imageId);\n      logger.info(`图片 ${i + 1}/${imageCount} 上传成功: ${imageId}`);\n    } catch (error) {\n      logger.error(`图片 ${i + 1}/${imageCount} 上传失败: ${error.message}`);\n      throw new APIException(EX.API_IMAGE_GENERATION_FAILED, `图片上传失败: ${error.message}`);\n    }\n  }\n\n  logger.info(`所有图片上传完成，开始图生图: ${uploadedImageIds.join(', ')}`);\n\n  const componentId = util.uuid();\n  const submitId = util.uuid();\n  \n  const core_param = {\n    type: \"\",\n    id: util.uuid(),\n    model,\n    prompt: `##${prompt}`,\n    sample_strength: sampleStrength,\n    image_ratio: image_ratio,\n    large_image_info: {\n      type: \"\",\n      id: util.uuid(),\n      height: height,\n      width: width,\n      resolution_type: resolution_type\n    },\n    intelligent_ratio: false,\n  };\n\n  const { aigc_data } = await request(\n    \"post\",\n    \"/mweb/v1/aigc_draft/generate\",\n    refreshToken,\n    {\n      params: {\n      },\n      data: {\n        extend: {\n          root_model: model,\n        },\n        submit_id: submitId,\n        metrics_extra: JSON.stringify({\n          promptSource: \"custom\",\n          generateCount: 1,\n          enterFrom: \"click\",\n          generateId: submitId,\n          isRegenerate: false\n        }),\n        draft_content: JSON.stringify({\n          type: \"draft\",\n          id: util.uuid(),\n          min_version: DRAFT_MIN_VERSION,\n          min_features: [],\n          is_from_tsn: true,\n          version: DRAFT_VERSION,\n          main_component_id: componentId,\n          component_list: [\n            {\n              type: \"image_base_component\",\n              id: componentId,\n              min_version: DRAFT_MIN_VERSION,\n              aigc_mode: \"workbench\",\n              metadata: {\n                type: \"\",\n                id: util.uuid(),\n                created_platform: 3,\n                created_platform_version: \"\",\n                created_time_in_ms: Date.now().toString(),\n                created_did: \"\",\n              },\n              generate_type: \"blend\",\n              abilities: {\n                type: \"\",\n                id: util.uuid(),\n                blend: {\n                  type: \"\",\n                  id: util.uuid(),\n                  min_features: [],\n                  core_param: core_param,\n                  ability_list: uploadedImageIds.map((imageId) => ({\n                    type: \"\",\n                    id: util.uuid(),\n                    name: \"byte_edit\",\n                    image_uri_list: [imageId],\n                    image_list: [{\n                      type: \"image\",\n                      id: util.uuid(),\n                      source_from: \"upload\",\n                      platform_type: 1,\n                      name: \"\",\n                      image_uri: imageId,\n                      width: 0,\n                      height: 0,\n                      format: \"\",\n                      uri: imageId\n                    }],\n                    strength: 0.5\n                  })),\n                  prompt_placeholder_info_list: uploadedImageIds.map((_, index) => ({\n                    type: \"\",\n                    id: util.uuid(),\n                    ability_index: index\n                  })),\n                  postedit_param: {\n                    type: \"\",\n                    id: util.uuid(),\n                    generate_type: 0\n                  }\n                },\n              },\n            },\n          ],\n        }),\n        http_common_info: {\n          aid: isUS ? DEFAULT_ASSISTANT_ID_US : DEFAULT_ASSISTANT_ID_CN\n        }\n      },\n    }\n  );\n\n  const historyId = aigc_data?.history_record_id;\n  if (!historyId)\n    throw new APIException(EX.API_IMAGE_GENERATION_FAILED, \"记录ID不存在\");\n\n  logger.info(`图生图任务已提交，historyId: ${historyId}。请通过historyId接口获取生成结果。`);\n  \n  // 直接返回historyId和空的imageUrls数组，由前端通过history_id接口获取实际图片\n  return { imageUrls: [], historyId };\n}\n\n// ... (rest of the file is for text-to-image, can be left as is for now)\nexport async function generateImages(\n  _model: string,\n  prompt: string,\n  {\n    ratio = '1:1',\n    resolution = '2k',\n    sampleStrength = 0.5,\n    negativePrompt = \"\",\n  }: {\n    ratio?: string;\n    resolution?: string;\n    sampleStrength?: number;\n    negativePrompt?: string;\n  },\n  refreshToken: string\n) {\n  const isUS = refreshToken.toLowerCase().startsWith('us-');\n  const model = getModel(_model, isUS);\n  logger.info(`使用模型: ${_model} 映射模型: ${model} 分辨率: ${resolution} 比例: ${ratio} 精细度: ${sampleStrength}`);\n\n  const result = await generateImagesInternal(_model, prompt, { ratio, resolution, sampleStrength, negativePrompt }, refreshToken);\n  return result;\n}\n\nasync function generateImagesInternal(\n  _model: string,\n  prompt: string,\n  {\n    ratio,\n    resolution,\n    sampleStrength = 0.5,\n    negativePrompt = \"\",\n  }: {\n    ratio: string;\n    resolution: string;\n    sampleStrength?: number;\n    negativePrompt?: string;\n  },\n  refreshToken: string\n) {\n  const isUS = refreshToken.toLowerCase().startsWith('us-');\n  const model = getModel(_model, isUS);\n  \n  let width, height, image_ratio, resolution_type;\n\n  if (_model === 'nanobanana') {\n    logger.warn('nanobanana模型当前固定使用1024x1024分辨率和2k的清晰度，您输入的参数将被忽略。');\n    width = 1024;\n    height = 1024;\n    image_ratio = 1;\n    resolution_type = '2k';\n  } else {\n    const params = getResolutionParams(resolution, ratio);\n    width = params.width;\n    height = params.height;\n    image_ratio = params.image_ratio;\n    resolution_type = params.resolution_type;\n  }\n\n  const { totalCredit, giftCredit, purchaseCredit, vipCredit } = await getCredit(refreshToken);\n  if (totalCredit <= 0)\n    await receiveCredit(refreshToken);\n\n  logger.info(`当前积分状态: 总计=${totalCredit}, 赠送=${giftCredit}, 购买=${purchaseCredit}, VIP=${vipCredit}`);\n\n  const isJimeng40MultiImage = _model === \"jimeng-4.0\" && (\n    prompt.includes(\"连续\") ||\n    prompt.includes(\"绘本\") ||\n    prompt.includes(\"故事\") ||\n    /\\d+张/.test(prompt)\n  );\n\n  if (isJimeng40MultiImage) {\n    return await generateJimeng40MultiImages(_model, prompt, { ratio, resolution, sampleStrength, negativePrompt }, refreshToken);\n  }\n\n  const componentId = util.uuid();\n  \n  const core_param = {\n    type: \"\",\n    id: util.uuid(),\n    model,\n    prompt,\n    negative_prompt: negativePrompt,\n    seed: Math.floor(Math.random() * 100000000) + 2500000000,\n    sample_strength: sampleStrength,\n    image_ratio: image_ratio,\n    large_image_info: {\n      type: \"\",\n      id: util.uuid(),\n      height: height,\n      width: width,\n      resolution_type: resolution_type\n    },\n    intelligent_ratio: false\n  };\n\n  const { aigc_data } = await request(\n    \"post\",\n    \"/mweb/v1/aigc_draft/generate\",\n    refreshToken,\n    {\n      params: {\n      },\n      data: {\n        extend: {\n          root_model: model,\n        },\n        submit_id: util.uuid(),\n        metrics_extra: JSON.stringify({\n          promptSource: \"custom\",\n          generateCount: 1,\n          enterFrom: \"click\",\n          generateId: util.uuid(),\n          isRegenerate: false\n        }),\n        draft_content: JSON.stringify({\n          type: \"draft\",\n          id: util.uuid(),\n          min_version: DRAFT_MIN_VERSION,\n          min_features: [],\n          is_from_tsn: true,\n          version: DRAFT_VERSION,\n          main_component_id: componentId,\n          component_list: [\n            {\n              type: \"image_base_component\",\n              id: componentId,\n              min_version: DRAFT_MIN_VERSION,\n              aigc_mode: \"workbench\",\n              metadata: {\n                type: \"\",\n                id: util.uuid(),\n                created_platform: 3,\n                created_platform_version: \"\",\n                created_time_in_ms: Date.now().toString(),\n                created_did: \"\"\n              },\n              generate_type: \"generate\",\n              abilities: {\n                type: \"\",\n                id: util.uuid(),\n                generate: {\n                  type: \"\",\n                  id: util.uuid(),\n                  core_param: core_param,\n                },\n              },\n            },\n          ],\n        }),\n        http_common_info: {\n          aid: isUS ? DEFAULT_ASSISTANT_ID_US : DEFAULT_ASSISTANT_ID_CN\n        }\n      },\n    }\n  );\n  const historyId = aigc_data.history_record_id;\n  if (!historyId)\n    throw new APIException(EX.API_IMAGE_GENERATION_FAILED, \"记录ID不存在\");\n\n  logger.info(`图片生成任务已提交，historyId: ${historyId}。请通过historyId接口获取生成结果。`);\n  \n  // 直接返回historyId和空的imageUrls数组，由前端通过history_id接口获取实际图片\n  return { imageUrls: [], historyId };\n}\n\nasync function generateJimeng40MultiImages(\n  _model: string,\n  prompt: string,\n  {\n    ratio = '1:1',\n    resolution = '2k',\n    sampleStrength = 0.5,\n    negativePrompt = \"\",\n  }: {\n    ratio?: string;\n    resolution?: string;\n    sampleStrength?: number;\n    negativePrompt?: string;\n  },\n  refreshToken: string\n) {\n  const isUS = refreshToken.toLowerCase().startsWith('us-');\n  const model = getModel(_model, isUS);\n  const { width, height, image_ratio, resolution_type } = getResolutionParams(resolution, ratio);\n\n  const targetImageCount = prompt.match(/(\\d+)张/) ? parseInt(prompt.match(/(\\d+)张/)[1]) : 4;\n\n  logger.info(`使用 多图生成: ${targetImageCount}张图片 ${width}x${height} 精细度: ${sampleStrength}`);\n\n  const componentId = util.uuid();\n  const submitId = util.uuid();\n\n  const { aigc_data } = await request(\n    \"post\",\n    \"/mweb/v1/aigc_draft/generate\",\n    refreshToken,\n    {\n      params: {\n      },\n      data: {\n        extend: {\n          root_model: model,\n        },\n        submit_id: submitId,\n        metrics_extra: JSON.stringify({\n          templateId: \"\",\n          generateCount: 1,\n          promptSource: \"custom\",\n          templateSource: \"\",\n          lastRequestId: \"\",\n          originRequestId: \"\",\n        }),\n        draft_content: JSON.stringify({\n          type: \"draft\",\n          id: util.uuid(),\n          min_version: DRAFT_MIN_VERSION,\n          min_features: [],\n          is_from_tsn: true,\n          version: DRAFT_VERSION,\n          main_component_id: componentId,\n          component_list: [\n            {\n              type: \"image_base_component\",\n              id: componentId,\n              min_version: DRAFT_MIN_VERSION,\n              aigc_mode: \"workbench\",\n              metadata: {\n                type: \"\",\n                id: util.uuid(),\n                created_platform: 3,\n                created_platform_version: \"\",\n                created_time_in_ms: Date.now().toString(),\n                created_did: \"\"\n              },\n              generate_type: \"generate\",\n              abilities: {\n                type: \"\",\n                id: util.uuid(),\n                generate: {\n                  type: \"\",\n                  id: util.uuid(),\n                  core_param: {\n                    type: \"\",\n                    id: util.uuid(),\n                    model,\n                    prompt,\n                    negative_prompt: negativePrompt,\n                    seed: Math.floor(Math.random() * 100000000) + 2500000000,\n                    sample_strength: sampleStrength,\n                    image_ratio: image_ratio,\n                    large_image_info: {\n                      type: \"\",\n                      id: util.uuid(),\n                      height: height,\n                      width: width,\n                      resolution_type: resolution_type\n                    },\n                    intelligent_ratio: false\n                  },\n                },\n              },\n            },\n          ],\n        }),\n        http_common_info: {\n          aid: isUS ? DEFAULT_ASSISTANT_ID_US : DEFAULT_ASSISTANT_ID_CN\n        }\n      },\n    }\n  );\n\n  const historyId = aigc_data?.history_record_id;\n  if (!historyId)\n    throw new APIException(EX.API_IMAGE_GENERATION_FAILED, \"记录ID不存在\");\n\n  logger.info(`多图生成任务已提交，historyId: ${historyId}。请通过historyId接口获取生成结果。`);\n  \n  // 直接返回historyId和空的imageUrls数组，由前端通过history_id接口获取实际图片\n  return { imageUrls: [], historyId };\n}\n\nexport default {\n  generateImages,\n  generateImageComposition,\n  getImageByHistoryId,\n  getAssetList,\n};","import path from \"path\";\nimport _ from \"lodash\";\nimport mime from \"mime\";\nimport axios, { AxiosRequestConfig, AxiosResponse } from \"axios\";\n\nimport APIException from \"@/lib/exceptions/APIException.ts\";\nimport EX from \"@/api/consts/exceptions.ts\";\nimport logger from \"@/lib/logger.ts\";\nimport util from \"@/lib/util.ts\";\nimport { JimengErrorHandler, JimengErrorResponse } from \"@/lib/error-handler.ts\";\nimport { BASE_URL_DREAMINA_US, BASE_URL_DREAMINA_HK } from \"@/api/consts/dreamina.ts\";\nimport {\n  BASE_URL_CN,\n  BASE_URL_US_COMMERCE,\n  BASE_URL_HK_COMMERCE,\n  BASE_URL_HK,\n  DEFAULT_ASSISTANT_ID_CN,\n  DEFAULT_ASSISTANT_ID_US,\n  DEFAULT_ASSISTANT_ID_HK,\n  DEFAULT_ASSISTANT_ID_JP,\n  DEFAULT_ASSISTANT_ID_SG,\n  PLATFORM_CODE,\n  REGION_CN,\n  REGION_US,\n  REGION_HK,\n  REGION_JP,\n  REGION_SG,\n  VERSION_CODE,\n  RETRY_CONFIG\n} from \"@/api/consts/common.ts\";\n\n// 模型名称\nconst MODEL_NAME = \"jimeng\";\n// 设备ID\nconst DEVICE_ID = Math.random() * 999999999999999999 + 7000000000000000000;\n// WebID\nconst WEB_ID = Math.random() * 999999999999999999 + 7000000000000000000;\n// 用户ID\nconst USER_ID = util.uuid(false);\n// 伪装headers\nconst FAKE_HEADERS = {\n  Accept: \"application/json, text/plain, */*\",\n  \"Accept-Encoding\": \"gzip, deflate, br, zstd\",\n  \"Accept-language\": \"zh-CN,zh;q=0.9\",\n  \"Cache-control\": \"no-cache\",\n  Appvr: VERSION_CODE,\n  Pragma: \"no-cache\",\n  Priority: \"u=1, i\",\n  Pf: PLATFORM_CODE,\n  \"Sec-Ch-Ua\": '\"Google Chrome\";v=\"142\", \"Chromium\";v=\"142\", \"Not_A Brand\";v=\"99\"',\n  \"Sec-Ch-Ua-Mobile\": \"?0\",\n  \"Sec-Ch-Ua-Platform\": '\"Windows\"',\n  \"Sec-Fetch-Dest\": \"empty\",\n  \"Sec-Fetch-Mode\": \"cors\",\n  \"Sec-Fetch-Site\": \"same-origin\",\n  \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36\",\n};\n// 文件最大大小\nconst FILE_MAX_SIZE = 100 * 1024 * 1024;\n\n/**\n * 获取缓存中的access_token\n *\n * 目前jimeng的access_token是固定的，暂无刷新功能\n *\n * @param refreshToken 用于刷新access_token的refresh_token\n */\nexport async function acquireToken(refreshToken: string): Promise<string> {\n  return refreshToken;\n}\n\n/**\n * 解析 token 中的地区信息\n *\n * @param refreshToken 刷新令牌\n * @returns 地区信息对象\n */\nexport interface RegionInfo {\n  isUS: boolean;\n  isHK: boolean;\n  isJP: boolean;\n  isSG: boolean;\n  isInternational: boolean;\n  isCN: boolean;\n}\n\nexport function parseRegionFromToken(refreshToken: string): RegionInfo {\n  const token = refreshToken.toLowerCase();\n  const isUS = token.startsWith('us-');\n  const isHK = token.startsWith('hk-');\n  const isJP = token.startsWith('jp-');\n  const isSG = token.startsWith('sg-');\n  const isInternational = isUS || isHK || isJP || isSG;\n\n  return {\n    isUS,\n    isHK,\n    isJP,\n    isSG,\n    isInternational,\n    isCN: !isInternational\n  };\n}\n\n/**\n * 根据地区获取 Referer\n *\n * @param refreshToken 刷新令牌\n * @param cnPath 国内站路径\n * @returns Referer URL\n */\nexport function getRefererByRegion(refreshToken: string, cnPath: string): string {\n  const { isInternational } = parseRegionFromToken(refreshToken);\n  return isInternational\n    ? \"https://dreamina.capcut.com/\"\n    : `https://jimeng.jianying.com${cnPath}`;\n}\n\n/**\n * 根据地区获取 AssistantID\n *\n * @param regionInfo 地区信息\n * @returns AssistantID\n */\nexport function getAssistantId(regionInfo: RegionInfo): number {\n  if (regionInfo.isUS) return DEFAULT_ASSISTANT_ID_US;\n  if (regionInfo.isJP) return DEFAULT_ASSISTANT_ID_JP;\n  if (regionInfo.isSG) return DEFAULT_ASSISTANT_ID_SG;\n  if (regionInfo.isHK) return DEFAULT_ASSISTANT_ID_HK;\n  return DEFAULT_ASSISTANT_ID_CN;\n}\n\n/**\n * 生成cookie\n */\nexport function generateCookie(refreshToken: string) {\n  const { isUS, isHK, isJP, isSG } = parseRegionFromToken(refreshToken);\n  const token = (isUS || isHK || isJP || isSG) ? refreshToken.substring(3) : refreshToken;\n\n  let storeRegion = 'cn-gd';\n  if (isUS) storeRegion = 'us';\n  else if (isHK) storeRegion = 'hk';\n  else if (isJP) storeRegion = 'hk'; // JP uses HK store region\n  else if (isSG) storeRegion = 'hk'; // SG uses HK store region\n\n  return [\n    `_tea_web_id=${WEB_ID}`,\n    `is_staff_user=false`,\n    `store-region=${storeRegion}`,\n    `store-region-src=uid`,\n    `sid_guard=${token}%7C${util.unixTimestamp()}%7C5184000%7CMon%2C+03-Feb-2025+08%3A17%3A09+GMT`,\n    `uid_tt=${USER_ID}`,\n    `uid_tt_ss=${USER_ID}`,\n    `sid_tt=${token}`,\n    `sessionid=${token}`,\n    `sessionid_ss=${token}`,\n    `sid_tt=${token}`\n  ].join(\"; \");\n}\n\n/**\n * 获取积分信息\n *\n * @param refreshToken 用于刷新access_token的refresh_token\n */\nexport async function getCredit(refreshToken: string) {\n  const referer = getRefererByRegion(refreshToken, \"/ai-tool/image/generate\");\n\n  const {\n    credit: { gift_credit, purchase_credit, vip_credit }\n  } = await request(\"POST\", \"/commerce/v1/benefits/user_credit\", refreshToken, {\n    data: {},\n    headers: {\n      Referer: referer,\n    },\n    noDefaultParams: true\n  });\n  logger.info(`\\n积分信息: \\n赠送积分: ${gift_credit}, 购买积分: ${purchase_credit}, VIP积分: ${vip_credit}`);\n  return {\n    giftCredit: gift_credit,\n    purchaseCredit: purchase_credit,\n    vipCredit: vip_credit,\n    totalCredit: gift_credit + purchase_credit + vip_credit\n  }\n}\n\n/**\n * 接收今日积分\n *\n * @param refreshToken 用于刷新access_token的refresh_token\n */\nexport async function receiveCredit(refreshToken: string) {\n  logger.info(\"正在收取今日积分...\")\n  const referer = getRefererByRegion(refreshToken, \"/ai-tool/home\");\n\n  const { cur_total_credits, receive_quota  } = await request(\"POST\", \"/commerce/v1/benefits/credit_receive\", refreshToken, {\n    data: {\n      time_zone: \"Asia/Shanghai\"\n    },\n    headers: {\n      Referer: referer\n    }\n  });\n  logger.info(`\\n今日${receive_quota}积分收取成功\\n剩余积分: ${cur_total_credits}`);\n  return cur_total_credits;\n}\n\n/**\n * 请求jimeng\n *\n * @param method 请求方法\n * @param uri 请求路径\n * @param params 请求参数\n * @param headers 请求头\n */\nexport async function request(\n  method: string,\n  uri: string,\n  refreshToken: string,\n  options: AxiosRequestConfig & { noDefaultParams?: boolean } = {}\n) {\n  const regionInfo = parseRegionFromToken(refreshToken);\n  const { isUS, isHK, isJP, isSG } = regionInfo;\n  const token = await acquireToken(regionInfo.isInternational ? refreshToken.substring(3) : refreshToken);\n  const deviceTime = util.unixTimestamp();\n  const sign = util.md5(\n    `9e2c|${uri.slice(-7)}|${PLATFORM_CODE}|${VERSION_CODE}|${deviceTime}||11ac`\n  );\n\n  let baseUrl: string;\n  let aid: number;\n  let region: string;\n\n  if (isUS) {\n    if (uri.startsWith(\"/commerce/\")) {\n      baseUrl = BASE_URL_US_COMMERCE;\n    } else {\n      baseUrl = BASE_URL_DREAMINA_US;\n    }\n    aid = DEFAULT_ASSISTANT_ID_US;\n    region = REGION_US;\n  } else if (isHK || isJP || isSG) {\n    // HK, JP and SG regions use the same SG base URL\n    if (uri.startsWith(\"/commerce/\")) {\n      baseUrl = BASE_URL_HK_COMMERCE;\n    } else {\n      baseUrl = BASE_URL_DREAMINA_HK;\n    }\n    if (isJP) {\n      aid = DEFAULT_ASSISTANT_ID_JP;\n      region = REGION_JP;\n    } else if (isSG) {\n      aid = DEFAULT_ASSISTANT_ID_SG;\n      region = REGION_SG;\n    } else {\n      aid = DEFAULT_ASSISTANT_ID_HK;\n      region = REGION_HK;\n    }\n  } else {\n    // CN region\n    baseUrl = BASE_URL_CN;\n    aid = DEFAULT_ASSISTANT_ID_CN;\n    region = REGION_CN;\n  }\n\n  const origin = new URL(baseUrl).origin;\n\n  const fullUrl = `${baseUrl}${uri}`;\n  const requestParams = options.noDefaultParams ? (options.params || {}) : {\n    aid: aid,\n    device_platform: \"web\",\n    region: region,\n    ...(isUS || isHK || isJP || isSG ? {} : { webId: WEB_ID }),\n    da_version: \"3.3.2\",\n    web_component_open_flag: 1,\n    web_version: \"7.5.0\",\n    aigc_features: \"app_lip_sync\",\n    ...(options.params || {}),\n  };\n\n  const headers = {\n    ...FAKE_HEADERS,\n    Origin: origin,\n    Referer: origin,\n    Appid: aid,\n    Cookie: generateCookie(refreshToken),\n    \"Device-Time\": deviceTime,\n    Sign: sign,\n    \"Sign-Ver\": \"1\",\n    ...(options.headers || {}),\n  };\n\n  logger.info(`发送请求: ${method.toUpperCase()} ${fullUrl}`);\n  logger.info(`请求参数: ${JSON.stringify(requestParams)}`);\n  logger.info(`请求数据: ${JSON.stringify(options.data || {})}`);\n\n  // 添加重试逻辑\n  let retries = 0;\n  const maxRetries = RETRY_CONFIG.MAX_RETRY_COUNT;\n  let lastError = null;\n\n  while (retries <= maxRetries) {\n    try {\n      if (retries > 0) {\n        logger.info(`第 ${retries} 次重试请求: ${method.toUpperCase()} ${fullUrl}`);\n        // 重试前等待一段时间\n        await new Promise(resolve => setTimeout(resolve, RETRY_CONFIG.RETRY_DELAY));\n      }\n\n      const response = await axios.request({\n        method,\n        url: fullUrl,\n        params: requestParams,\n        headers: headers,\n        timeout: 45000, // 增加超时时间到45秒\n        validateStatus: () => true, // 允许任何状态码\n        ..._.omit(options, \"params\", \"headers\"),\n      });\n\n      // 记录响应状态和头信息\n      logger.info(`响应状态: ${response.status} ${response.statusText}`);\n\n      // 流式响应直接返回response\n      if (options.responseType == \"stream\") return response;\n\n      // 记录响应数据摘要\n      const responseDataSummary = JSON.stringify(response.data).substring(0, 500) +\n        (JSON.stringify(response.data).length > 500 ? \"...\" : \"\");\n      //const responseDataSummary = JSON.stringify(response.data)\n      logger.info(`响应数据摘要: ${responseDataSummary}`);\n\n      // 检查HTTP状态码\n      if (response.status >= 400) {\n        logger.warn(`HTTP错误: ${response.status} ${response.statusText}`);\n        if (retries < maxRetries) {\n          retries++;\n          continue;\n        }\n      }\n\n      return checkResult(response);\n    }\n    catch (error) {\n      lastError = error;\n      logger.error(`请求失败 (尝试 ${retries + 1}/${maxRetries + 1}): ${error.message}`);\n\n      // 如果是网络错误或超时，尝试重试\n      if ((error.code === 'ECONNABORTED' || error.code === 'ETIMEDOUT' ||\n           error.message.includes('timeout') || error.message.includes('network')) &&\n          retries < maxRetries) {\n        retries++;\n        continue;\n      }\n\n      // 其他错误直接抛出\n      break;\n    }\n  }\n\n  // 所有重试都失败了，抛出最后一个错误\n  if (lastError) {\n    logger.error(`请求失败，已重试 ${retries} 次: ${lastError.message}`);\n    if (lastError.response) {\n      logger.error(`响应状态: ${lastError.response.status}`);\n      logger.error(`响应数据: ${JSON.stringify(lastError.response.data)}`);\n    }\n    throw lastError;\n  } else {\n    // 这种情况理论上不应该发生，但为了安全起见\n    const error = new Error(`请求失败，已重试 ${retries} 次，但没有具体错误信息`);\n    logger.error(error.message);\n    throw error;\n  }\n }\n\n /**\n  * 预检查文件URL有效性\n  *\n  * @param fileUrl 文件URL\n  */\n export async function checkFileUrl(fileUrl: string) {\n  if (util.isBASE64Data(fileUrl)) return;\n  const result = await axios.head(fileUrl, {\n    timeout: 15000,\n    validateStatus: () => true,\n  });\n  if (result.status >= 400)\n    throw new APIException(\n      EX.API_FILE_URL_INVALID,\n      `File ${fileUrl} is not valid: [${result.status}] ${result.statusText}`\n    );\n  // 检查文件大小\n  if (result.headers && result.headers[\"content-length\"]) {\n    const fileSize = parseInt(result.headers[\"content-length\"], 10);\n    if (fileSize > FILE_MAX_SIZE)\n      throw new APIException(\n        EX.API_FILE_EXECEEDS_SIZE,\n        `File ${fileUrl} is not valid`\n      );\n  }\n}\n\n/**\n * 上传文件\n *\n * @param refreshToken 用于刷新access_token的refresh_token\n * @param fileUrl 文件URL或BASE64数据\n * @param isVideoImage 是否是用于视频图像\n * @returns 上传结果，包含image_uri\n */\nexport async function uploadFile(\n  refreshToken: string,\n  fileUrl: string,\n  isVideoImage: boolean = false\n) {\n  try {\n    logger.info(`开始上传文件: ${fileUrl}, 视频图像模式: ${isVideoImage}`);\n\n    // 预检查远程文件URL可用性\n    await checkFileUrl(fileUrl);\n\n    let filename, fileData, mimeType;\n    // 如果是BASE64数据则直接转换为Buffer\n    if (util.isBASE64Data(fileUrl)) {\n      mimeType = util.extractBASE64DataFormat(fileUrl);\n      const ext = mime.getExtension(mimeType);\n      filename = `${util.uuid()}.${ext}`;\n      fileData = Buffer.from(util.removeBASE64DataHeader(fileUrl), \"base64\");\n      logger.info(`处理BASE64数据，文件名: ${filename}, 类型: ${mimeType}, 大小: ${fileData.length}字节`);\n    }\n    // 下载文件到内存，如果您的服务器内存很小，建议考虑改造为流直传到下一个接口上，避免停留占用内存\n    else {\n      filename = path.basename(fileUrl);\n      logger.info(`开始下载远程文件: ${fileUrl}`);\n      ({ data: fileData } = await axios.get(fileUrl, {\n        responseType: \"arraybuffer\",\n        // 100M限制\n        maxContentLength: FILE_MAX_SIZE,\n        // 60秒超时\n        timeout: 60000,\n      }));\n      logger.info(`文件下载完成，文件名: ${filename}, 大小: ${fileData.length}字节`);\n    }\n\n    // 获取文件的MIME类型\n    mimeType = mimeType || mime.getType(filename);\n    logger.info(`文件MIME类型: ${mimeType}`);\n\n    // 构建FormData\n    const formData = new FormData();\n    const blob = new Blob([fileData], { type: mimeType });\n    formData.append('file', blob, filename);\n\n    // 获取上传凭证\n    logger.info(`请求上传凭证，场景: ${isVideoImage ? 'video_cover' : 'aigc_image'}`);\n    const uploadProofUrl = 'https://imagex.bytedanceapi.com/';\n    const proofResult = await request(\n      'POST',\n      '/mweb/v1/get_upload_image_proof',\n      refreshToken,\n      {\n        data: {\n          scene: isVideoImage ? 'video_cover' : 'aigc_image',\n          file_name: filename,\n          file_size: fileData.length,\n        }\n      }\n    );\n\n    if (!proofResult || !proofResult.proof_info) {\n      logger.error(`获取上传凭证失败: ${JSON.stringify(proofResult)}`);\n      throw new APIException(EX.API_REQUEST_FAILED, '获取上传凭证失败');\n    }\n\n    logger.info(`获取上传凭证成功`);\n\n    // 上传文件\n    const { proof_info } = proofResult;\n    logger.info(`开始上传文件到: ${uploadProofUrl}`);\n\n    const uploadResult = await axios.post(\n      uploadProofUrl,\n      formData,\n      {\n        headers: {\n          ...proof_info.headers,\n          'Content-Type': 'multipart/form-data',\n        },\n        params: proof_info.query_params,\n        timeout: 60000,\n        validateStatus: () => true, // 允许任何状态码以便详细处理\n      }\n    );\n\n    logger.info(`上传响应状态: ${uploadResult.status}`);\n\n    if (!uploadResult || uploadResult.status !== 200) {\n      logger.error(`上传文件失败: 状态码 ${uploadResult?.status}, 响应: ${JSON.stringify(uploadResult?.data)}`);\n      throw new APIException(EX.API_REQUEST_FAILED, `上传文件失败: 状态码 ${uploadResult?.status}`);\n    }\n\n    // 验证 proof_info.image_uri 是否存在\n    if (!proof_info.image_uri) {\n      logger.error(`上传凭证中缺少 image_uri: ${JSON.stringify(proof_info)}`);\n      throw new APIException(EX.API_REQUEST_FAILED, '上传凭证中缺少 image_uri');\n    }\n\n    logger.info(`文件上传成功: ${proof_info.image_uri}`);\n\n    // 返回上传结果\n    return {\n      image_uri: proof_info.image_uri,\n      uri: proof_info.image_uri,\n    }\n  } catch (error) {\n    logger.error(`文件上传过程中发生错误: ${error.message}`);\n    throw error;\n  }\n}\n\n/**\n * 检查请求结果\n *\n * @param result 结果\n */\nexport function checkResult(result: AxiosResponse) {\n  const { ret, errmsg, data } = result.data;\n  if (!_.isFinite(Number(ret))) return result.data;\n  if (ret === '0') return data;\n\n  // 使用统一错误处理器\n  JimengErrorHandler.handleApiResponse(result.data as JimengErrorResponse, {\n    context: '即梦API请求',\n    operation: '请求'\n  });\n}\n\n/**\n * Token切分\n *\n * @param authorization 认证字符串\n */\nexport function tokenSplit(authorization: string) {\n  return authorization.replace(\"Bearer \", \"\").split(\",\");\n}\n\n/**\n * 获取Token存活状态\n */\nexport async function getTokenLiveStatus(refreshToken: string) {\n  const result = await request(\n    \"POST\",\n    \"/passport/account/info/v2\",\n    refreshToken,\n    {\n      params: {\n        account_sdk_source: \"web\",\n      },\n    }\n  );\n  try {\n    const { user_id } = checkResult(result);\n    return !!user_id;\n  } catch (err) {\n    return false;\n  }\n}","import APIException from \"@/lib/exceptions/APIException.ts\";\nimport EX from \"@/api/consts/exceptions.ts\";\nimport logger from \"@/lib/logger.ts\";\n\n/**\n * 即梦API错误响应接口\n */\nexport interface JimengErrorResponse {\n  ret: string;\n  errmsg: string;\n  data?: any;\n  historyId?: string;\n}\n\n/**\n * 错误处理选项\n */\nexport interface ErrorHandlerOptions {\n  context?: string;\n  historyId?: string;\n  retryCount?: number;\n  maxRetries?: number;\n  operation?: string;\n}\n\n/**\n * 统一的即梦API错误处理器\n */\nexport class JimengErrorHandler {\n  \n  /**\n   * 处理即梦API响应错误\n   */\n  static handleApiResponse(\n    response: JimengErrorResponse, \n    options: ErrorHandlerOptions = {}\n  ): never {\n    const { ret, errmsg, historyId } = response;\n    const { context = '即梦API请求', operation = '操作' } = options;\n    \n    logger.error(`${context}失败: ret=${ret}, errmsg=${errmsg}${historyId ? `, historyId=${historyId}` : ''}`);\n    \n    // 根据错误码分类处理\n    switch (ret) {\n      case '1015':\n        throw new APIException(EX.API_TOKEN_EXPIRES, `[登录失效]: ${errmsg}。请重新获取refresh_token并更新配置`);\n      \n      case '5000':\n        throw new APIException(EX.API_IMAGE_GENERATION_INSUFFICIENT_POINTS, \n          `[积分不足]: ${errmsg}。建议：1)尝试使用1024x1024分辨率，2)检查是否需要购买积分，3)确认账户状态正常`);\n      \n      case '4001':\n        throw new APIException(EX.API_CONTENT_FILTERED, `[内容违规]: ${errmsg}`);\n      \n      case '4002':\n        throw new APIException(EX.API_REQUEST_PARAMS_INVALID, `[参数错误]: ${errmsg}`);\n      \n      case '5001':\n        throw new APIException(EX.API_IMAGE_GENERATION_FAILED, `[生成失败]: ${errmsg}`);\n      \n      case '5002':\n        throw new APIException(EX.API_VIDEO_GENERATION_FAILED, `[视频生成失败]: ${errmsg}`);\n      \n      default:\n        throw new APIException(EX.API_REQUEST_FAILED, `[${operation}失败]: ${errmsg} (错误码: ${ret})`);\n    }\n  }\n  \n  /**\n   * 处理网络请求错误\n   */\n  static handleNetworkError(\n    error: any, \n    options: ErrorHandlerOptions = {}\n  ): never {\n    const { context = '网络请求', retryCount = 0, maxRetries = 3 } = options;\n    \n    logger.error(`${context}网络错误 (尝试 ${retryCount + 1}/${maxRetries + 1}): ${error.message}`);\n    \n    if (error.code === 'ECONNABORTED') {\n      throw new APIException(EX.API_REQUEST_FAILED, `[请求超时]: ${context}超时，请稍后重试`);\n    }\n    \n    if (error.code === 'ENOTFOUND') {\n      throw new APIException(EX.API_REQUEST_FAILED, `[网络错误]: 无法连接到即梦服务器，请检查网络连接`);\n    }\n    \n    if (error.response?.status >= 500) {\n      throw new APIException(EX.API_REQUEST_FAILED, `[服务器错误]: 即梦服务器暂时不可用 (${error.response.status})`);\n    }\n    \n    if (error.response?.status === 429) {\n      throw new APIException(EX.API_REQUEST_FAILED, `[请求频率限制]: 请求过于频繁，请稍后重试`);\n    }\n    \n    throw new APIException(EX.API_REQUEST_FAILED, `[${context}失败]: ${error.message}`);\n  }\n\n  /**\n   * 处理轮询超时错误\n   * @returns 如果有部分结果，返回 void 而不抛出异常\n   */\n  static handlePollingTimeout(\n    pollCount: number,\n    maxPollCount: number,\n    elapsedTime: number,\n    status: number,\n    itemCount: number,\n    historyId?: string\n  ): void {\n    const message = `轮询超时: 已轮询 ${pollCount} 次，耗时 ${elapsedTime} 秒，最终状态: ${status}，图片数量: ${itemCount}`;\n    logger.warn(message + (historyId ? `，历史ID: ${historyId}` : ''));\n\n    if (itemCount === 0) {\n      throw new APIException(EX.API_IMAGE_GENERATION_FAILED,\n        `生成超时且无结果，状态码: ${status}${historyId ? `，历史ID: ${historyId}` : ''}`);\n    }\n\n    // 如果有部分结果，不抛出异常，让调用者处理\n    logger.info(`轮询超时但已获得 ${itemCount} 张图片，将返回现有结果`);\n  }\n  \n  /**\n   * 处理生成失败错误\n   * @param itemCount 已生成的结果数量，如果 > 0 则不抛出异常\n   * @returns 如果有部分结果，返回 false 表示不应抛出异常\n   */\n  static handleGenerationFailure(\n    status: number,\n    failCode: string | undefined,\n    historyId?: string,\n    type: 'image' | 'video' = 'image',\n    itemCount: number = 0\n  ): boolean {\n    const typeText = type === 'image' ? '图像' : '视频';\n    const message = `${typeText}生成最终失败: status=${status}, failCode=${failCode}${historyId ? `, historyId=${historyId}` : ''}, 已生成数量=${itemCount}`;\n\n    // 如果有部分结果，只记录警告，不抛出异常\n    if (itemCount > 0) {\n      logger.warn(message);\n      logger.info(`${typeText}生成部分失败，但已获得 ${itemCount} 个结果，将返回现有结果`);\n      return false; // 不抛出异常\n    }\n\n    // 没有任何结果时，记录错误并抛出异常\n    logger.error(message);\n    const exception = type === 'image' ? EX.API_IMAGE_GENERATION_FAILED : EX.API_VIDEO_GENERATION_FAILED;\n    throw new APIException(exception, `${typeText}生成失败，状态码: ${status}${failCode ? `，错误码: ${failCode}` : ''}`);\n  }\n  \n  /**\n   * 包装重试逻辑的错误处理\n   */\n  static async withRetry<T>(\n    operation: () => Promise<T>,\n    options: ErrorHandlerOptions & { maxRetries?: number; retryDelay?: number } = {}\n  ): Promise<T> {\n    const { \n      maxRetries = 3, \n      retryDelay = 5000, \n      context = '操作',\n      operation: operationName = '请求'\n    } = options;\n    \n    let lastError: any;\n    \n    for (let attempt = 0; attempt <= maxRetries; attempt++) {\n      try {\n        return await operation();\n      } catch (error) {\n        lastError = error;\n        \n        // 如果是APIException，直接抛出，不重试\n        if (error instanceof APIException) {\n          throw error;\n        }\n        \n        if (attempt < maxRetries) {\n          logger.warn(`${context}失败 (尝试 ${attempt + 1}/${maxRetries + 1}): ${error.message}`);\n          logger.info(`${retryDelay / 1000}秒后重试...`);\n          await new Promise(resolve => setTimeout(resolve, retryDelay));\n        }\n      }\n    }\n    \n    // 所有重试都失败了\n    this.handleNetworkError(lastError, { \n      context, \n      retryCount: maxRetries, \n      maxRetries,\n      operation: operationName\n    });\n  }\n}\n\n/**\n * 便捷的错误处理函数\n */\nexport const handleJimengError = JimengErrorHandler.handleApiResponse;\nexport const handleNetworkError = JimengErrorHandler.handleNetworkError;\nexport const handlePollingTimeout = JimengErrorHandler.handlePollingTimeout;\nexport const handleGenerationFailure = JimengErrorHandler.handleGenerationFailure;\nexport const withRetry = JimengErrorHandler.withRetry;\n","// src/api/consts/dreamina.ts\n\nexport const BASE_URL_DREAMINA_US = \"https://dreamina-api.us.capcut.com\";\nexport const BASE_URL_IMAGEX_US = \"https://imagex16-normal-us-ttp.capcutapi.us\";\n\nexport const BASE_URL_DREAMINA_HK = \"https://mweb-api-sg.capcut.com\";\nexport const BASE_URL_IMAGEX_HK = \"https://imagex-normal-sg.capcutapi.com\";\n\n\nexport const WEB_VERSION = \"7.5.0\";\nexport const DA_VERSION = \"3.3.2\";\nexport const AIGC_FEATURES = \"app_lip_sync\";\n","/**\n * 即梦API通用常量\n */\n\n// API基础URL\nexport const BASE_URL_CN = \"https://jimeng.jianying.com\";\n\nexport const BASE_URL_US_COMMERCE = \"https://commerce.us.capcut.com\";\nexport const BASE_URL_HK_COMMERCE = \"https://commerce-api-sg.capcut.com\";\nexport const BASE_URL_HK = \"https://mweb-api-sg.capcut.com\";\n\n// 默认助手ID\nexport const DEFAULT_ASSISTANT_ID_CN = 513695;\nexport const DEFAULT_ASSISTANT_ID_US = 513641;\nexport const DEFAULT_ASSISTANT_ID_HK = 513641;\nexport const DEFAULT_ASSISTANT_ID_JP = 513641;\nexport const DEFAULT_ASSISTANT_ID_SG = 513641;\n\n// 地区\nexport const REGION_CN = \"cn\";\nexport const REGION_US = \"US\";\nexport const REGION_HK = \"HK\";\nexport const REGION_JP = \"JP\";\nexport const REGION_SG = \"SG\";\n\n// 平台代码\nexport const PLATFORM_CODE = \"7\";\n\n// 版本代码\nexport const VERSION_CODE = \"5.8.0\";\n\n// 默认模型\nexport const DEFAULT_IMAGE_MODEL = \"jimeng-4.6\";\nexport const DEFAULT_VIDEO_MODEL = \"jimeng-video-3.0\";\n\n// 草稿版本\nexport const DRAFT_VERSION = \"3.3.4\";\nexport const DRAFT_MIN_VERSION = \"3.0.2\";\n\n// 图像模型映射\nexport const IMAGE_MODEL_MAP = {\n  \"jimeng-5.0\": \"high_aes_general_v50\",\n  \"jimeng-4.6\": \"high_aes_general_v42\",\n  \"jimeng-4.5\": \"high_aes_general_v40l\",\n  \"jimeng-4.1\": \"high_aes_general_v41\",\n  \"jimeng-4.0\": \"high_aes_general_v40\",\n  \"jimeng-3.1\": \"high_aes_general_v30l_art_fangzhou:general_v3.0_18b\",\n  \"jimeng-3.0\": \"high_aes_general_v30l:general_v3.0_18b\",\n  \"jimeng-2.1\": \"high_aes_general_v21_L:general_v2.1_L\",\n  \"jimeng-2.0-pro\": \"high_aes_general_v20_L:general_v2.0_L\",\n  \"jimeng-2.0\": \"high_aes_general_v20:general_v2.0\",\n  \"jimeng-1.4\": \"high_aes_general_v14:general_v1.4\",\n  \"jimeng-xl-pro\": \"text2img_xl_sft\"\n};\n\nexport const IMAGE_MODEL_MAP_US = {\n  \"jimeng-4.0\": \"high_aes_general_v40\",\n  \"jimeng-3.0\": \"high_aes_general_v30l:general_v3.0_18b\",\n  \"nanobanana\": \"external_model_gemini_flash_image_v25\",\n  \"nanobananapro\": \"dreamina_image_lib_1\",\n};\n\n// 视频模型映射\nexport const VIDEO_MODEL_MAP = {\n  \"jimeng-video-4.0-pro\": \"dreamina_seedance_40_pro\",\n  \"jimeng-video-4.0\": \"dreamina_seedance_40\",\n  \"jimeng-video-3.5-pro\": \"dreamina_ic_generate_video_model_vgfm_3.5_pro\",\n  \"jimeng-video-3.0-pro\": \"dreamina_ic_generate_video_model_vgfm_3.0_pro\",\n  \"jimeng-video-3.0\": \"dreamina_ic_generate_video_model_vgfm_3.0\",\n  \"jimeng-video-3.0-fast\": \"dreamina_ic_generate_video_model_vgfm_3.0_fast\",\n  \"jimeng-video-2.0\": \"dreamina_ic_generate_video_model_vgfm_lite\",\n  \"jimeng-video-2.0-pro\": \"dreamina_ic_generate_video_model_vgfm1.0\"\n};\n\n// 状态码映射\nexport const STATUS_CODE_MAP = {\n  20: 'PROCESSING',\n  10: 'SUCCESS',\n  30: 'FAILED',\n  42: 'POST_PROCESSING',\n  45: 'FINALIZING',\n  50: 'COMPLETED'\n};\n\n// 重试配置\nexport const RETRY_CONFIG = {\n  MAX_RETRY_COUNT: 3,\n  RETRY_DELAY: 5000\n};\n\n// 轮询配置\nexport const POLLING_CONFIG = {\n  MAX_POLL_COUNT: 900, // 15分钟\n  POLL_INTERVAL: 5000, // 1秒\n  STABLE_ROUNDS: 5,    // 稳定轮次\n  TIMEOUT_SECONDS: 900 // 15分钟超时\n};\n\n// 支持的图片比例和分辨率\nexport const RESOLUTION_OPTIONS = {\n  \"1k\":{\n    \"1:1\": { width: 1024, height: 1024, ratio: 1 },\n    \"4:3\": { width: 768, height: 1024, ratio: 4 },\n    \"3:4\": { width: 1024, height: 768, ratio: 2 },\n    \"16:9\": { width: 1024, height: 576, ratio: 3 },\n    \"9:16\": { width: 576, height: 1024, ratio: 5 },\n    \"3:2\": { width: 1024, height: 682, ratio: 7 },\n    \"2:3\": { width: 682, height: 1024, ratio: 6 },\n    \"21:9\": { width: 1195, height: 512, ratio: 8 },\n  },\n\n  \"2k\": {\n    \"1:1\": {width: 2048, height: 2048, ratio: 1},\n    \"4:3\": {width: 2304, height: 1728, ratio: 4},\n    \"3:4\": {width: 1728, height: 2304, ratio: 2},\n    \"16:9\": {width: 2560, height: 1440, ratio: 3},\n    \"9:16\": {width: 1440, height: 2560, ratio: 5},\n    \"3:2\": {width: 2496, height: 1664, ratio: 7},\n    \"2:3\": {width: 1664, height: 2496, ratio: 6},\n    \"21:9\": {width: 3024, height: 1296, ratio: 8},\n  },\n  \"4k\": {\n    \"1:1\": {width: 4096, height: 4096, ratio: 101},\n    \"4:3\": {width: 4608, height: 3456, ratio: 104},\n    \"3:4\": {width: 3456, height: 4608, ratio: 102},\n    \"16:9\": {width: 5120, height: 2880, ratio: 103},\n    \"9:16\": {width: 2880, height: 5120, ratio: 105},\n    \"3:2\": {width: 4992, height: 3328, ratio: 107},\n    \"2:3\": {width: 3328, height: 4992, ratio: 106},\n    \"21:9\": {width: 6048, height: 2592, ratio: 108}\n  }\n};\n","import APIException from \"@/lib/exceptions/APIException.ts\";\nimport EX from \"@/api/consts/exceptions.ts\";\nimport { request } from \"./core.ts\";\nimport logger from \"@/lib/logger.ts\";\n\nconst DEFAULT_ASSISTANT_ID = \"513695\";\n\nexport async function getImageByHistoryId(historyId: string, refreshToken: string) {\n  const maxRetries = 3;\n  const retryDelay = 2000; // 2 seconds\n  \n  for (let attempt = 1; attempt <= maxRetries; attempt++) {\n    try {\n      const result = await request(\n        \"post\",\n        \"/mweb/v1/get_history_by_ids\",\n        refreshToken,\n        {\n          data: {\n            history_ids: [historyId],\n            image_info: { \n              width: 2048, \n              height: 2048, \n              format: \"webp\" \n            },\n            http_common_info: { \n              aid: Number(DEFAULT_ASSISTANT_ID),\n              device_platform: \"web\",\n              region: \"CN\"\n            }\n          },\n          headers: {\n            \"Content-Type\": \"application/json\",\n            \"Accept\": \"application/json\",\n            \"Referer\": \"https://jimeng.jianying.com/ai-tool/image/generate\"\n          }\n        }\n      );\n\n      logger.info(`获取历史记录响应 (尝试 ${attempt}/${maxRetries}): ${JSON.stringify(result)}`);\n\n      if (!result) {\n        if (attempt < maxRetries) {\n          logger.info(`Empty response received, retrying in ${retryDelay}ms...`);\n          await new Promise(resolve => setTimeout(resolve, retryDelay));\n          continue;\n        }\n        throw new APIException(EX.API_IMAGE_GENERATION_FAILED, \"获取历史记录失败: 服务器返回空响应\");\n      }\n\n      if (typeof result !== 'object') {\n        throw new APIException(EX.API_IMAGE_GENERATION_FAILED, \"获取历史记录失败: 响应格式错误\");\n      }\n\n      if (!result[historyId]) {\n        throw new APIException(EX.API_IMAGE_GENERATION_FAILED, \"历史记录不存在\");\n      }\n\n      const item_list = result[historyId].item_list || [];\n      return {\n        images: item_list.map(item => ({\n          webp: item?.common_attr?.cover_url_map?.[\"2400\"] || \"\",\n          cover: item?.common_attr?.cover_url_map?.[\"1080\"] || \"\",\n          png: item?.common_attr?.cover_url || \"\",\n          large: item?.image?.large_images?.[0]?.image_url || \"\"\n        }))\n      };\n    } catch (error) {\n      if (attempt === maxRetries) {\n        throw error;\n      }\n      logger.info(`Error occurred, retrying in ${retryDelay}ms...`);\n      await new Promise(resolve => setTimeout(resolve, retryDelay));\n    }\n  }\n\n  throw new APIException(EX.API_IMAGE_GENERATION_FAILED, \"获取历史记录失败: 超过最大重试次数\");\n}\n\nexport async function getImagesByHistoryIds(historyIds: string[], refreshToken: string) {\n  const maxRetries = 3;\n  const retryDelay = 2000; // 2 seconds\n  \n  for (let attempt = 1; attempt <= maxRetries; attempt++) {\n    try {\n      const result = await request(\n        \"post\",\n        \"/mweb/v1/get_history_by_ids\",\n        refreshToken,\n        {\n          data: {\n            history_ids: historyIds,\n            image_info: { \n              width: 2048, \n              height: 2048, \n              format: \"webp\" \n            },\n            http_common_info: { \n              aid: Number(DEFAULT_ASSISTANT_ID),\n              device_platform: \"web\",\n              region: \"CN\"\n            }\n          },\n          headers: {\n            \"Content-Type\": \"application/json\",\n            \"Accept\": \"application/json\",\n            \"Referer\": \"https://jimeng.jianying.com/ai-tool/image/generate\"\n          }\n        }\n      );\n\n      logger.info(`批量获取历史记录响应 (尝试 ${attempt}/${maxRetries}): ${JSON.stringify(result)}`);\n\n      if (!result) {\n        if (attempt < maxRetries) {\n          logger.info(`Empty response received, retrying in ${retryDelay}ms...`);\n          await new Promise(resolve => setTimeout(resolve, retryDelay));\n          continue;\n        }\n        throw new APIException(EX.API_IMAGE_GENERATION_FAILED, \"批量获取历史记录失败: 服务器返回空响应\");\n      }\n\n      if (typeof result !== 'object') {\n        throw new APIException(EX.API_IMAGE_GENERATION_FAILED, \"批量获取历史记录失败: 响应格式错误\");\n      }\n\n      // 处理每个历史记录ID的结果\n      const results = {};\n      for (const historyId of historyIds) {\n        if (!result[historyId]) {\n          results[historyId] = {\n            error: \"历史记录不存在\",\n            images: []\n          };\n          continue;\n        }\n\n        const item_list = result[historyId].item_list || [];\n        results[historyId] = {\n          images: item_list.map(item => ({\n            webp: item?.common_attr?.cover_url_map?.[\"2400\"] || \"\",\n            cover: item?.common_attr?.cover_url_map?.[\"1080\"] || \"\",\n            png: item?.common_attr?.cover_url || \"\",\n            large: item?.image?.large_images?.[0]?.image_url || \"\"\n          }))\n        };\n      }\n\n      return results;\n    } catch (error) {\n      if (attempt === maxRetries) {\n        throw error;\n      }\n      logger.info(`Error occurred, retrying in ${retryDelay}ms...`);\n      await new Promise(resolve => setTimeout(resolve, retryDelay));\n    }\n  }\n\n  throw new APIException(EX.API_IMAGE_GENERATION_FAILED, \"批量获取历史记录失败: 超过最大重试次数\");\n}\n\nexport async function getAssetList(refreshToken: string) {\n  const maxRetries = 3;\n  const retryDelay = 2000; // 2 seconds\n  \n  for (let attempt = 1; attempt <= maxRetries; attempt++) {\n    try {\n      const result = await request(\n        \"get\",\n        \"/mweb/v1/get_asset_list\",\n        refreshToken,\n        {\n          params: {\n            aid: DEFAULT_ASSISTANT_ID,\n            da_version: \"3.2.5\",\n            aigc_features: \"app_lip_sync\"\n          },\n          headers: {\n            \"Content-Type\": \"application/json\",\n            \"Accept\": \"application/json\",\n            \"Referer\": \"https://jimeng.jianying.com/ai-tool/image/generate\"\n          }\n        }\n      );\n\n      logger.info(`获取资产列表响应 (尝试 ${attempt}/${maxRetries}): ${JSON.stringify(result)}`);\n\n      if (!result) {\n        if (attempt < maxRetries) {\n          logger.info(`Empty response received, retrying in ${retryDelay}ms...`);\n          await new Promise(resolve => setTimeout(resolve, retryDelay));\n          continue;\n        }\n        throw new APIException(EX.API_REQUEST_FAILED, \"获取资产列表失败: 服务器返回空响应\");\n      }\n\n      if (typeof result !== 'object') {\n        throw new APIException(EX.API_REQUEST_FAILED, \"获取资产列表失败: 响应格式错误\");\n      }\n\n      return {\n        assets: result.asset_list || [],\n        total: result.total || 0\n      };\n    } catch (error) {\n      if (attempt === maxRetries) {\n        throw error;\n      }\n      logger.info(`Error occurred, retrying in ${retryDelay}ms...`);\n      await new Promise(resolve => setTimeout(resolve, retryDelay));\n    }\n  }\n\n  throw new APIException(EX.API_REQUEST_FAILED, \"获取资产列表失败: 超过最大重试次数\");\n}\n","import crypto from \"crypto\";\n\n/**\n * AWS4-HMAC-SHA256 签名生成函数\n * 用于即梦API的请求签名\n */\nexport function createSignature(\n  method: string,\n  url: string,\n  headers: { [key: string]: string },\n  accessKeyId: string,\n  secretAccessKey: string,\n  sessionToken?: string,\n  payload: string = '',\n  region: string = 'cn-north-1'\n) {\n  const urlObj = new URL(url);\n  const pathname = urlObj.pathname || '/';\n  const search = urlObj.search;\n\n  // 创建规范请求\n  const timestamp = headers['x-amz-date'];\n  const date = timestamp.substr(0, 8);\n  const service = 'imagex';\n  \n  // 规范化查询参数\n  const queryParams: Array<[string, string]> = [];\n  const searchParams = new URLSearchParams(search);\n  searchParams.forEach((value, key) => {\n    queryParams.push([key, value]);\n  });\n  \n  // 按键名排序\n  queryParams.sort(([a], [b]) => {\n    if (a < b) return -1;\n    if (a > b) return 1;\n    return 0;\n  });\n  \n  const canonicalQueryString = queryParams\n    .map(([key, value]) => `${key}=${value}`)\n    .join('&');\n  \n  // 规范化头部\n  const headersToSign: { [key: string]: string } = {\n    'x-amz-date': timestamp\n  };\n  \n  if (sessionToken) {\n    headersToSign['x-amz-security-token'] = sessionToken;\n  }\n  \n  let payloadHash = crypto.createHash('sha256').update('').digest('hex');\n  if (method.toUpperCase() === 'POST' && payload) {\n    payloadHash = crypto.createHash('sha256').update(payload, 'utf8').digest('hex');\n    headersToSign['x-amz-content-sha256'] = payloadHash;\n  }\n  \n  const signedHeaders = Object.keys(headersToSign)\n    .map(key => key.toLowerCase())\n    .sort()\n    .join(';');\n  \n  const canonicalHeaders = Object.keys(headersToSign)\n    .sort((a, b) => a.toLowerCase().localeCompare(b.toLowerCase()))\n    .map(key => `${key.toLowerCase()}:${headersToSign[key].trim()}\\n`)\n    .join('');\n  \n  const canonicalRequest = [\n    method.toUpperCase(),\n    pathname,\n    canonicalQueryString,\n    canonicalHeaders,\n    signedHeaders,\n    payloadHash\n  ].join('\\n');\n  \n  // 创建待签名字符串\n  const credentialScope = `${date}/${region}/${service}/aws4_request`;\n  const stringToSign = [\n    'AWS4-HMAC-SHA256',\n    timestamp,\n    credentialScope,\n    crypto.createHash('sha256').update(canonicalRequest, 'utf8').digest('hex')\n  ].join('\\n');\n  \n  // 计算签名\n  const kDate = crypto.createHmac('sha256', `AWS4${secretAccessKey}`).update(date).digest();\n  const kRegion = crypto.createHmac('sha256', kDate).update(region).digest();\n  const kService = crypto.createHmac('sha256', kRegion).update(service).digest();\n  const kSigning = crypto.createHmac('sha256', kService).update('aws4_request').digest();\n  const signature = crypto.createHmac('sha256', kSigning).update(stringToSign).digest('hex');\n  \n  return `AWS4-HMAC-SHA256 Credential=${accessKeyId}/${credentialScope}, SignedHeaders=${signedHeaders}, Signature=${signature}`;\n}\n","import _ from 'lodash';\n\nimport Request from '@/lib/request/Request.ts';\nimport Response from '@/lib/response/Response.ts';\nimport { tokenSplit } from '@/api/controllers/core.ts';\nimport { createCompletion, createCompletionStream } from '@/api/controllers/chat.ts';\n\nexport default {\n\n    prefix: '/v1/chat',\n\n    post: {\n\n        '/completions': async (request: Request) => {\n            request\n                .validate('body.model', v => _.isUndefined(v) || _.isString(v))\n                .validate('body.messages', _.isArray)\n                .validate('headers.authorization', _.isString)\n            // refresh_token切分\n            const tokens = tokenSplit(request.headers.authorization);\n            // 随机挑选一个refresh_token\n            const token = _.sample(tokens);\n            const { model, messages, stream } = request.body;\n            if (stream) {\n                const stream = await createCompletionStream(messages, token, model);\n                return new Response(stream, {\n                    type: \"text/event-stream\"\n                });\n            }\n            else\n                return await createCompletion(messages, token, model);\n        }\n\n    }\n\n}","import _ from \"lodash\";\nimport { PassThrough } from \"stream\";\n\nimport APIException from \"@/lib/exceptions/APIException.ts\";\nimport EX from \"@/api/consts/exceptions.ts\";\nimport logger from \"@/lib/logger.ts\";\nimport util from \"@/lib/util.ts\";\nimport { generateImages, DEFAULT_MODEL } from \"./images.ts\";\nimport { generateVideo, DEFAULT_MODEL as DEFAULT_VIDEO_MODEL } from \"./videos.ts\";\nimport { JimengErrorHandler, withRetry } from \"@/lib/error-handler.ts\";\nimport { RETRY_CONFIG } from \"@/api/consts/common.ts\";\n\n/**\n * 解析模型\n *\n * @param model 模型名称\n * @returns 模型信息\n */\nfunction parseModel(model: string) {\n  const [_model, size] = model.split(\":\");\n  const [_, width, height] = /(\\d+)[\\W\\w](\\d+)/.exec(size) ?? [];\n  return {\n    model: _model,\n    width: size ? Math.ceil(parseInt(width) / 2) * 2 : 1024,\n    height: size ? Math.ceil(parseInt(height) / 2) * 2 : 1024,\n  };\n}\n\n/**\n * 检测是否为视频生成请求\n *\n * @param model 模型名称\n * @returns 是否为视频生成请求\n */\nfunction isVideoModel(model: string) {\n  return model.startsWith(\"jimeng-video\");\n}\n\n/**\n * 同步对话补全\n *\n * @param messages 参考gpt系列消息格式，多轮对话请完整提供上下文\n * @param refreshToken 用于刷新access_token的refresh_token\n * @param assistantId 智能体ID，默认使用jimeng原版\n * @param retryCount 重试次数\n */\nexport async function createCompletion(\n  messages: any[],\n  refreshToken: string,\n  _model = DEFAULT_MODEL,\n  retryCount = 0\n) {\n  return (async () => {\n    if (messages.length === 0)\n      throw new APIException(EX.API_REQUEST_PARAMS_INVALID, \"消息不能为空\");\n\n    const { model, width, height } = parseModel(_model);\n    logger.info(messages);\n\n    // 检查是否为视频生成请求\n    if (isVideoModel(_model)) {\n      try {\n        // 视频生成\n        logger.info(`开始生成视频，模型: ${_model}`);\n        const videoUrl = await generateVideo(\n          _model,\n          messages[messages.length - 1].content,\n          {\n            width,\n            height,\n            resolution: \"720p\", // 默认分辨率\n          },\n          refreshToken\n        );\n\n        logger.info(`视频生成成功，URL: ${videoUrl}`);\n        return {\n          id: util.uuid(),\n          model: _model,\n          object: \"chat.completion\",\n          choices: [\n            {\n              index: 0,\n              message: {\n                role: \"assistant\",\n                content: `![video](${videoUrl})\\n`,\n              },\n              finish_reason: \"stop\",\n            },\n          ],\n          usage: { prompt_tokens: 1, completion_tokens: 1, total_tokens: 2 },\n          created: util.unixTimestamp(),\n        };\n      } catch (error) {\n        logger.error(`视频生成失败: ${error.message}`);\n        // 如果是积分不足等特定错误，直接抛出\n        if (error instanceof APIException) {\n          throw error;\n        }\n\n        // 其他错误返回友好提示\n        return {\n          id: util.uuid(),\n          model: _model,\n          object: \"chat.completion\",\n          choices: [\n            {\n              index: 0,\n              message: {\n                role: \"assistant\",\n                content: `生成视频失败: ${error.message}\\n\\n如果您在即梦官网看到已生成的视频，可能是获取结果时出现了问题，请前往即梦官网查看。`,\n              },\n              finish_reason: \"stop\",\n            },\n          ],\n          usage: { prompt_tokens: 1, completion_tokens: 1, total_tokens: 2 },\n          created: util.unixTimestamp(),\n        };\n      }\n    } else {\n      // 图像生成\n      const imageUrls = await generateImages(\n        model,\n        messages[messages.length - 1].content,\n        {\n          width,\n          height,\n        },\n        refreshToken\n      );\n\n      return {\n        id: util.uuid(),\n        model: _model || model,\n        object: \"chat.completion\",\n        choices: [\n          {\n            index: 0,\n            message: {\n              role: \"assistant\",\n              content: imageUrls.reduce(\n                (acc, url, i) => acc + `![image_${i}](${url})\\n`,\n                \"\"\n              ),\n            },\n            finish_reason: \"stop\",\n          },\n        ],\n        usage: { prompt_tokens: 1, completion_tokens: 1, total_tokens: 2 },\n        created: util.unixTimestamp(),\n      };\n    }\n  })().catch((err) => {\n    if (retryCount < RETRY_CONFIG.MAX_RETRY_COUNT) {\n      logger.error(`Response error: ${err.stack}`);\n      logger.warn(`Try again after ${RETRY_CONFIG.RETRY_DELAY / 1000}s...`);\n      return (async () => {\n        await new Promise((resolve) => setTimeout(resolve, RETRY_CONFIG.RETRY_DELAY));\n        return createCompletion(messages, refreshToken, _model, retryCount + 1);\n      })();\n    }\n    throw err;\n  });\n}\n\n/**\n * 流式对话补全\n *\n * @param messages 参考gpt系列消息格式，多轮对话请完整提供上下文\n * @param refreshToken 用于刷新access_token的refresh_token\n * @param assistantId 智能体ID，默认使用jimeng原版\n * @param retryCount 重试次数\n */\nexport async function createCompletionStream(\n  messages: any[],\n  refreshToken: string,\n  _model = DEFAULT_MODEL,\n  retryCount = 0\n) {\n  return (async () => {\n    const { model, width, height } = parseModel(_model);\n    logger.info(messages);\n\n    const stream = new PassThrough();\n\n    if (messages.length === 0) {\n      logger.warn(\"消息为空，返回空流\");\n      stream.end(\"data: [DONE]\\n\\n\");\n      return stream;\n    }\n\n    // 检查是否为视频生成请求\n    if (isVideoModel(_model)) {\n      // 视频生成\n      stream.write(\n        \"data: \" +\n          JSON.stringify({\n            id: util.uuid(),\n            model: _model,\n            object: \"chat.completion.chunk\",\n            choices: [\n              {\n                index: 0,\n                delta: { role: \"assistant\", content: \"🎬 视频生成中，请稍候...\\n这可能需要1-2分钟，请耐心等待\" },\n                finish_reason: null,\n              },\n            ],\n          }) +\n          \"\\n\\n\"\n      );\n\n      // 视频生成\n      logger.info(`开始生成视频，提示词: ${messages[messages.length - 1].content}`);\n\n      // 进度更新定时器\n      const progressInterval = setInterval(() => {\n        if (stream.destroyed) {\n          clearInterval(progressInterval);\n          return;\n        }\n        stream.write(\n          \"data: \" +\n            JSON.stringify({\n              id: util.uuid(),\n              model: _model,\n              object: \"chat.completion.chunk\",\n              choices: [\n                {\n                  index: 0,\n                  delta: { role: \"assistant\", content: \".\" },\n                  finish_reason: null,\n                },\n              ],\n            }) +\n            \"\\n\\n\"\n        );\n      }, 5000);\n\n      // 设置超时，防止无限等待\n      const timeoutId = setTimeout(() => {\n        clearInterval(progressInterval);\n        logger.warn(`视频生成超时（2分钟），提示用户前往即梦官网查看`);\n        if (!stream.destroyed) {\n          stream.write(\n            \"data: \" +\n              JSON.stringify({\n                id: util.uuid(),\n                model: _model,\n                object: \"chat.completion.chunk\",\n                choices: [\n                  {\n                    index: 1,\n                    delta: {\n                      role: \"assistant\",\n                      content: \"\\n\\n视频生成时间较长（已等待2分钟），但视频可能仍在生成中。\\n\\n请前往即梦官网查看您的视频：\\n1. 访问 https://jimeng.jianying.com/ai-tool/video/generate\\n2. 登录后查看您的创作历史\\n3. 如果视频已生成，您可以直接在官网下载或分享\\n\\n您也可以继续等待，系统将在后台继续尝试获取视频（最长约20分钟）。\",\n                    },\n                    finish_reason: \"stop\",\n                  },\n                ],\n              }) +\n              \"\\n\\n\"\n          );\n        }\n        // 注意：这里不结束流，让后台继续尝试获取视频\n        // stream.end(\"data: [DONE]\\n\\n\");\n      }, 2 * 60 * 1000);\n\n      // 监听流关闭事件，确保定时器被清理\n      stream.on('close', () => {\n        clearInterval(progressInterval);\n        clearTimeout(timeoutId);\n        logger.debug('视频生成流已关闭，定时器已清理');\n      });\n\n      logger.info(`开始生成视频，模型: ${_model}, 提示词: ${messages[messages.length - 1].content.substring(0, 50)}...`);\n\n      // 先给用户一个初始提示\n      stream.write(\n        \"data: \" +\n          JSON.stringify({\n            id: util.uuid(),\n            model: _model,\n            object: \"chat.completion.chunk\",\n            choices: [\n              {\n                index: 0,\n                delta: {\n                  role: \"assistant\",\n                  content: \"\\n\\n🎬 视频生成已开始，这可能需要几分钟时间...\",\n                },\n                finish_reason: null,\n              },\n            ],\n          }) +\n          \"\\n\\n\"\n      );\n\n      generateVideo(\n        _model,\n        messages[messages.length - 1].content,\n        { width, height, resolution: \"720p\" },\n        refreshToken\n      )\n        .then((videoUrl) => {\n          clearInterval(progressInterval);\n          clearTimeout(timeoutId);\n\n          logger.info(`视频生成成功，URL: ${videoUrl}`);\n\n          // 检查流是否仍然可写\n          if (!stream.destroyed && stream.writable) {\n            stream.write(\n              \"data: \" +\n                JSON.stringify({\n                  id: util.uuid(),\n                  model: _model,\n                  object: \"chat.completion.chunk\",\n                  choices: [\n                    {\n                      index: 1,\n                      delta: {\n                        role: \"assistant\",\n                        content: `\\n\\n✅ 视频生成完成！\\n\\n![video](${videoUrl})\\n\\n您可以：\\n1. 直接查看上方视频\\n2. 使用以下链接下载或分享：${videoUrl}`,\n                      },\n                      finish_reason: null,\n                    },\n                  ],\n                }) +\n                \"\\n\\n\"\n            );\n\n            stream.write(\n              \"data: \" +\n                JSON.stringify({\n                  id: util.uuid(),\n                  model: _model,\n                  object: \"chat.completion.chunk\",\n                  choices: [\n                    {\n                      index: 2,\n                      delta: {\n                        role: \"assistant\",\n                        content: \"\",\n                      },\n                      finish_reason: \"stop\",\n                    },\n                  ],\n                }) +\n                \"\\n\\n\"\n            );\n            stream.end(\"data: [DONE]\\n\\n\");\n          } else {\n            logger.debug('视频生成完成，但流已关闭，跳过写入');\n          }\n        })\n        .catch((err) => {\n          clearInterval(progressInterval);\n          clearTimeout(timeoutId);\n\n          logger.error(`视频生成失败: ${err.message}`);\n          logger.error(`错误详情: ${JSON.stringify(err)}`);\n\n          // 构建更详细的错误信息\n          let errorMessage = `⚠️ 视频生成过程中遇到问题: ${err.message}`;\n\n          // 如果是历史记录不存在的错误，提供更具体的建议\n          if (err.message.includes(\"历史记录不存在\")) {\n            errorMessage += \"\\n\\n可能原因：\\n1. 视频生成请求已发送，但API无法获取历史记录\\n2. 视频生成服务暂时不可用\\n3. 历史记录ID无效或已过期\\n\\n建议操作：\\n1. 请前往即梦官网查看您的视频是否已生成：https://jimeng.jianying.com/ai-tool/video/generate\\n2. 如果官网已显示视频，但这里无法获取，可能是API连接问题\\n3. 如果官网也没有显示，请稍后再试或重新生成视频\";\n          } else if (err.message.includes(\"获取视频生成结果超时\")) {\n            errorMessage += \"\\n\\n视频生成可能仍在进行中，但等待时间已超过系统设定的限制。\\n\\n请前往即梦官网查看您的视频：https://jimeng.jianying.com/ai-tool/video/generate\\n\\n如果您在官网上看到视频已生成，但这里无法显示，可能是因为：\\n1. 获取结果的过程超时\\n2. 网络连接问题\\n3. API访问限制\";\n          } else {\n            errorMessage += \"\\n\\n如果您在即梦官网看到已生成的视频，可能是获取结果时出现了问题。\\n\\n请访问即梦官网查看您的创作历史：https://jimeng.jianying.com/ai-tool/video/generate\";\n          }\n\n          // 添加历史ID信息，方便用户在官网查找\n          if (err.historyId) {\n            errorMessage += `\\n\\n历史记录ID: ${err.historyId}（您可以使用此ID在官网搜索您的视频）`;\n          }\n\n          // 检查流是否仍然可写\n          if (!stream.destroyed && stream.writable) {\n            stream.write(\n              \"data: \" +\n                JSON.stringify({\n                  id: util.uuid(),\n                  model: _model,\n                  object: \"chat.completion.chunk\",\n                  choices: [\n                    {\n                      index: 1,\n                      delta: {\n                        role: \"assistant\",\n                        content: `\\n\\n${errorMessage}`,\n                      },\n                      finish_reason: \"stop\",\n                    },\n                  ],\n                }) +\n                \"\\n\\n\"\n            );\n            stream.end(\"data: [DONE]\\n\\n\");\n          } else {\n            logger.debug('视频生成失败，但流已关闭，跳过错误信息写入');\n          }\n        });\n    } else {\n      // 图像生成\n      stream.write(\n        \"data: \" +\n          JSON.stringify({\n            id: util.uuid(),\n            model: _model || model,\n            object: \"chat.completion.chunk\",\n            choices: [\n              {\n                index: 0,\n                delta: { role: \"assistant\", content: \"🎨 图像生成中，请稍候...\" },\n                finish_reason: null,\n              },\n            ],\n          }) +\n          \"\\n\\n\"\n      );\n\n      generateImages(\n        model,\n        messages[messages.length - 1].content,\n        { width, height },\n        refreshToken\n      )\n        .then((imageUrls) => {\n          // 检查流是否仍然可写\n          if (!stream.destroyed && stream.writable) {\n            for (let i = 0; i < imageUrls.length; i++) {\n              const url = imageUrls[i];\n              stream.write(\n                \"data: \" +\n                  JSON.stringify({\n                    id: util.uuid(),\n                    model: _model || model,\n                    object: \"chat.completion.chunk\",\n                    choices: [\n                      {\n                        index: i + 1,\n                        delta: {\n                          role: \"assistant\",\n                          content: `![image_${i}](${url})\\n`,\n                        },\n                        finish_reason: i < imageUrls.length - 1 ? null : \"stop\",\n                      },\n                    ],\n                  }) +\n                  \"\\n\\n\"\n              );\n            }\n            stream.write(\n              \"data: \" +\n                JSON.stringify({\n                  id: util.uuid(),\n                  model: _model || model,\n                  object: \"chat.completion.chunk\",\n                  choices: [\n                    {\n                      index: imageUrls.length + 1,\n                      delta: {\n                        role: \"assistant\",\n                        content: \"图像生成完成！\",\n                      },\n                      finish_reason: \"stop\",\n                    },\n                  ],\n                }) +\n                \"\\n\\n\"\n            );\n            stream.end(\"data: [DONE]\\n\\n\");\n          } else {\n            logger.debug('图像生成完成，但流已关闭，跳过写入');\n          }\n        })\n        .catch((err) => {\n          // 检查流是否仍然可写\n          if (!stream.destroyed && stream.writable) {\n            stream.write(\n              \"data: \" +\n                JSON.stringify({\n                  id: util.uuid(),\n                  model: _model || model,\n                  object: \"chat.completion.chunk\",\n                  choices: [\n                    {\n                      index: 1,\n                      delta: {\n                        role: \"assistant\",\n                        content: `生成图片失败: ${err.message}`,\n                      },\n                      finish_reason: \"stop\",\n                    },\n                  ],\n                }) +\n                \"\\n\\n\"\n            );\n            stream.end(\"data: [DONE]\\n\\n\");\n          } else {\n            logger.debug('图像生成失败，但流已关闭，跳过错误信息写入');\n          }\n        });\n    }\n    return stream;\n  })().catch((err) => {\n    if (retryCount < RETRY_CONFIG.MAX_RETRY_COUNT) {\n      logger.error(`Response error: ${err.stack}`);\n      logger.warn(`Try again after ${RETRY_CONFIG.RETRY_DELAY / 1000}s...`);\n      return (async () => {\n        await new Promise((resolve) => setTimeout(resolve, RETRY_CONFIG.RETRY_DELAY));\n        return createCompletionStream(\n          messages,\n          refreshToken,\n          _model,\n          retryCount + 1\n        );\n      })();\n    }\n    throw err;\n  });\n}\n","import _ from \"lodash\";\nimport fs from \"fs-extra\";\n\nimport APIException from \"@/lib/exceptions/APIException.ts\";\nimport EX from \"@/api/consts/exceptions.ts\";\nimport util from \"@/lib/util.ts\";\nimport { getCredit, receiveCredit, request, parseRegionFromToken, getAssistantId, RegionInfo } from \"./core.ts\";\nimport logger from \"@/lib/logger.ts\";\nimport { SmartPoller, PollingStatus } from \"@/lib/smart-poller.ts\";\nimport { DEFAULT_ASSISTANT_ID_CN, DEFAULT_ASSISTANT_ID_US, DEFAULT_ASSISTANT_ID_HK, DEFAULT_ASSISTANT_ID_JP, DEFAULT_ASSISTANT_ID_SG, DEFAULT_VIDEO_MODEL, DRAFT_VERSION, VIDEO_MODEL_MAP } from \"@/api/consts/common.ts\";\nimport { uploadImageBuffer } from \"@/lib/image-uploader.ts\";\nimport { extractVideoUrl } from \"@/lib/image-utils.ts\";\n\nexport const DEFAULT_MODEL = DEFAULT_VIDEO_MODEL;\n\nexport function getModel(model: string) {\n  return VIDEO_MODEL_MAP[model] || VIDEO_MODEL_MAP[DEFAULT_MODEL];\n}\n\n// 处理本地上传的文件\nasync function uploadImageFromFile(file: any, refreshToken: string, regionInfo: RegionInfo): Promise<string> {\n  try {\n    logger.info(`开始从本地文件上传视频图片: ${file.originalFilename} (路径: ${file.filepath})`);\n    const imageBuffer = await fs.readFile(file.filepath);\n    return await uploadImageBuffer(imageBuffer, refreshToken, regionInfo);\n  } catch (error: any) {\n    logger.error(`从本地文件上传视频图片失败: ${error.message}`);\n    throw error;\n  }\n}\n\n// 处理来自URL的图片\nasync function uploadImageFromUrl(imageUrl: string, refreshToken: string, regionInfo: RegionInfo): Promise<string> {\n  try {\n    logger.info(`开始从URL下载并上传视频图片: ${imageUrl}`);\n    const imageResponse = await fetch(imageUrl);\n    if (!imageResponse.ok) {\n      throw new Error(`下载图片失败: ${imageResponse.status}`);\n    }\n    const imageBuffer = await imageResponse.arrayBuffer();\n    return await uploadImageBuffer(imageBuffer, refreshToken, regionInfo);\n  } catch (error: any) {\n    logger.error(`从URL上传视频图片失败: ${error.message}`);\n    throw error;\n  }\n}\n\n\n/**\n * 生成视频\n *\n * @param _model 模型名称\n * @param prompt 提示词\n * @param options 选项\n * @param refreshToken 刷新令牌\n * @returns 视频URL\n */\nexport async function generateVideo(\n  _model: string,\n  prompt: string,\n  {\n    ratio = \"1:1\",\n    resolution = \"720p\",\n    duration = 5,\n    filePaths = [],\n    files = {},\n  }: {\n    ratio?: string;\n    resolution?: string;\n    duration?: number;\n    filePaths?: string[];\n    files?: any;\n  },\n  refreshToken: string\n) {\n  // 检测区域\n  const regionInfo = parseRegionFromToken(refreshToken);\n  const { isInternational } = regionInfo;\n\n  logger.info(`视频生成区域检测: isInternational=${isInternational}`);\n\n  const model = getModel(_model);\n\n  // 将秒转换为毫秒，只支持5秒和10秒\n  const durationMs = duration === 10 ? 10000 : 5000;\n\n  logger.info(`使用模型: ${_model} 映射模型: ${model} 比例: ${ratio} 分辨率: ${resolution} 时长: ${duration}s`);\n\n  // 检查积分\n  const { totalCredit } = await getCredit(refreshToken);\n  if (totalCredit <= 0)\n    await receiveCredit(refreshToken);\n\n  // 处理首帧和尾帧图片\n  let first_frame_image = undefined;\n  let end_frame_image = undefined;\n  let uploadIDs: string[] = [];\n\n  // 优先处理本地上传的文件\n  const uploadedFiles = _.values(files); // 将files对象转为数组\n  if (uploadedFiles && uploadedFiles.length > 0) {\n    logger.info(`检测到 ${uploadedFiles.length} 个本地上传文件，优先处理`);\n    for (let i = 0; i < uploadedFiles.length; i++) {\n      const file = uploadedFiles[i];\n      if (!file) continue;\n      try {\n        logger.info(`开始上传第 ${i + 1} 张本地图片: ${file.originalFilename}`);\n        const imageUri = await uploadImageFromFile(file, refreshToken, regionInfo);\n        if (imageUri) {\n          uploadIDs.push(imageUri);\n          logger.info(`第 ${i + 1} 张本地图片上传成功: ${imageUri}`);\n        } else {\n          logger.error(`第 ${i + 1} 张本地图片上传失败: 未获取到 image_uri`);\n        }\n      } catch (error: any) {\n        logger.error(`第 ${i + 1} 张本地图片上传失败: ${error.message}`);\n        if (i === 0) {\n          throw new APIException(EX.API_REQUEST_FAILED, `首帧图片上传失败: ${error.message}`);\n        }\n      }\n    }\n  }\n  // 如果没有本地文件，再处理URL\n  else if (filePaths && filePaths.length > 0) {\n    logger.info(`未检测到本地上传文件，处理 ${filePaths.length} 个图片URL`);\n    for (let i = 0; i < filePaths.length; i++) {\n      const filePath = filePaths[i];\n      if (!filePath) {\n        logger.warn(`第 ${i + 1} 个图片URL为空，跳过`);\n        continue;\n      }\n      try {\n        logger.info(`开始上传第 ${i + 1} 个URL图片: ${filePath}`);\n        const imageUri = await uploadImageFromUrl(filePath, refreshToken, regionInfo);\n        if (imageUri) {\n          uploadIDs.push(imageUri);\n          logger.info(`第 ${i + 1} 个URL图片上传成功: ${imageUri}`);\n        } else {\n          logger.error(`第 ${i + 1} 个URL图片上传失败: 未获取到 image_uri`);\n        }\n      } catch (error: any) {\n        logger.error(`第 ${i + 1} 个URL图片上传失败: ${error.message}`);\n        if (i === 0) {\n          throw new APIException(EX.API_REQUEST_FAILED, `首帧图片上传失败: ${error.message}`);\n        }\n      }\n    }\n  } else {\n    logger.info(`未提供图片文件或URL，将进行纯文本视频生成`);\n  }\n\n  // 如果有图片上传（无论来源），构建对象\n  if (uploadIDs.length > 0) {\n    logger.info(`图片上传完成，共成功 ${uploadIDs.length} 张`);\n    // 构建首帧图片对象\n    if (uploadIDs[0]) {\n      first_frame_image = {\n        format: \"\",\n        height: 0,\n        id: util.uuid(),\n        image_uri: uploadIDs[0],\n        name: \"\",\n        platform_type: 1,\n        source_from: \"upload\",\n        type: \"image\",\n        uri: uploadIDs[0],\n        width: 0,\n      };\n      logger.info(`设置首帧图片: ${uploadIDs[0]}`);\n    }\n\n    // 构建尾帧图片对象\n    if (uploadIDs[1]) {\n      end_frame_image = {\n        format: \"\",\n        height: 0,\n        id: util.uuid(),\n        image_uri: uploadIDs[1],\n        name: \"\",\n        platform_type: 1,\n        source_from: \"upload\",\n        type: \"image\",\n        uri: uploadIDs[1],\n        width: 0,\n      };\n      logger.info(`设置尾帧图片: ${uploadIDs[1]}`);\n    }\n  }\n\n\n  const componentId = util.uuid();\n  const originSubmitId = util.uuid();\n\n  // 根据官方API的实际行为，所有模式都使用 \"first_last_frames\"\n  // 通过 first_frame_image 和 end_frame_image 是否为 undefined 来区分模式\n  const functionMode = \"first_last_frames\";\n\n  const metricsExtra = JSON.stringify({\n    \"promptSource\": \"custom\",\n    \"isDefaultSeed\": 1,\n    \"originSubmitId\": originSubmitId,\n    \"isRegenerate\": false,\n    \"enterFrom\": \"click\",\n    \"functionMode\": functionMode\n  });\n\n  // 当有图片输入时，ratio参数会被图片的实际比例覆盖\n  const hasImageInput = uploadIDs.length > 0;\n  if (hasImageInput && ratio !== \"1:1\") {\n    logger.warn(`图生视频模式下，ratio参数将被忽略（由输入图片的实际比例决定），但resolution参数仍然有效`);\n  }\n\n  logger.info(`视频生成模式: ${uploadIDs.length}张图片 (首帧: ${!!first_frame_image}, 尾帧: ${!!end_frame_image}), resolution: ${resolution}`);\n  \n  // 构建请求参数\n  const { aigc_data } = await request(\n    \"post\",\n    \"/mweb/v1/aigc_draft/generate\",\n    refreshToken,\n    {\n      params: {\n        aigc_features: \"app_lip_sync\",\n        web_version: \"7.5.0\",\n        da_version: DRAFT_VERSION,\n      },\n      data: {\n        \"extend\": {\n          \"root_model\": end_frame_image ? VIDEO_MODEL_MAP['jimeng-video-3.0'] : model,\n          \"m_video_commerce_info\": {\n            benefit_type: \"basic_video_operation_vgfm_v_three\",\n            resource_id: \"generate_video\",\n            resource_id_type: \"str\",\n            resource_sub_type: \"aigc\"\n          },\n          \"m_video_commerce_info_list\": [{\n            benefit_type: \"basic_video_operation_vgfm_v_three\",\n            resource_id: \"generate_video\",\n            resource_id_type: \"str\",\n            resource_sub_type: \"aigc\"\n          }]\n        },\n        \"submit_id\": util.uuid(),\n        \"metrics_extra\": metricsExtra,\n        \"draft_content\": JSON.stringify({\n          \"type\": \"draft\",\n          \"id\": util.uuid(),\n          \"min_version\": \"3.0.5\",\n          \"min_features\": [],\n          \"is_from_tsn\": true,\n          \"version\": DRAFT_VERSION,\n          \"main_component_id\": componentId,\n          \"component_list\": [{\n            \"type\": \"video_base_component\",\n            \"id\": componentId,\n            \"min_version\": \"1.0.0\",\n            \"aigc_mode\": \"workbench\",\n            \"metadata\": {\n              \"type\": \"\",\n              \"id\": util.uuid(),\n              \"created_platform\": 3,\n              \"created_platform_version\": \"\",\n              \"created_time_in_ms\": Date.now().toString(),\n              \"created_did\": \"\"\n            },\n            \"generate_type\": \"gen_video\",\n            \"abilities\": {\n              \"type\": \"\",\n              \"id\": util.uuid(),\n              \"gen_video\": {\n                \"id\": util.uuid(),\n                \"type\": \"\",\n                \"text_to_video_params\": {\n                  \"type\": \"\",\n                  \"id\": util.uuid(),\n                  \"video_gen_inputs\": [{\n                    \"type\": \"\",\n                    \"id\": util.uuid(),\n                    \"min_version\": \"3.0.5\",\n                    \"prompt\": prompt,\n                    \"video_mode\": 2,\n                    \"fps\": 24,\n                    \"duration_ms\": durationMs,\n                    \"resolution\": resolution,\n                    \"first_frame_image\": first_frame_image,\n                    \"end_frame_image\": end_frame_image,\n                    \"idip_meta_list\": []\n                  }],\n                  \"video_aspect_ratio\": ratio,\n                  \"seed\": Math.floor(Math.random() * 100000000) + 2500000000,\n                  \"model_req_key\": model,\n                  \"priority\": 0\n                },\n                \"video_task_extra\": metricsExtra,\n              }\n            },\n            \"process_type\": 1\n          }],\n        }),\n        http_common_info: {\n          aid: getAssistantId(regionInfo)\n        },\n      },\n    }\n  );\n\n  const historyId = aigc_data.history_record_id;\n  if (!historyId)\n    throw new APIException(EX.API_IMAGE_GENERATION_FAILED, \"记录ID不存在\");\n\n  logger.info(`视频生成任务已提交，history_id: ${historyId}，等待生成完成...`);\n\n  // 首次查询前等待，让服务器有时间处理请求\n  await new Promise((resolve) => setTimeout(resolve, 5000));\n\n  // 使用 SmartPoller 进行智能轮询\n  const maxPollCount = 900; // 增加轮询次数，支持更长的生成时间\n  let pollAttempts = 0;\n\n  const poller = new SmartPoller({\n    maxPollCount,\n    pollInterval: 2000, // 2秒基础间隔\n    expectedItemCount: 1,\n    type: 'video',\n    timeoutSeconds: 1200 // 20分钟超时\n  });\n\n  const { result: pollingResult, data: finalHistoryData } = await poller.poll(async () => {\n    pollAttempts++;\n\n    // 使用标准API请求方式\n    const result = await request(\"post\", \"/mweb/v1/get_history_by_ids\", refreshToken, {\n      data: {\n        history_ids: [historyId],\n      },\n    });\n\n    // 尝试直接从响应中提取视频URL\n    const responseStr = JSON.stringify(result);\n    const videoUrlMatch = responseStr.match(/https:\\/\\/v[0-9]+-artist\\.vlabvod\\.com\\/[^\"\\s]+/);\n    if (videoUrlMatch && videoUrlMatch[0]) {\n      logger.info(`从API响应中直接提取到视频URL: ${videoUrlMatch[0]}`);\n      // 构造成功状态并返回\n      return {\n        status: {\n          status: 10,\n          itemCount: 1,\n          historyId\n        } as PollingStatus,\n        data: {\n          status: 10,\n          item_list: [{\n            video: {\n              transcoded_video: {\n                origin: {\n                  video_url: videoUrlMatch[0]\n                }\n              }\n            }\n          }]\n        }\n      };\n    }\n\n    // 检查响应中是否有该 history_id 的数据\n    if (!result[historyId]) {\n      logger.warn(`API未返回历史记录，historyId: ${historyId}`);\n      throw new APIException(EX.API_IMAGE_GENERATION_FAILED, \"记录不存在\");\n    }\n\n    const historyData = result[historyId];\n\n    const currentStatus = historyData.status;\n    const currentFailCode = historyData.fail_code;\n    const currentItemList = historyData.item_list || [];\n    const finishTime = historyData.task?.finish_time || 0;\n\n    // 记录详细信息\n    if (currentItemList.length > 0) {\n      const tempVideoUrl = currentItemList[0]?.video?.transcoded_video?.origin?.video_url ||\n                          currentItemList[0]?.video?.play_url ||\n                          currentItemList[0]?.video?.download_url ||\n                          currentItemList[0]?.video?.url;\n      if (tempVideoUrl) {\n        logger.info(`检测到视频URL: ${tempVideoUrl}`);\n      }\n    }\n\n    return {\n      status: {\n        status: currentStatus,\n        failCode: currentFailCode,\n        itemCount: currentItemList.length,\n        finishTime,\n        historyId\n      } as PollingStatus,\n      data: historyData\n    };\n  }, historyId);\n\n  const item_list = finalHistoryData.item_list || [];\n\n  // 提取视频URL\n  let videoUrl = item_list?.[0] ? extractVideoUrl(item_list[0]) : null;\n\n  // 如果无法获取视频URL，抛出异常\n  if (!videoUrl) {\n    logger.error(`未能获取视频URL，item_list: ${JSON.stringify(item_list)}`);\n    throw new APIException(EX.API_IMAGE_GENERATION_FAILED, \"未能获取视频URL，请稍后查看\");\n  }\n\n  logger.info(`视频生成成功，URL: ${videoUrl}，总耗时: ${pollingResult.elapsedTime}秒`);\n  return videoUrl;\n}","import logger from \"@/lib/logger.ts\";\nimport { STATUS_CODE_MAP, POLLING_CONFIG } from \"@/api/consts/common.ts\";\nimport { handlePollingTimeout, handleGenerationFailure } from \"@/lib/error-handler.ts\";\n\n/**\n * 轮询状态接口\n */\nexport interface PollingStatus {\n  status: number;\n  failCode?: string;\n  itemCount: number;\n  finishTime?: number;\n  historyId?: string;\n}\n\n/**\n * 轮询配置接口\n */\nexport interface PollingOptions {\n  maxPollCount?: number;\n  pollInterval?: number;\n  stableRounds?: number;\n  timeoutSeconds?: number;\n  expectedItemCount?: number;\n  type?: 'image' | 'video';\n}\n\n/**\n * 轮询结果接口\n */\nexport interface PollingResult {\n  status: number;\n  failCode?: string;\n  itemCount: number;\n  elapsedTime: number;\n  pollCount: number;\n  exitReason: string;\n}\n\n/**\n * 智能轮询器\n * 根据状态码智能调整轮询间隔，优化性能\n */\nexport class SmartPoller {\n  private pollCount = 0;\n  private startTime = Date.now();\n  private lastItemCount = 0;\n  private stableItemCountRounds = 0;\n  private options: Required<PollingOptions>;\n  \n  constructor(options: PollingOptions = {}) {\n    this.options = {\n      maxPollCount: options.maxPollCount ?? POLLING_CONFIG.MAX_POLL_COUNT,\n      pollInterval: options.pollInterval ?? POLLING_CONFIG.POLL_INTERVAL,\n      stableRounds: options.stableRounds ?? POLLING_CONFIG.STABLE_ROUNDS,\n      timeoutSeconds: options.timeoutSeconds ?? POLLING_CONFIG.TIMEOUT_SECONDS,\n      expectedItemCount: options.expectedItemCount ?? 4,\n      type: options.type ?? 'image'\n    };\n  }\n  \n  /**\n   * 获取状态名称\n   */\n  private getStatusName(status: number): string {\n    return STATUS_CODE_MAP[status] || `UNKNOWN(${status})`;\n  }\n  \n  /**\n   * 根据状态码计算智能轮询间隔\n   */\n  private getSmartInterval(status: number, itemCount: number): number {\n    const baseInterval = this.options.pollInterval;\n    \n    // 根据状态码调整间隔\n    switch (status) {\n      case 20: // PROCESSING - 处理中，使用标准间隔\n        return baseInterval;\n      \n      case 42: // POST_PROCESSING - 后处理中，稍微增加间隔\n        return baseInterval * 1.2;\n      \n      case 45: // FINALIZING - 最终处理中，可能需要更多时间\n        return baseInterval * 1.5;\n      \n      case 50: // COMPLETED - 已完成，快速检查\n        return baseInterval * 0.5;\n      \n      case 10: // SUCCESS - 成功，立即返回\n        return 0;\n      \n      case 30: // FAILED - 失败，立即返回\n        return 0;\n      \n      default: // 未知状态，使用标准间隔\n        return baseInterval;\n    }\n  }\n  \n  /**\n   * 检查是否应该退出轮询\n   */\n  private shouldExitPolling(pollingStatus: PollingStatus): { shouldExit: boolean; reason: string } {\n    const { status, itemCount } = pollingStatus;\n    const elapsedTime = Math.round((Date.now() - this.startTime) / 1000);\n    \n    // 更新图片数量稳定性检测\n    if (itemCount === this.lastItemCount) {\n      this.stableItemCountRounds++;\n    } else {\n      this.stableItemCountRounds = 0;\n      this.lastItemCount = itemCount;\n    }\n    \n    // 1. 任务成功完成\n    if (status === 10 || status === 50) {\n      return { shouldExit: true, reason: '任务成功完成' };\n    }\n    \n    // 2. 任务失败\n    if (status === 30) {\n      return { shouldExit: true, reason: '任务失败' };\n    }\n    \n    // 3. 已获得期望数量的结果（但必须状态已完成）\n    if (itemCount >= this.options.expectedItemCount && (status === 10 || status === 50)) {\n      return { shouldExit: true, reason: `已获得完整结果集(${itemCount}/${this.options.expectedItemCount})` };\n    }\n    \n    // 4. 图片数量已稳定\n    if (this.stableItemCountRounds >= this.options.stableRounds && itemCount > 0) {\n      return { shouldExit: true, reason: `结果数量稳定(${this.stableItemCountRounds}轮)` };\n    }\n    \n    // 5. 轮询次数超限\n    if (this.pollCount >= this.options.maxPollCount) {\n      return { shouldExit: true, reason: '轮询次数超限' };\n    }\n    \n    // 6. 时间超限但有结果\n    if (elapsedTime >= this.options.timeoutSeconds && itemCount > 0) {\n      return { shouldExit: true, reason: '时间超限但已有结果' };\n    }\n    \n    return { shouldExit: false, reason: '' };\n  }\n  \n  /**\n   * 执行单次轮询检查\n   */\n  async poll<T>(\n    pollFunction: () => Promise<{ status: PollingStatus; data: T }>,\n    historyId?: string\n  ): Promise<{ result: PollingResult; data: T }> {\n    logger.info(`开始智能轮询: historyId=${historyId || 'N/A'}, 最大轮询次数=${this.options.maxPollCount}, 期望结果数=${this.options.expectedItemCount}`);\n    \n    let lastData: T;\n    let lastStatus: PollingStatus = { status: 20, itemCount: 0 };\n    \n    while (true) {\n      this.pollCount++;\n      const elapsedTime = Math.round((Date.now() - this.startTime) / 1000);\n      \n      try {\n        // 执行轮询函数\n        const { status, data } = await pollFunction();\n        lastStatus = status;\n        lastData = data;\n        \n        // 详细日志\n        logger.info(`轮询 ${this.pollCount}/${this.options.maxPollCount}: status=${status.status}(${this.getStatusName(status.status)}), failCode=${status.failCode || 'none'}, items=${status.itemCount}, elapsed=${elapsedTime}s, finish_time=${status.finishTime || 0}, stable=${this.stableItemCountRounds}/${this.options.stableRounds}`);\n        \n        // 如果有结果生成，记录详细信息\n        if (status.itemCount > 0) {\n          logger.info(`检测到${this.options.type === 'image' ? '图片' : '视频'}生成: 数量=${status.itemCount}, 状态=${this.getStatusName(status.status)}`);\n        }\n        \n        // 检查是否应该退出\n        const { shouldExit, reason } = this.shouldExitPolling(status);\n        \n        if (shouldExit) {\n          logger.info(`退出轮询: ${reason}, 最终${this.options.type === 'image' ? '图片' : '视频'}数量=${status.itemCount}`);\n\n          // 处理失败情况 (如果有部分结果，handleGenerationFailure 会返回 false 而不抛出异常)\n          if (status.status === 30) {\n            handleGenerationFailure(status.status, status.failCode, historyId, this.options.type, status.itemCount);\n          }\n\n          // 处理超时情况\n          if (reason === '轮询次数超限' || reason === '时间超限但已有结果') {\n            handlePollingTimeout(\n              this.pollCount,\n              this.options.maxPollCount,\n              elapsedTime,\n              status.status,\n              status.itemCount,\n              historyId\n            );\n          }\n\n          break;\n        }\n        \n        // 未知状态码警告\n        if (![20, 42, 45, 10, 30, 50].includes(status.status)) {\n          logger.warn(`检测到未知状态码 ${status.status}(${this.getStatusName(status.status)})，继续轮询等待生成...`);\n        }\n        \n        // 进度日志（每30秒输出一次）\n        if (this.pollCount % 30 === 0) {\n          logger.info(`${this.options.type === 'image' ? '图像' : '视频'}生成进度: 第 ${this.pollCount} 次轮询，状态: ${this.getStatusName(status.status)}，已等待 ${elapsedTime} 秒...`);\n        }\n        \n        // 计算下次轮询间隔\n        const nextInterval = this.getSmartInterval(status.status, status.itemCount);\n        if (nextInterval > 0) {\n          await new Promise(resolve => setTimeout(resolve, nextInterval));\n        }\n        \n      } catch (error) {\n        logger.error(`轮询过程中发生错误: ${error.message}`);\n        throw error;\n      }\n    }\n    \n    const finalElapsedTime = Math.round((Date.now() - this.startTime) / 1000);\n    \n    const result: PollingResult = {\n      status: lastStatus.status,\n      failCode: lastStatus.failCode,\n      itemCount: lastStatus.itemCount,\n      elapsedTime: finalElapsedTime,\n      pollCount: this.pollCount,\n      exitReason: this.shouldExitPolling(lastStatus).reason\n    };\n    \n    logger.info(`${this.options.type === 'image' ? '图像' : '视频'}生成完成: 成功生成 ${lastStatus.itemCount} 个结果，总耗时 ${finalElapsedTime} 秒，最终状态: ${this.getStatusName(lastStatus.status)}`);\n    \n    return { result, data: lastData! };\n  }\n}\n","import crypto from \"crypto\";\nimport { RegionInfo, request } from \"@/api/controllers/core.ts\";\nimport { RegionUtils } from \"@/lib/region-utils.ts\";\nimport { createSignature } from \"@/lib/aws-signature.ts\";\nimport logger from \"@/lib/logger.ts\";\nimport util from \"@/lib/util.ts\";\n\n/**\n * 统一的图片上传模块\n * 整合了images.ts和videos.ts中重复的上传逻辑\n */\n\n/**\n * 上传图片Buffer到ImageX\n * @param imageBuffer 图片数据\n * @param refreshToken 刷新令牌\n * @param regionInfo 区域信息\n * @returns 图片URI\n */\nexport async function uploadImageBuffer(\n  imageBuffer: ArrayBuffer | Buffer,\n  refreshToken: string,\n  regionInfo: RegionInfo\n): Promise<string> {\n  try {\n    logger.info(`开始上传图片Buffer... (isInternational: ${regionInfo.isInternational})`);\n\n    // 第一步：获取上传令牌\n    const tokenResult = await request(\"post\", \"/mweb/v1/get_upload_token\", refreshToken, {\n      data: {\n        scene: 2, // AIGC 图片上传场景\n      },\n    });\n\n    const { access_key_id, secret_access_key, session_token } = tokenResult;\n    const service_id = regionInfo.isInternational ? tokenResult.space_name : tokenResult.service_id;\n\n    if (!access_key_id || !secret_access_key || !session_token) {\n      throw new Error(\"获取上传令牌失败\");\n    }\n\n    const actualServiceId = RegionUtils.getServiceId(regionInfo, service_id);\n    logger.info(`获取上传令牌成功: service_id=${actualServiceId}`);\n\n    // 准备文件信息\n    const fileSize = imageBuffer.byteLength;\n    const crc32 = util.calculateCRC32(imageBuffer);\n    logger.info(`图片Buffer: 大小=${fileSize}字节, CRC32=${crc32}`);\n\n    // 第二步：申请图片上传权限\n    const now = new Date();\n    const timestamp = now.toISOString().replace(/[:\\-]/g, '').replace(/\\.\\d{3}Z$/, 'Z');\n    const randomStr = Math.random().toString(36).substring(2, 12);\n\n    const applyUrlHost = RegionUtils.getImageXUrl(regionInfo);\n    const applyUrl = `${applyUrlHost}/?Action=ApplyImageUpload&Version=2018-08-01&ServiceId=${actualServiceId}&FileSize=${fileSize}&s=${randomStr}${regionInfo.isInternational ? '&device_platform=web' : ''}`;\n\n    const awsRegion = RegionUtils.getAWSRegion(regionInfo);\n    const origin = RegionUtils.getOrigin(regionInfo);\n\n    const requestHeaders = {\n      'x-amz-date': timestamp,\n      'x-amz-security-token': session_token\n    };\n\n    const authorization = createSignature('GET', applyUrl, requestHeaders, access_key_id, secret_access_key, session_token, '', awsRegion);\n\n    logger.info(`申请上传权限: ${applyUrl}`);\n\n    let applyResponse;\n    try {\n      applyResponse = await fetch(applyUrl, {\n        method: 'GET',\n        headers: {\n          'accept': '*/*',\n          'accept-language': 'zh-CN,zh;q=0.9',\n          'authorization': authorization,\n          'origin': origin,\n          'referer': `${origin}/ai-tool/generate`,\n          'sec-ch-ua': '\"Not A(Brand\";v=\"8\", \"Chromium\";v=\"132\", \"Google Chrome\";v=\"132\"',\n          'sec-ch-ua-mobile': '?0',\n          'sec-ch-ua-platform': '\"Windows\"',\n          'sec-fetch-dest': 'empty',\n          'sec-fetch-mode': 'cors',\n          'sec-fetch-site': 'cross-site',\n          'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36',\n          'x-amz-date': timestamp,\n          'x-amz-security-token': session_token,\n        },\n      });\n    } catch (fetchError: any) {\n      logger.error(`Fetch请求失败，目标URL: ${applyUrl}`);\n      logger.error(`错误详情: ${fetchError.message}`);\n      throw new Error(`网络请求失败 (${applyUrlHost}): ${fetchError.message}. 请检查: 1) 网络连接是否正常 2) 是否需要配置代理 3) DNS是否能解析该域名`);\n    }\n\n    if (!applyResponse.ok) {\n      const errorText = await applyResponse.text();\n      throw new Error(`申请上传权限失败: ${applyResponse.status} - ${errorText}`);\n    }\n\n    const applyResult = await applyResponse.json();\n\n    if (applyResult?.ResponseMetadata?.Error) {\n      throw new Error(`申请上传权限失败: ${JSON.stringify(applyResult.ResponseMetadata.Error)}`);\n    }\n\n    logger.info(`申请上传权限成功`);\n\n    // 解析上传信息\n    const uploadAddress = applyResult?.Result?.UploadAddress;\n    if (!uploadAddress || !uploadAddress.StoreInfos || !uploadAddress.UploadHosts) {\n      throw new Error(`获取上传地址失败: ${JSON.stringify(applyResult)}`);\n    }\n\n    const storeInfo = uploadAddress.StoreInfos[0];\n    const uploadHost = uploadAddress.UploadHosts[0];\n    const auth = storeInfo.Auth;\n    const uploadUrl = `https://${uploadHost}/upload/v1/${storeInfo.StoreUri}`;\n\n    logger.info(`准备上传图片: uploadUrl=${uploadUrl}`);\n\n    // 第三步：上传图片文件\n    let uploadResponse;\n    try {\n      uploadResponse = await fetch(uploadUrl, {\n        method: 'POST',\n        headers: {\n          'Accept': '*/*',\n          'Accept-Language': 'zh-CN,zh;q=0.9',\n          'Authorization': auth,\n          'Connection': 'keep-alive',\n          'Content-CRC32': crc32,\n          'Content-Disposition': 'attachment; filename=\"undefined\"',\n          'Content-Type': 'application/octet-stream',\n          'Origin': origin,\n          'Referer': RegionUtils.getRefererPath(regionInfo),\n          'Sec-Fetch-Dest': 'empty',\n          'Sec-Fetch-Mode': 'cors',\n          'Sec-Fetch-Site': 'cross-site',\n          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36',\n        },\n        body: imageBuffer,\n      });\n    } catch (fetchError: any) {\n      logger.error(`图片文件上传fetch请求失败，目标URL: ${uploadUrl}`);\n      logger.error(`错误详情: ${fetchError.message}`);\n      throw new Error(`图片上传网络请求失败 (${uploadHost}): ${fetchError.message}. 请检查网络连接`);\n    }\n\n    if (!uploadResponse.ok) {\n      const errorText = await uploadResponse.text();\n      throw new Error(`图片上传失败: ${uploadResponse.status} - ${errorText}`);\n    }\n\n    logger.info(`图片文件上传成功`);\n\n    // 第四步：提交上传\n    const commitUrl = `${applyUrlHost}/?Action=CommitImageUpload&Version=2018-08-01&ServiceId=${actualServiceId}`;\n    const commitTimestamp = new Date().toISOString().replace(/[:\\-]/g, '').replace(/\\.\\d{3}Z$/, 'Z');\n    const commitPayload = JSON.stringify({\n      SessionKey: uploadAddress.SessionKey\n    });\n\n    const payloadHash = crypto.createHash('sha256').update(commitPayload, 'utf8').digest('hex');\n\n    const commitRequestHeaders = {\n      'x-amz-date': commitTimestamp,\n      'x-amz-security-token': session_token,\n      'x-amz-content-sha256': payloadHash\n    };\n\n    const commitAuthorization = createSignature('POST', commitUrl, commitRequestHeaders, access_key_id, secret_access_key, session_token, commitPayload, awsRegion);\n\n    let commitResponse;\n    try {\n      commitResponse = await fetch(commitUrl, {\n        method: 'POST',\n        headers: {\n          'accept': '*/*',\n          'accept-language': 'zh-CN,zh;q=0.9',\n          'authorization': commitAuthorization,\n          'content-type': 'application/json',\n          'origin': origin,\n          'referer': RegionUtils.getRefererPath(regionInfo),\n          'sec-ch-ua': '\"Not A(Brand\";v=\"8\", \"Chromium\";v=\"132\", \"Google Chrome\";v=\"132\"',\n          'sec-ch-ua-mobile': '?0',\n          'sec-ch-ua-platform': '\"Windows\"',\n          'sec-fetch-dest': 'empty',\n          'sec-fetch-mode': 'cors',\n          'sec-fetch-site': 'cross-site',\n          'user-agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/132.0.0.0 Safari/537.36',\n          'x-amz-date': commitTimestamp,\n          'x-amz-security-token': session_token,\n          'x-amz-content-sha256': payloadHash,\n        },\n        body: commitPayload,\n      });\n    } catch (fetchError: any) {\n      logger.error(`提交上传fetch请求失败，目标URL: ${commitUrl}`);\n      logger.error(`错误详情: ${fetchError.message}`);\n      throw new Error(`提交上传网络请求失败 (${applyUrlHost}): ${fetchError.message}. 请检查网络连接`);\n    }\n\n    if (!commitResponse.ok) {\n      const errorText = await commitResponse.text();\n      throw new Error(`提交上传失败: ${commitResponse.status} - ${errorText}`);\n    }\n\n    const commitResult = await commitResponse.json();\n\n    if (commitResult?.ResponseMetadata?.Error) {\n      throw new Error(`提交上传失败: ${JSON.stringify(commitResult.ResponseMetadata.Error)}`);\n    }\n\n    if (!commitResult?.Result?.Results || commitResult.Result.Results.length === 0) {\n      throw new Error(`提交上传响应缺少结果: ${JSON.stringify(commitResult)}`);\n    }\n\n    const uploadResult = commitResult.Result.Results[0];\n    if (uploadResult.UriStatus !== 2000) {\n      throw new Error(`图片上传状态异常: UriStatus=${uploadResult.UriStatus}`);\n    }\n\n    const fullImageUri = uploadResult.Uri;\n    logger.info(`图片上传完成: ${fullImageUri}`);\n\n    return fullImageUri;\n  } catch (error: any) {\n    logger.error(`图片Buffer上传失败: ${error.message}`);\n    throw error;\n  }\n}\n\n/**\n * 从URL下载并上传图片\n * @param imageUrl 图片URL\n * @param refreshToken 刷新令牌\n * @param regionInfo 区域信息\n * @returns 图片URI\n */\nexport async function uploadImageFromUrl(\n  imageUrl: string,\n  refreshToken: string,\n  regionInfo: RegionInfo\n): Promise<string> {\n  try {\n    logger.info(`开始从URL下载并上传图片: ${imageUrl}`);\n\n    const imageResponse = await fetch(imageUrl);\n    if (!imageResponse.ok) {\n      throw new Error(`下载图片失败: ${imageResponse.status}`);\n    }\n\n    const imageBuffer = await imageResponse.arrayBuffer();\n    return await uploadImageBuffer(imageBuffer, refreshToken, regionInfo);\n  } catch (error: any) {\n    logger.error(`从URL上传图片失败: ${error.message}`);\n    throw error;\n  }\n}\n","import { RegionInfo } from \"@/api/controllers/core.ts\";\nimport { BASE_URL_DREAMINA_US, BASE_URL_DREAMINA_HK, BASE_URL_IMAGEX_US, BASE_URL_IMAGEX_HK } from \"@/api/consts/dreamina.ts\";\n\n/**\n * 区域配置工具类\n * 统一管理不同区域的配置信息\n */\nexport class RegionUtils {\n  /**\n   * 获取ServiceId\n   */\n  static getServiceId(regionInfo: RegionInfo, providedServiceId?: string): string {\n    if (providedServiceId) {\n      return providedServiceId;\n    }\n\n    // US/HK/JP/SG 使用相同的 service_id\n    if (regionInfo.isUS || regionInfo.isHK || regionInfo.isJP || regionInfo.isSG) {\n      return \"wopfjsm1ax\";\n    }\n\n    // CN 使用默认的 service_id\n    return \"tb4s082cfz\";\n  }\n\n  /**\n   * 获取ImageX URL\n   */\n  static getImageXUrl(regionInfo: RegionInfo): string {\n    if (regionInfo.isUS) {\n      return BASE_URL_IMAGEX_US;\n    }\n\n    if (regionInfo.isHK || regionInfo.isJP || regionInfo.isSG) {\n      return BASE_URL_IMAGEX_HK;\n    }\n\n    return 'https://imagex.bytedanceapi.com';\n  }\n\n  /**\n   * 获取Origin\n   */\n  static getOrigin(regionInfo: RegionInfo): string {\n    if (regionInfo.isUS) {\n      return new URL(BASE_URL_DREAMINA_US).origin;\n    }\n\n    if (regionInfo.isHK || regionInfo.isJP || regionInfo.isSG) {\n      return new URL(BASE_URL_DREAMINA_HK).origin;\n    }\n\n    return 'https://jimeng.jianying.com';\n  }\n\n  /**\n   * 获取AWS区域\n   */\n  static getAWSRegion(regionInfo: RegionInfo): string {\n    if (regionInfo.isUS) {\n      return 'us-east-1';\n    }\n\n    if (regionInfo.isHK || regionInfo.isJP || regionInfo.isSG) {\n      return 'ap-southeast-1';\n    }\n\n    return 'cn-north-1';\n  }\n\n  /**\n   * 获取Referer路径\n   */\n  static getRefererPath(regionInfo: RegionInfo, path: string = '/ai-tool/generate'): string {\n    const origin = this.getOrigin(regionInfo);\n    return `${origin}${path}`;\n  }\n}\n","import logger from \"@/lib/logger.ts\";\n\n/**\n * 图片URL提取工具\n * 统一从不同格式的响应中提取图片URL\n */\n\n/**\n * 从API响应项中提取图片URL\n * @param item API响应中的单个项目\n * @param index 项目索引（用于日志）\n * @returns 图片URL或null\n */\nexport function extractImageUrl(item: any, index?: number): string | null {\n  const logPrefix = index !== undefined ? `图片 ${index + 1}` : '图片';\n\n  // 只提取 large_images\n  if (item?.image?.large_images?.[0]?.image_url) {\n    let imageUrl = item.image.large_images[0].image_url;\n    // 将URL中的 \\u0026 转换为 &\n    imageUrl = imageUrl.replace(/\\\\u0026/g, '&');\n    logger.debug(`${logPrefix}: 使用 large_images URL`);\n    return imageUrl;\n  }\n\n  // 无法提取URL，记录警告\n  logger.warn(`${logPrefix}: 无法提取URL，缺少 image.large_images[0].image_url 字段。item结构: ${JSON.stringify(item, null, 2)}`);\n  return null;\n}\n\n/**\n * 从项目列表中批量提取图片URLs\n * @param itemList 项目列表\n * @returns 图片URL数组\n */\nexport function extractImageUrls(itemList: any[]): string[] {\n  return itemList\n    .map((item, index) => extractImageUrl(item, index))\n    .filter((url): url is string => url !== null);\n}\n\n/**\n * 从视频响应项中提取视频URL\n * @param item 视频响应项\n * @returns 视频URL或null\n */\nexport function extractVideoUrl(item: any): string | null {\n  // 优先尝试 transcoded_video.origin.video_url\n  if (item?.video?.transcoded_video?.origin?.video_url) {\n    return item.video.transcoded_video.origin.video_url;\n  }\n  // 尝试 play_url\n  if (item?.video?.play_url) {\n    return item.video.play_url;\n  }\n  // 尝试 download_url\n  if (item?.video?.download_url) {\n    return item.video.download_url;\n  }\n  // 尝试 url\n  if (item?.video?.url) {\n    return item.video.url;\n  }\n\n  return null;\n}\n","export default {\n  prefix: '/ping',\n  get: {\n    '': async () => \"pong\"\n  }\n}","import _ from 'lodash';\n\nimport Request from '@/lib/request/Request.ts';\nimport Response from '@/lib/response/Response.ts';\nimport { getTokenLiveStatus, getCredit, tokenSplit } from '@/api/controllers/core.ts';\nimport logger from '@/lib/logger.ts';\n\nexport default {\n\n    prefix: '/token',\n\n    post: {\n\n        '/check': async (request: Request) => {\n            request\n                .validate('body.token', _.isString)\n            const live = await getTokenLiveStatus(request.body.token);\n            return {\n                live\n            }\n        },\n\n        '/points': async (request: Request) => {\n            request\n                .validate('headers.authorization', _.isString)\n            // refresh_token切分\n            const tokens = tokenSplit(request.headers.authorization);\n            const points = await Promise.all(tokens.map(async (token) => {\n                return {\n                    token,\n                    points: await getCredit(token)\n                }\n            }))\n            return points;\n        }\n\n    }\n\n}","import _ from 'lodash';\n\nexport default {\n\n    prefix: '/v1',\n\n    get: {\n        '/models': async () => {\n            return {\n                \"data\": [\n                    {\n                        \"id\": \"jimeng\",\n                        \"object\": \"model\",\n                        \"owned_by\": \"jimeng-api\"\n                    },\n                    {\n                        \"id\": \"jimeng-video-3.0\",\n                        \"object\": \"model\",\n                        \"owned_by\": \"jimeng-api\",\n                        \"description\": \"即梦AI视频生成模型 3.0 版本\"\n                    },\n                    {\n                        \"id\": \"jimeng-video-3.0-pro\",\n                        \"object\": \"model\",\n                        \"owned_by\": \"jimeng-api\",\n                        \"description\": \"即梦AI视频生成模型 3.0 专业版\"\n                    },\n                    {\n                        \"id\": \"jimeng-video-2.0\",\n                        \"object\": \"model\",\n                        \"owned_by\": \"jimeng-api\",\n                        \"description\": \"即梦AI视频生成模型 2.0 版本\"\n                    },\n                    {\n                        \"id\": \"jimeng-video-2.0-pro\",\n                        \"object\": \"model\",\n                        \"owned_by\": \"jimeng-api\",\n                        \"description\": \"即梦AI视频生成模型 2.0 专业版\"\n                    }\n                ]\n            };\n        }\n\n    }\n}","import _ from 'lodash';\n\nimport Request from '@/lib/request/Request.ts';\nimport Response from '@/lib/response/Response.ts';\nimport { tokenSplit } from '@/api/controllers/core.ts';\nimport { generateVideo, DEFAULT_MODEL } from '@/api/controllers/videos.ts';\nimport util from '@/lib/util.ts';\n\nexport default {\n\n    prefix: '/v1/videos',\n\n    post: {\n\n        '/generations': async (request: Request) => {\n            const contentType = request.headers['content-type'] || '';\n            const isMultiPart = contentType.startsWith('multipart/form-data');\n\n            request\n                .validate('body.model', v => _.isUndefined(v) || _.isString(v))\n                .validate('body.prompt', _.isString)\n                .validate('body.ratio', v => _.isUndefined(v) || _.isString(v))\n                .validate('body.resolution', v => _.isUndefined(v) || _.isString(v))\n                .validate('body.duration', v => {\n                    if (_.isUndefined(v)) return true;\n                    // 对于 multipart/form-data，允许字符串类型的数字\n                    if (isMultiPart && typeof v === 'string') {\n                        const num = parseInt(v);\n                        return num === 5 || num === 10;\n                    }\n                    // 对于 JSON，要求数字类型\n                    return _.isFinite(v) && (v === 5 || v === 10);\n                })\n                .validate('body.file_paths', v => _.isUndefined(v) || _.isArray(v))\n                .validate('body.filePaths', v => _.isUndefined(v) || _.isArray(v))\n                .validate('body.response_format', v => _.isUndefined(v) || _.isString(v))\n                .validate('headers.authorization', _.isString);\n\n            // refresh_token切分\n            const tokens = tokenSplit(request.headers.authorization);\n            // 随机挑选一个refresh_token\n            const token = _.sample(tokens);\n\n            const {\n                model = DEFAULT_MODEL,\n                prompt,\n                ratio = \"1:1\",\n                resolution = \"720p\",\n                duration = 5,\n                file_paths = [],\n                filePaths = [],\n                response_format = \"url\"\n            } = request.body;\n\n            // 如果是 multipart/form-data，需要将字符串转换为数字\n            const finalDuration = isMultiPart && typeof duration === 'string'\n                ? parseInt(duration)\n                : duration;\n\n            // 兼容两种参数名格式：file_paths 和 filePaths\n            const finalFilePaths = filePaths.length > 0 ? filePaths : file_paths;\n\n            // 生成视频\n            const videoUrl = await generateVideo(\n                model,\n                prompt,\n                {\n                    ratio,\n                    resolution,\n                    duration: finalDuration,\n                    filePaths: finalFilePaths,\n                    files: request.files, // 传递上传的文件\n                },\n                token\n            );\n\n            // 根据response_format返回不同格式的结果\n            if (response_format === \"b64_json\") {\n                // 获取视频内容并转换为BASE64\n                const videoBase64 = await util.fetchFileBASE64(videoUrl);\n                return {\n                    created: util.unixTimestamp(),\n                    data: [{\n                        b64_json: videoBase64,\n                        revised_prompt: prompt\n                    }]\n                };\n            } else {\n                // 默认返回URL\n                return {\n                    created: util.unixTimestamp(),\n                    data: [{\n                        url: videoUrl,\n                        revised_prompt: prompt\n                    }]\n                };\n            }\n        }\n\n    }\n\n}","import Response from '@/lib/response/Response.ts';\nimport images from \"./images.ts\";\nimport chat from \"./chat.ts\";\nimport ping from \"./ping.ts\";\nimport token from './token.js';\nimport models from './models.ts';\nimport videos from './videos.ts';\n\nexport default [\n    {\n        get: {\n            '/': async () => {\n                return {\n                    service: 'jimeng-api',\n                    status: 'running',\n                    version: '1.6.3',\n                    description: '免费的AI图像和视频生成API服务 - 基于即梦AI的逆向工程实现',\n                    documentation: 'https://github.com/iptag/jimeng-api',\n                    endpoints: {\n                        images: '/v1/images/generations',\n                        compositions: '/v1/images/compositions',\n                        videos: '/v1/videos/generations',\n                        chat: '/v1/chat/completions',\n                        models: '/v1/models',\n                        health: '/ping'\n                    }\n                };\n            }\n        }\n    },\n    images,\n    chat,\n    ping,\n    token,\n    models,\n    videos\n];","\"use strict\";\n\nimport environment from \"@/lib/environment.ts\";\nimport config from \"@/lib/config.ts\";\nimport \"@/lib/initialize.ts\";\nimport server from \"@/lib/server.ts\";\nimport routes from \"@/api/routes/index.ts\";\nimport logger from \"@/lib/logger.ts\";\n\nconst startupTime = performance.now();\n\n(async () => {\n  logger.header();\n\n  logger.info(\"<<<< jimeng-api >>>>\");\n  logger.info(\"Version:\", environment.package.version);\n  logger.info(\"Process id:\", process.pid);\n  logger.info(\"Environment:\", environment.env);\n  logger.info(\"Service name:\", config.service.name);\n\n  server.attachRoutes(routes);\n  await server.listen();\n\n  config.service.bindAddress &&\n    logger.success(\"Service bind address:\", config.service.bindAddress);\n})()\n  .then(() =>\n    logger.success(\n      `Service startup completed (${Math.floor(performance.now() - startupTime)}ms)`\n    )\n  )\n  .catch((err) => console.error(err));\n"],"mappings":"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","names":["cmdArgs","envVars","path","fs","_","path","fs","_","_","path","fs","crc","path","_","fs","path","fs","yaml","_","CONFIG_PATH","path","_","fs","yaml","path","_","fs","dateFormat","fs","path","_","dateFormat","_","_","_","_","_","mime","_","_","_","mime","_","exceptions_default","_","exceptions_default","_","request","response","err","fs","_","crypto","_","mime","axios","axios","_","_","crypto","crc","crypto","_","request","_","fs","_","_","fs","crypto","path","crypto","DEFAULT_MODEL","getModel","fs","uploadImageFromUrl","_","_","request","_","stream","_","request","_","_","request","_","DEFAULT_MODEL"]}